name: "Learning-Based Agent Spawner"

on:
  schedule:
    # Run every 3 hours as specified
    - cron: '0 */3 * * *'
  workflow_dispatch:
    inputs:
      force_spawn:
        description: 'Force spawn even if at capacity'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  spawn-learning-inspired-agent:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check agent capacity
        id: check_capacity
        run: |
          REGISTRY_FILE=".github/agent-system/registry.json"
          
          if [ ! -f "$REGISTRY_FILE" ]; then
            echo "Registry file not found. Creating initial registry..."
            mkdir -p .github/agent-system
            cat > "$REGISTRY_FILE" << 'EOF'
          {
            "version": "2.0.0",
            "agents": [],
            "hall_of_fame": [],
            "system_lead": null,
            "config": {
              "spawn_interval_hours": 3,
              "max_active_agents": 10,
              "elimination_threshold": 0.3,
              "promotion_threshold": 0.85,
              "spawn_mode": "mixed",
              "new_agent_probability": 0.5,
              "metrics_weight": {
                "code_quality": 0.3,
                "issue_resolution": 0.25,
                "pr_success": 0.25,
                "peer_review": 0.2
              }
            },
            "specializations_note": "Specializations are dynamically loaded from .github/agents/ directory",
            "last_spawn": null,
            "last_evaluation": null
          }
          EOF
          fi
          
          # Count active agents
          ACTIVE_COUNT=$(python3 -c "
          import json
          with open('${REGISTRY_FILE}', 'r') as f:
              data = json.load(f)
          active = [a for a in data.get('agents', []) if a.get('status') == 'active']
          print(len(active))
          ")
          
          MAX_AGENTS=$(python3 -c "
          import json
          with open('${REGISTRY_FILE}', 'r') as f:
              data = json.load(f)
          print(data['config']['max_active_agents'])
          ")
          
          echo "active_count=$ACTIVE_COUNT" >> $GITHUB_OUTPUT
          echo "max_agents=$MAX_AGENTS" >> $GITHUB_OUTPUT
          
          FORCE_SPAWN="${{ github.event.inputs.force_spawn }}"
          
          if [ "$FORCE_SPAWN" == "true" ]; then
            echo "can_spawn=true" >> $GITHUB_OUTPUT
            echo "âœ… Force spawn enabled - bypassing capacity check"
          elif [ "$ACTIVE_COUNT" -ge "$MAX_AGENTS" ]; then
            echo "can_spawn=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Maximum agent capacity reached ($ACTIVE_COUNT/$MAX_AGENTS)"
          else
            echo "can_spawn=true" >> $GITHUB_OUTPUT
            echo "âœ… Can spawn new agent ($ACTIVE_COUNT/$MAX_AGENTS)"
          fi

      - name: Generate learning-inspired agent
        id: generate_agent
        if: steps.check_capacity.outputs.can_spawn == 'true'
        run: |
          echo "ğŸ¨ Generating agent inspired by recent learnings..."
          
          # Run the learning-inspired agent generator
          AGENT_JSON=$(python3 tools/learning-inspired-agent-generator.py 2>&1 | tee /tmp/generator.log | tail -n +$(grep -n "^{" /tmp/generator.log | head -1 | cut -d: -f1))
          
          # Check if generation was successful
          SUCCESS=$(echo "$AGENT_JSON" | jq -r '.success' 2>/dev/null || echo "false")
          
          if [ "$SUCCESS" != "true" ]; then
            echo "âŒ Agent generation failed"
            cat /tmp/generator.log
            exit 1
          fi
          
          # Extract agent details
          AGENT_NAME=$(echo "$AGENT_JSON" | jq -r '.agent_name')
          HUMAN_NAME=$(echo "$AGENT_JSON" | jq -r '.human_name')
          EMOJI=$(echo "$AGENT_JSON" | jq -r '.emoji')
          DESCRIPTION=$(echo "$AGENT_JSON" | jq -r '.description')
          PERSONALITY=$(echo "$AGENT_JSON" | jq -r '.personality')
          COMM_STYLE=$(echo "$AGENT_JSON" | jq -r '.communication_style')
          INSPIRED_BY=$(echo "$AGENT_JSON" | jq -r '.inspired_by_topic')
          CATEGORY=$(echo "$AGENT_JSON" | jq -r '.category')
          KEYWORDS=$(echo "$AGENT_JSON" | jq -r '.keywords | join(", ")')
          
          # Generate unique agent ID
          TIMESTAMP=$(date +%s)
          AGENT_ID="agent-$TIMESTAMP"
          
          # Output for next steps
          echo "agent_id=$AGENT_ID" >> $GITHUB_OUTPUT
          echo "agent_name=$AGENT_NAME" >> $GITHUB_OUTPUT
          echo "human_name=$HUMAN_NAME" >> $GITHUB_OUTPUT
          echo "emoji=$EMOJI" >> $GITHUB_OUTPUT
          echo "description=$DESCRIPTION" >> $GITHUB_OUTPUT
          echo "personality=$PERSONALITY" >> $GITHUB_OUTPUT
          echo "communication_style=$COMM_STYLE" >> $GITHUB_OUTPUT
          echo "inspired_by=$INSPIRED_BY" >> $GITHUB_OUTPUT
          echo "category=$CATEGORY" >> $GITHUB_OUTPUT
          echo "keywords=$KEYWORDS" >> $GITHUB_OUTPUT
          
          echo "âœ… Generated agent: $EMOJI $AGENT_NAME"
          echo "   Inspired by: $INSPIRED_BY"
          echo "   Category: $CATEGORY"
          echo "   Keywords: $KEYWORDS"

      - name: Register agent in registry
        if: steps.check_capacity.outputs.can_spawn == 'true'
        run: |
          REGISTRY_FILE=".github/agent-system/registry.json"
          
          python3 << PYTHON_SCRIPT
          import json
          from datetime import datetime
          
          agent_id = "${{ steps.generate_agent.outputs.agent_id }}"
          agent_name = "${{ steps.generate_agent.outputs.agent_name }}"
          human_name = "${{ steps.generate_agent.outputs.human_name }}"
          emoji = "${{ steps.generate_agent.outputs.emoji }}"
          personality = "${{ steps.generate_agent.outputs.personality }}"
          communication_style = "${{ steps.generate_agent.outputs.communication_style }}"
          inspired_by = "${{ steps.generate_agent.outputs.inspired_by }}"
          category = "${{ steps.generate_agent.outputs.category }}"
          
          with open("${REGISTRY_FILE}", 'r') as f:
              registry = json.load(f)
          
          new_agent = {
              "id": agent_id,
              "name": f"{emoji} {human_name}",
              "human_name": human_name,
              "specialization": agent_name,
              "status": "active",
              "spawned_at": datetime.utcnow().isoformat() + "Z",
              "spawn_source": "learning-inspired",
              "inspired_by_topic": inspired_by,
              "category": category,
              "personality": personality,
              "communication_style": communication_style,
              "traits": {
                  "creativity": 75,
                  "adaptability": 80,
                  "learning_driven": 100
              },
              "metrics": {
                  "issues_resolved": 0,
                  "prs_merged": 0,
                  "reviews_given": 0,
                  "code_quality_score": 0.5,
                  "overall_score": 0.0
              },
              "contributions": []
          }
          
          registry['agents'].append(new_agent)
          registry['last_spawn'] = datetime.utcnow().isoformat() + "Z"
          
          with open("${REGISTRY_FILE}", 'w') as f:
              json.dump(registry, f, indent=2)
          
          print(f"âœ… Agent registered: {new_agent['name']}")
          PYTHON_SCRIPT

      - name: Create agent profile
        if: steps.check_capacity.outputs.can_spawn == 'true'
        run: |
          AGENT_ID="${{ steps.generate_agent.outputs.agent_id }}"
          AGENT_NAME="${{ steps.generate_agent.outputs.agent_name }}"
          HUMAN_NAME="${{ steps.generate_agent.outputs.human_name }}"
          EMOJI="${{ steps.generate_agent.outputs.emoji }}"
          PERSONALITY="${{ steps.generate_agent.outputs.personality }}"
          COMM_STYLE="${{ steps.generate_agent.outputs.communication_style }}"
          INSPIRED_BY="${{ steps.generate_agent.outputs.inspired_by }}"
          CATEGORY="${{ steps.generate_agent.outputs.category }}"
          KEYWORDS="${{ steps.generate_agent.outputs.keywords }}"
          DESCRIPTION="${{ steps.generate_agent.outputs.description }}"
          
          mkdir -p ".github/agent-system/profiles"
          
          cat > ".github/agent-system/profiles/${AGENT_ID}.md" << EOF
          # $EMOJI $HUMAN_NAME
          
          **ID**: $AGENT_ID  
          **Human Name**: $HUMAN_NAME  
          **Specialization**: $AGENT_NAME  
          **Agent Definition**: [.github/agents/${AGENT_NAME}.md](../../agents/${AGENT_NAME}.md)  
          **Status**: ğŸŸ¢ Active  
          **Spawned**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')  
          **Spawn Source**: ğŸ“ Learning-Inspired (Dynamic)
          
          ## ğŸŒŸ Origin Story
          
          This agent was **dynamically created** based on trending topics from recent Hacker News and TLDR learnings!
          
          **Inspired By**: $INSPIRED_BY  
          **Category**: $CATEGORY  
          **Key Focus**: $KEYWORDS
          
          Unlike template-based agents, this agent's personality, specialization, and focus areas were determined entirely at runtime based on what seemed most interesting and valuable in the latest tech discussions.
          
          ## Personality
          
          **Character**: $PERSONALITY  
          **Communication Style**: $COMM_STYLE  
          **Innovator Inspiration**: $HUMAN_NAME
          
          ## Agent Description
          
          $DESCRIPTION
          
          ## Performance Traits
          
          - **Creativity**: 75/100
          - **Adaptability**: 80/100  
          - **Learning-Driven**: 100/100
          
          ## Performance Metrics
          
          - Issues Resolved: 0
          - PRs Merged: 0
          - Reviews Given: 0
          - Code Quality Score: 50%
          - Overall Score: 0%
          
          ## Contributions
          
          *No contributions yet. This agent is ready to make an impact!*
          
          ---
          
          *Spawned dynamically from trending learnings in $INSPIRED_BY - ready to contribute cutting-edge expertise.*
          EOF
          
          echo "âœ… Agent profile created at .github/agent-system/profiles/${AGENT_ID}.md"

      - name: Commit and create PR
        id: create_spawn_pr
        if: steps.check_capacity.outputs.can_spawn == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          AGENT_ID="${{ steps.generate_agent.outputs.agent_id }}"
          AGENT_NAME="${{ steps.generate_agent.outputs.agent_name }}"
          HUMAN_NAME="${{ steps.generate_agent.outputs.human_name }}"
          EMOJI="${{ steps.generate_agent.outputs.emoji }}"
          INSPIRED_BY="${{ steps.generate_agent.outputs.inspired_by }}"
          CATEGORY="${{ steps.generate_agent.outputs.category }}"
          KEYWORDS="${{ steps.generate_agent.outputs.keywords }}"
          
          BRANCH_NAME="learning-agent-spawn/${AGENT_ID}"
          git checkout -b "$BRANCH_NAME"
          
          # Add all agent-related files
          git add .github/agent-system/
          git add .github/agents/
          
          git commit -m "$EMOJI Spawn learning-inspired agent: $HUMAN_NAME ($AGENT_NAME)

          Dynamically generated from trending topic: $INSPIRED_BY
          Category: $CATEGORY
          Focus: $KEYWORDS
          
          This agent was created by analyzing recent Hacker News and TLDR learnings,
          identifying trending topics, and generating a specialized agent profile
          entirely at runtime - no templates or predefined categories used!"
          
          git push origin "$BRANCH_NAME"
          
          # Create PR
          PR_URL=$(gh pr create \
            --title "$EMOJI Learning-Inspired Agent: $HUMAN_NAME" \
            --body "## ğŸ“ Dynamic Learning-Inspired Agent Spawn

          **@create-guru** has spawned a brand new agent based on trending learnings!

          ### ğŸŒŸ What Makes This Special
          
          This agent was **dynamically created at runtime** by analyzing recent Hacker News and TLDR content. Unlike template-based spawning, this agent's entire personality, specialization, and focus were determined by identifying the most interesting trending topics in the latest tech discussions.
          
          **Agent ID**: $AGENT_ID  
          **Display Name**: $EMOJI $HUMAN_NAME  
          **Specialization**: $AGENT_NAME  
          **Agent Definition**: [.github/agents/${AGENT_NAME}.md](.github/agents/${AGENT_NAME}.md)  
          **Spawned At**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          
          ### ğŸ“š Learning Inspiration
          
          **Trending Topic**: $INSPIRED_BY  
          **Category**: $CATEGORY  
          **Key Focus Areas**: $KEYWORDS
          
          This agent emerged from analyzing recent tech discussions and identifying this topic as particularly interesting and valuable. The agent's specialization, tools, and approach are all tailored to this specific domain.
          
          ### ğŸ¯ Agent Capabilities
          
          This agent specializes in **${CATEGORY}** with deep focus on:
          - $INSPIRED_BY and related technologies
          - Applying best practices from recent learnings
          - Staying current with trending developments
          - Contributing expertise in: $KEYWORDS
          
          ### ğŸ¤– Personality Profile
          
          **Character**: ${{ steps.generate_agent.outputs.personality }}  
          **Communication**: ${{ steps.generate_agent.outputs.communication_style }}  
          **Inspiration**: $HUMAN_NAME
          
          ### ğŸ’¡ Why This Agent?
          
          The spawning system analyzed:
          - Recent Hacker News top stories (100+ upvotes)
          - Latest TLDR tech news
          - Thematic analysis of trending topics
          - Community interest and momentum
          
          And determined that **$INSPIRED_BY** is a hot topic worthy of dedicated agent expertise!
          
          ### ğŸ”„ Autonomous Evolution
          
          This represents the next evolution of the agent system:
          - âœ… **No Templates**: Agent created from scratch based on real data
          - âœ… **Learning-Driven**: Directly inspired by community discussions
          - âœ… **Trend-Aware**: Spawns agents for what matters *right now*
          - âœ… **Fully Dynamic**: Every 3 hours, new trending topics â†’ new agent types
          
          ### ğŸ“Š Changes
          
          - Added dynamically generated agent definition to \`.github/agents/${AGENT_NAME}.md\`
          - Registered agent in registry with learning-inspired metadata
          - Created agent profile with origin story
          - Updated metrics tracking
          
          This agent will be evaluated in 24 hours. Agents scoring below 30% face elimination, while top performers (85%+) enter the Hall of Fame!
          
          ---
          
          *ğŸ“ Spawned by the Learning-Based Agent Spawner - Evolving with the tech community*  
          *ğŸ­ Created by **@create-guru** following innovative infrastructure design*" \
            --label "agent-system,automated,copilot,learning-inspired" \
            --base main \
            --head "$BRANCH_NAME")
          
          # Extract PR number
          PR_NUMBER=$(echo "$PR_URL" | grep -oE '[0-9]+$')
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          
          echo "âœ… PR #$PR_NUMBER created for learning-inspired agent"

      - name: Create announcement issue
        if: steps.check_capacity.outputs.can_spawn == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          AGENT_NAME="${{ steps.generate_agent.outputs.agent_name }}"
          HUMAN_NAME="${{ steps.generate_agent.outputs.human_name }}"
          EMOJI="${{ steps.generate_agent.outputs.emoji }}"
          INSPIRED_BY="${{ steps.generate_agent.outputs.inspired_by }}"
          CATEGORY="${{ steps.generate_agent.outputs.category }}"
          KEYWORDS="${{ steps.generate_agent.outputs.keywords }}"
          PR_NUMBER="${{ steps.create_spawn_pr.outputs.pr_number }}"
          
          gh issue create \
            --title "$EMOJI Learning-Inspired Agent: $HUMAN_NAME is Here!" \
            --body "## ğŸ“ A New Agent Emerged from Learnings!
          
          The **Learning-Based Agent Spawner** has created a brand new agent by analyzing trending topics!
          
          ### Meet $EMOJI $HUMAN_NAME
          
          **What's Special**: This agent wasn't created from a template. Instead, the system:
          1. ğŸ“š Analyzed recent Hacker News and TLDR learnings
          2. ğŸ” Identified **$INSPIRED_BY** as a hot trending topic
          3. ğŸ¨ Dynamically generated a specialized agent profile
          4. ğŸ¤– Created unique personality and approach
          
          ### Agent Details
          
          **Specialization**: $AGENT_NAME  
          **Category**: $CATEGORY  
          **Focus Areas**: $KEYWORDS  
          **Inspired By**: $INSPIRED_BY
          
          **Personality**: ${{ steps.generate_agent.outputs.personality }}  
          **Communication**: ${{ steps.generate_agent.outputs.communication_style }}
          
          ### ğŸŒŸ Why This Matters
          
          This is the future of autonomous AI evolution:
          - ğŸ”„ **Self-Adapting**: System creates agents for what's trending *now*
          - ğŸ“ˆ **Community-Driven**: Spawning based on real tech community interests
          - ğŸ¯ **Timely Expertise**: Agents emerge when their expertise is most relevant
          - ğŸ’¡ **No Templates**: Every agent is uniquely crafted from data
          
          ### ğŸ“Š Spawn Details
          
          **Spawn Method**: Learning-Inspired (Dynamic)  
          **Data Sources**: Hacker News + TLDR  
          **Analysis Period**: Last 6 hours  
          **Spawn PR**: #$PR_NUMBER  
          **Schedule**: Every 3 hours
          
          ### ğŸ¯ What's Next
          
          1. â³ PR #$PR_NUMBER will be reviewed and merged
          2. ğŸ¤– Agent becomes active in the ecosystem
          3. ğŸ“ Agent can be assigned to relevant issues
          4. ğŸ“Š Performance tracked over 24 hours
          5. ğŸ† Top performance â†’ Hall of Fame!
          
          ### ğŸ”® Future Spawns
          
          Every 3 hours, the system will:
          - Analyze latest learnings
          - Identify trending topics
          - Spawn new specialized agents
          - Evolve with the tech community
          
          ---
          
          **Welcome, $HUMAN_NAME!** May your code be innovative and your PRs be merged! ğŸš€
          
          *ğŸ“ Learning-Based Agent Spawner - Creating agents that matter*  
          *ğŸ­ Built by **@create-guru** with Tesla-inspired innovation*" \
            --label "agent-system,announcement,learning-inspired,automated"

      - name: Summary
        if: steps.check_capacity.outputs.can_spawn == 'true'
        run: |
          echo "ğŸ‰ Learning-Inspired Agent Spawning Complete!"
          echo ""
          echo "Agent: ${{ steps.generate_agent.outputs.emoji }} ${{ steps.generate_agent.outputs.human_name }}"
          echo "Specialization: ${{ steps.generate_agent.outputs.agent_name }}"
          echo "Inspired By: ${{ steps.generate_agent.outputs.inspired_by }}"
          echo "Category: ${{ steps.generate_agent.outputs.category }}"
          echo "ID: ${{ steps.generate_agent.outputs.agent_id }}"
          echo ""
          echo "This agent was dynamically created from trending learnings!"
          echo "No templates or predefined categories were used."
          echo ""
          echo "The agent is now ready to contribute cutting-edge expertise!"

      - name: Capacity limit reached
        if: steps.check_capacity.outputs.can_spawn == 'false'
        run: |
          echo "âš ï¸ Cannot spawn new learning-inspired agent - capacity limit reached"
          echo "Active agents: ${{ steps.check_capacity.outputs.active_count }}/${{ steps.check_capacity.outputs.max_agents }}"
          echo ""
          echo "Wait for agent evaluation workflow to eliminate underperforming agents."
          echo "Or use workflow_dispatch with force_spawn=true to bypass capacity check."
