name: Autonomous A/B Testing

# This workflow autonomously manages A/B testing experiments for workflow configurations
# Author: @workflows-tech-lead
# Inspired by: Martha Graham - Choreographic precision in automation

on:
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'
  
  workflow_dispatch:
    inputs:
      max_concurrent:
        description: 'Maximum concurrent experiments'
        required: false
        default: '5'
      dry_run:
        description: 'Dry run mode (analyze only, no creation)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write

jobs:
  autonomous-ab-testing:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install pyyaml
      
      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Run autonomous A/B testing cycle
        id: ab_testing
        run: |
          echo "ðŸ”¬ Running autonomous A/B testing cycle..."
          
          # Determine if dry-run mode
          DRY_RUN=""
          if [[ "${{ github.event.inputs.dry_run }}" == "true" ]]; then
            DRY_RUN="--dry-run"
            echo "mode=dry-run" >> $GITHUB_OUTPUT
          else
            echo "mode=live" >> $GITHUB_OUTPUT
          fi
          
          # Run the autonomous creator
          MAX_CONCURRENT="${{ github.event.inputs.max_concurrent || '5' }}"
          
          python3 tools/autonomous_experiment_creator.py \
            --max-concurrent "$MAX_CONCURRENT" \
            $DRY_RUN \
            --json > ab_testing_results.json
          
          # Parse results
          EXPERIMENTS_CREATED=$(jq -r '.experiments_created | length' ab_testing_results.json)
          WINNERS_DETECTED=$(jq -r '.winners_detected | length' ab_testing_results.json)
          EXPERIMENTS_COMPLETED=$(jq -r '.experiments_completed | length' ab_testing_results.json)
          
          echo "experiments_created=$EXPERIMENTS_CREATED" >> $GITHUB_OUTPUT
          echo "winners_detected=$WINNERS_DETECTED" >> $GITHUB_OUTPUT
          echo "experiments_completed=$EXPERIMENTS_COMPLETED" >> $GITHUB_OUTPUT
          
          # Show summary
          echo "## A/B Testing Cycle Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Mode**: ${{ github.event.inputs.dry_run == 'true' && 'Dry Run' || 'Live' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Experiments Created**: $EXPERIMENTS_CREATED" >> $GITHUB_STEP_SUMMARY
          echo "- **Winners Detected**: $WINNERS_DETECTED" >> $GITHUB_STEP_SUMMARY
          echo "- **Experiments Completed**: $EXPERIMENTS_COMPLETED" >> $GITHUB_STEP_SUMMARY
      
      - name: Generate dashboard
        if: steps.ab_testing.outputs.mode == 'live'
        run: |
          echo "ðŸ“Š Generating A/B testing dashboard..."
          python3 tools/ab_testing_dashboard.py
      
      - name: Create PR with updates
        if: steps.ab_testing.outputs.mode == 'live' && (steps.ab_testing.outputs.experiments_created > 0 || steps.ab_testing.outputs.experiments_completed > 0)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if there are changes to commit
          if ! git diff --quiet; then
            # Create unique branch name
            TIMESTAMP=$(date +%Y%m%d-%H%M%S)
            BRANCH_NAME="ab-testing/update-${TIMESTAMP}-${{ github.run_id }}"
            
            # Create and switch to new branch
            git checkout -b "$BRANCH_NAME"
            
            # Commit changes
            git add .github/agent-system/ab_tests_registry.json docs/ab-testing-dashboard.html
            git commit -m "ðŸ”¬ Autonomous A/B testing update - $(date +%Y-%m-%d)

Experiments created: ${{ steps.ab_testing.outputs.experiments_created }}
Winners detected: ${{ steps.ab_testing.outputs.winners_detected }}
Experiments completed: ${{ steps.ab_testing.outputs.experiments_completed }}

Automated by @workflows-tech-lead"
            
            # Push branch
            git push origin "$BRANCH_NAME"
            
            # Create PR
            gh pr create \
              --title "ðŸ”¬ A/B Testing Update - $(date +%Y-%m-%d) (@workflows-tech-lead)" \
              --body "## Autonomous A/B Testing Update

**@workflows-tech-lead** has autonomously updated A/B testing experiments.

### Summary
- **Experiments Created**: ${{ steps.ab_testing.outputs.experiments_created }}
- **Winners Detected**: ${{ steps.ab_testing.outputs.winners_detected }}
- **Experiments Completed**: ${{ steps.ab_testing.outputs.experiments_completed }}

### Files Updated
- \`.github/agent-system/ab_tests_registry.json\` - Experiment registry
- \`docs/ab-testing-dashboard.html\` - Visualization dashboard

### View Dashboard
See the [A/B Testing Dashboard](https://enufacas.github.io/Chained/ab-testing-dashboard.html) for visualization.

### Review Checklist
- [ ] Review new experiments for validity
- [ ] Check completed experiments for rollout
- [ ] Verify dashboard displays correctly

---

*ðŸ¤– Automated by workflow: [Autonomous A/B Testing](https://github.com/enufacas/Chained/actions/runs/${{ github.run_id }}) (@workflows-tech-lead)*" \
              --label "automated,ab-testing,workflows-tech-lead" \
              --base main \
              --head "$BRANCH_NAME"
            
            echo "âœ… PR created for A/B testing updates"
          else
            echo "â„¹ï¸  No changes to commit"
          fi
      
      - name: Comment on dry-run results
        if: steps.ab_testing.outputs.mode == 'dry-run'
        run: |
          echo "## ðŸ” Dry Run Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The autonomous A/B testing system analyzed workflows but did not create experiments." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To run in live mode, trigger the workflow without dry-run enabled." >> $GITHUB_STEP_SUMMARY
      
      - name: Upload results artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ab-testing-results
          path: |
            ab_testing_results.json
            docs/ab-testing-dashboard.html
          retention-days: 30

concurrency:
  group: autonomous-ab-testing
  cancel-in-progress: false
