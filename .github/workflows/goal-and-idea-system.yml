name: Goal and Idea System

# Consolidates goal and idea generation workflows:
# - ai-idea-spawner.yml â†’ Stage: ai-idea-spawner
# - daily-goal-generator.yml â†’ Stage: daily-goals
# - goal-progress-checker.yml â†’ Stage: progress-checker
# - idea-generator.yml â†’ Stage: general-ideas

on:
  schedule:
    # AI Ideas: every 4 hours
    - cron: '0 */4 * * *'
    # Daily Goals: 6 AM UTC
    - cron: '0 6 * * *'
    # Progress Check: 8 PM UTC
    - cron: '0 20 * * *'
  
  workflow_dispatch:
    inputs:
      stage:
        description: 'Which stage to run'
        required: true
        type: choice
        default: 'daily-goals'
        options:
          - ai-idea-spawner
          - daily-goals
          - progress-checker
          - general-ideas
      
      # AI Idea Spawner options
      focus:
        description: '[AI Ideas] Focus area'
        required: false
        type: choice
        options:
          - auto
          - ai-autonomy
          - ml-learning
          - code-generation
          - agent-systems
          - performance
        default: 'auto'
      
      # Daily Goals options
      force_new_goal:
        description: '[Daily Goals] Force new goal even if one exists'
        required: false
        default: 'false'
      
      # General Ideas options
      idea_count:
        description: '[General] Number of ideas to generate'
        required: false
        default: '3'

permissions:
  issues: write
  contents: write
  pull-requests: write

jobs:
  # ===================================================================================
  # STAGE 1: AI-Focused Idea Spawner (from ai-idea-spawner.yml)
  # ===================================================================================
  ai-idea-spawner:
    name: "AI Idea Spawner"
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'schedule' && github.event.schedule == '0 */4 * * *') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.stage == 'ai-idea-spawner')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Generate AI-focused idea
        id: generate
        env:
          FOCUS: ${{ github.event.inputs.focus || 'auto' }}
        run: |
          python3 << 'PYTHON_SCRIPT'
          import json
          import os
          import random
          import hashlib
          from datetime import datetime, timezone
          
          focus = os.environ.get('FOCUS', 'auto')
          
          ai_ideas = [
              "Self-evolving neural architecture adapting workflows based on success rates",
              "AI agent learning from failed PRs to improve code generation",
              "Meta-learning system optimizing workflow schedules",
              "Autonomous code reviewer improving criteria over time",
              "AI-powered workflow orchestrator predicting execution times",
              "Reinforcement learning for GitHub Actions resource optimization",
              "Autonomous issue prioritizer using multi-armed bandits",
              "Self-improving prompt generator for Copilot",
              "AI spawning specialized sub-agents based on workload",
              "System learning optimal git commit strategies",
              "Autonomous A/B testing for workflow configurations",
              "AI generating and testing code pattern hypotheses",
              "Self-documenting AI learning from discussions",
              "Autonomous refactoring agent learning style preferences",
              "Meta-agent coordinating specialized AI agents"
          ]
          
          # **@refactor-champion** Enhancement: Load AI ideas history for deduplication
          history_file = '.github/agent-system/ai_ideas_history.json'
          
          try:
              with open(history_file, 'r') as f:
                  history = json.load(f)
          except (FileNotFoundError, json.JSONDecodeError):
              # Initialize empty history
              history = {
                  'idea_hashes': [],
                  'created_ideas': [],
                  'last_updated': None
              }
          
          existing_hashes = set(history.get('idea_hashes', []))
          
          # **@refactor-champion** Enhancement: Find ideas that haven't been created yet
          available_ideas = []
          for idea_text in ai_ideas:
              # Generate hash for this idea
              idea_hash = hashlib.md5(idea_text.encode()).hexdigest()
              
              if idea_hash not in existing_hashes:
                  available_ideas.append((idea_text, idea_hash))
          
          # Select from available ideas, or if all used, reset and start over
          if available_ideas:
              idea, idea_hash = random.choice(available_ideas)
              print(f"âœ… Selected new idea (hash: {idea_hash[:8]}...)")
              print(f"   Available: {len(available_ideas)}/{len(ai_ideas)}")
          else:
              # All ideas have been used - reset the cycle
              print(f"ðŸ”„ All ideas used! Resetting cycle...")
              history['idea_hashes'] = []
              history['created_ideas'] = []
              
              idea = random.choice(ai_ideas)
              idea_hash = hashlib.md5(idea.encode()).hexdigest()
              print(f"âœ… Selected idea from fresh cycle (hash: {idea_hash[:8]}...)")
          
          # Record this idea in history
          history['idea_hashes'].append(idea_hash)
          history['created_ideas'].append({
              'idea': idea,
              'hash': idea_hash,
              'created_at': datetime.now(timezone.utc).isoformat()
          })
          history['last_updated'] = datetime.now(timezone.utc).isoformat()
          
          # Save updated history
          with open(history_file, 'w') as f:
              json.dump(history, f, indent=2)
          
          print(f"ðŸ“ Updated history: {len(history['idea_hashes'])} total ideas created")
          
          # Output for next step
          with open('/tmp/idea.txt', 'w') as f:
              f.write(idea)
          PYTHON_SCRIPT
          
          IDEA=$(cat /tmp/idea.txt)
          echo "idea=$IDEA" >> $GITHUB_OUTPUT

      - name: Create idea issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          IDEA="${{ steps.generate.outputs.idea }}"
          
          gh issue create \
            --title "ðŸ’¡ AI Idea: $IDEA" \
            --body "## AI-Generated Idea
          
          $IDEA
          
          This idea was automatically generated by the AI idea spawner.
          
          ---
          *ðŸ¤– Created by workflow: [goal-and-idea-system.yml](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) - AI Spawner (@workflows-tech-lead)*" \
            --label "idea,ai-generated,automated"

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit and create PR for history changes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # **@refactor-champion** Enhancement: Use PR-based workflow for history updates
          if git diff --quiet .github/agent-system/ai_ideas_history.json; then
            echo "No changes to history file"
          else
            # Create unique branch name
            TIMESTAMP=$(date +%Y%m%d-%H%M%S)
            BRANCH_NAME="ai-ideas-history/${TIMESTAMP}-${{ github.run_id }}"
            
            # Create branch and commit
            git checkout -b "$BRANCH_NAME"
            git add .github/agent-system/ai_ideas_history.json
            git commit -m "Update AI ideas history - prevent duplicates

          Track generated AI idea to ensure uniqueness across runs.
          
          ---
          *ðŸ¤– Automated by @refactor-champion*"
            
            # Push to new branch
            git push origin "$BRANCH_NAME"
            
            # Create pull request
            gh pr create \
              --title "Update AI ideas history - $(date +%Y-%m-%d)" \
              --body "## AI Ideas History Update

          **@refactor-champion** has updated the AI ideas history file to track generated ideas.

          ### Changes
          - Added new AI idea hash to prevent future duplicates
          - Updated timestamp

          This ensures each AI idea is only generated once before the cycle resets.

          ---
          *ðŸ¤– Automated by @refactor-champion via [goal-and-idea-system.yml](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*" \
              --label "automated,refactor-champion" \
              --base main \
              --head "$BRANCH_NAME"
            
            echo "âœ… History PR created"
          fi

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ’¡ AI Idea Spawner" >> $GITHUB_STEP_SUMMARY
          echo "- **Idea**: ${{ steps.generate.outputs.idea }}" >> $GITHUB_STEP_SUMMARY

  # ===================================================================================
  # STAGE 2: Daily Goal Generator (from daily-goal-generator.yml)
  # ===================================================================================
  daily-goals:
    name: "Daily Goals"
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'schedule' && github.event.schedule == '0 6 * * *') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.stage == 'daily-goals')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check existing goals
        id: check_goals
        run: |
          TODAY=$(date +%Y-%m-%d)
          GOALS_FILE="docs/AI_GOALS.md"
          
          if [ ! -f "$GOALS_FILE" ]; then
            cat > "$GOALS_FILE" << 'EOF'
          # ðŸŽ¯ AI Goals of the Day
          
          ## Current Goal
          
          *No goal set yet.*
          
          ## Goal History
          
          EOF
            echo "goal_exists=false" >> $GITHUB_OUTPUT
          elif grep -q "### $TODAY" "$GOALS_FILE" && [ "${{ github.event.inputs.force_new_goal }}" != "true" ]; then
            echo "goal_exists=true" >> $GITHUB_OUTPUT
          else
            echo "goal_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate daily goal
        id: generate_goal
        if: steps.check_goals.outputs.goal_exists == 'false'
        run: |
          python3 << 'PYTHON_SCRIPT'
          import random
          from datetime import datetime
          
          goal_templates = [
              "Improve code quality by {metric}%",
              "Reduce workflow execution time by {metric} minutes",
              "Increase agent success rate to {metric}%",
              "Complete {metric} pending issues",
              "Optimize {metric} workflows",
              "Enhance documentation coverage to {metric}%",
              "Reduce technical debt by {metric} items"
          ]
          
          template = random.choice(goal_templates)
          metric = random.randint(5, 25)
          goal = template.format(metric=metric)
          
          today = datetime.now().strftime('%Y-%m-%d')
          
          with open('/tmp/goal.txt', 'w') as f:
              f.write(f"{today}|{goal}")
          PYTHON_SCRIPT
          
          GOAL_DATA=$(cat /tmp/goal.txt)
          TODAY=$(echo "$GOAL_DATA" | cut -d'|' -f1)
          GOAL=$(echo "$GOAL_DATA" | cut -d'|' -f2)
          
          echo "today=$TODAY" >> $GITHUB_OUTPUT
          echo "goal=$GOAL" >> $GITHUB_OUTPUT

      - name: Update goals file
        if: steps.check_goals.outputs.goal_exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TODAY="${{ steps.generate_goal.outputs.today }}"
          GOAL="${{ steps.generate_goal.outputs.goal }}"
          GOALS_FILE="docs/AI_GOALS.md"
          
          # Update current goal section
          sed -i '/## Current Goal/,/## Goal History/{/## Current Goal/!{/## Goal History/!d;}}' "$GOALS_FILE"
          sed -i "/## Current Goal/a\\
          \\
          **Date**: $TODAY  \\
          **Goal**: $GOAL  \\
          **Status**: ðŸ”„ In Progress\\
          " "$GOALS_FILE"
          
          # Add to history
          sed -i "/## Goal History/a\\
          \\
          ### $TODAY\\
          - **Goal**: $GOAL\\
          - **Status**: ðŸ”„ In Progress\\
          " "$GOALS_FILE"
          
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BRANCH_NAME="daily-goal/${TIMESTAMP}-${{ github.run_id }}"
          git checkout -b "$BRANCH_NAME"
          
          git add "$GOALS_FILE"
          git commit -m "ðŸŽ¯ Daily goal for $TODAY"
          git push origin "$BRANCH_NAME"
          
          gh pr create \
            --title "ðŸŽ¯ Daily Goal: $TODAY" \
            --body "## Daily Goal
          
          **$GOAL**
          
          ---
          *ðŸ¤– Created by workflow: [goal-and-idea-system.yml](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) - Daily Goals (@workflows-tech-lead)*" \
            --label "goals,automated" \
            --base main \
            --head "$BRANCH_NAME" || true

      - name: Summary
        if: always()
        run: |
          echo "## ðŸŽ¯ Daily Goals" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check_goals.outputs.goal_exists }}" == "true" ]; then
            echo "âœ… Goal already exists for today" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Goal**: ${{ steps.generate_goal.outputs.goal }}" >> $GITHUB_STEP_SUMMARY
          fi

  # ===================================================================================
  # STAGE 3: Goal Progress Checker (from goal-progress-checker.yml)
  # ===================================================================================
  progress-checker:
    name: "Progress Checker"
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'schedule' && github.event.schedule == '0 20 * * *') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.stage == 'progress-checker')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check goal progress
        id: check_progress
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TODAY=$(date +%Y-%m-%d)
          GOALS_FILE="docs/AI_GOALS.md"
          
          if [ ! -f "$GOALS_FILE" ]; then
            echo "No goals file found"
            echo "has_goal=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          if ! grep -q "### $TODAY" "$GOALS_FILE"; then
            echo "No goal for today"
            echo "has_goal=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "has_goal=true" >> $GITHUB_OUTPUT
          
          # Check repository activity
          COMMITS_TODAY=$(git log --since="00:00:00" --until="23:59:59" --oneline | wc -l)
          PRS_MERGED=$(gh pr list --state merged --search "merged:$TODAY" --json number | jq 'length')
          ISSUES_CLOSED=$(gh issue list --state closed --search "closed:$TODAY" --json number | jq 'length')
          
          echo "commits=$COMMITS_TODAY" >> $GITHUB_OUTPUT
          echo "prs_merged=$PRS_MERGED" >> $GITHUB_OUTPUT
          echo "issues_closed=$ISSUES_CLOSED" >> $GITHUB_OUTPUT
          
          # Simple progress calculation
          TOTAL_ACTIVITY=$((COMMITS_TODAY + PRS_MERGED * 2 + ISSUES_CLOSED * 3))
          
          if [ $TOTAL_ACTIVITY -ge 10 ]; then
            echo "status=âœ… Completed" >> $GITHUB_OUTPUT
          elif [ $TOTAL_ACTIVITY -ge 5 ]; then
            echo "status=ðŸ”„ Good Progress" >> $GITHUB_OUTPUT
          else
            echo "status=âš ï¸ Limited Progress" >> $GITHUB_OUTPUT
          fi

      - name: Update goal status
        if: steps.check_progress.outputs.has_goal == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          TODAY=$(date +%Y-%m-%d)
          GOALS_FILE="docs/AI_GOALS.md"
          STATUS="${{ steps.check_progress.outputs.status }}"
          
          # Update status in history
          sed -i "/### $TODAY/,/^$/s/Status\*\*: .*/Status**: $STATUS/" "$GOALS_FILE"
          
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BRANCH_NAME="goal-progress/${TIMESTAMP}-${{ github.run_id }}"
          git checkout -b "$BRANCH_NAME"
          
          git add "$GOALS_FILE"
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸ“Š Goal progress update: $STATUS"
            git push origin "$BRANCH_NAME"
            
            gh pr create \
              --title "ðŸ“Š Goal Progress: $TODAY" \
              --body "## Goal Progress Update
            
            **Status**: $STATUS
            **Commits**: ${{ steps.check_progress.outputs.commits }}
            **PRs Merged**: ${{ steps.check_progress.outputs.prs_merged }}
            **Issues Closed**: ${{ steps.check_progress.outputs.issues_closed }}
            
            ---
            *ðŸ¤– Created by workflow: [goal-and-idea-system.yml](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) - Progress Checker (@workflows-tech-lead)*" \
              --label "goals,automated" \
              --base main \
              --head "$BRANCH_NAME" || true
          fi

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ“Š Progress Checker" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check_progress.outputs.has_goal }}" == "true" ]; then
            echo "- **Status**: ${{ steps.check_progress.outputs.status }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Activity**: ${{ steps.check_progress.outputs.commits }} commits, ${{ steps.check_progress.outputs.prs_merged }} PRs, ${{ steps.check_progress.outputs.issues_closed }} issues" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No goal found for today" >> $GITHUB_STEP_SUMMARY
          fi

  # ===================================================================================
  # STAGE 4: General Idea Generator (from idea-generator.yml)
  # ===================================================================================
  general-ideas:
    name: "General Ideas"
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.stage == 'general-ideas'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate ideas
        id: generate
        run: |
          COUNT=${{ github.event.inputs.idea_count || '3' }}
          
          python3 << PYTHON_SCRIPT
          import random
          
          idea_pool = [
              "Add real-time collaboration features",
              "Implement advanced caching strategies",
              "Create comprehensive API documentation",
              "Build interactive tutorials",
              "Add performance monitoring dashboard",
              "Implement automated security scanning",
              "Create plugin architecture",
              "Add multi-language support",
              "Build CLI tool for common operations",
              "Implement GraphQL API layer"
          ]
          
          count = min(int($COUNT), len(idea_pool))
          ideas = random.sample(idea_pool, count)
          
          for i, idea in enumerate(ideas, 1):
              print(f"idea_{i}={idea}")
              with open(f'/tmp/idea_{i}.txt', 'w') as f:
                  f.write(idea)
          PYTHON_SCRIPT

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ’¡ General Ideas" >> $GITHUB_STEP_SUMMARY
          echo "Generated ${{ github.event.inputs.idea_count || '3' }} ideas" >> $GITHUB_STEP_SUMMARY
