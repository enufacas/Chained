name: "Code Quality: Archaeologist"

on:
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      max_commits:
        description: 'Maximum number of commits to analyze'
        required: false
        default: '100'
      since:
        description: 'Only analyze commits since date (e.g., "1 month ago")'
        required: false

permissions:
  contents: write
  issues: write

jobs:
  analyze-history:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for archaeology

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Run Code Archaeologist
        id: archaeology
        run: |
          max_commits="${{ github.event.inputs.max_commits }}"
          max_commits="${max_commits:-100}"
          
          since_arg=""
          if [ -n "${{ github.event.inputs.since }}" ]; then
            since_arg="--since '${{ github.event.inputs.since }}'"
          fi
          
          echo "Running archaeology with max_commits=$max_commits $since_arg"
          
          python3 tools/code-archaeologist.py \
            -n "$max_commits" \
            $since_arg \
            -o archaeology_report.md
          
          # Extract statistics for issue
          commits_analyzed=$(grep "Total commits analyzed:" archaeology_report.md | grep -o '[0-9]*')
          decisions_found=$(grep "Architectural decisions found:" archaeology_report.md | grep -o '[0-9]*')
          debt_found=$(grep "Technical debt items found:" archaeology_report.md | grep -o '[0-9]*')
          
          echo "commits_analyzed=$commits_analyzed" >> $GITHUB_OUTPUT
          echo "decisions_found=$decisions_found" >> $GITHUB_OUTPUT
          echo "debt_found=$debt_found" >> $GITHUB_OUTPUT

      - name: Commit archaeology data
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Add analysis files
          git add analysis/archaeology.json
          git add analysis/archaeology_*.json
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "üèõÔ∏è Update archaeology database - $(date -u +"%Y-%m-%d")"
            git push
            echo "Archaeology data committed and pushed"
          fi

      - name: Create archaeology issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Format report for issue
          cat > issue_body.md << 'EOF'
          ## üèõÔ∏è Code Archaeology Report
          
          **Analysis Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          ### Summary
          - üìä Commits analyzed: ${{ steps.archaeology.outputs.commits_analyzed }}
          - üèóÔ∏è Architectural decisions found: ${{ steps.archaeology.outputs.decisions_found }}
          - ‚ö†Ô∏è Technical debt items found: ${{ steps.archaeology.outputs.debt_found }}
          
          ### What is Code Archaeology?
          
          The Code Archaeologist analyzes git history to document:
          - **Legacy Decisions**: Why code exists the way it does
          - **Architectural Evolution**: How the system changed over time
          - **Technical Debt**: TODOs, FIXMEs, and workarounds in commit history
          - **Decision Timeline**: When and why important choices were made
          
          ### Key Insights
          
          EOF
          
          # Add insights from report
          sed -n '/## üí° Insights/,/## üéØ Recommendations/p' archaeology_report.md | \
            head -n -1 | tail -n +2 >> issue_body.md
          
          echo "" >> issue_body.md
          echo "### Recommendations" >> issue_body.md
          echo "" >> issue_body.md
          
          sed -n '/## üéØ Recommendations/,$p' archaeology_report.md | \
            tail -n +2 >> issue_body.md
          
          echo "" >> issue_body.md
          echo "---" >> issue_body.md
          echo "" >> issue_body.md
          echo "üìÅ **Full Report:** See \`archaeology_report.md\` in the workflow artifacts" >> issue_body.md
          echo "üìä **Database:** Updated in \`analysis/archaeology.json\`" >> issue_body.md
          echo "" >> issue_body.md
          echo "*Generated by Code Archaeologist workflow*" >> issue_body.md
          
          # Create issue
          gh issue create \
            --title "üèõÔ∏è Code Archaeology Report - $(date -u +"%Y-%m-%d")" \
            --body-file issue_body.md \
            --label "archaeology,documentation,automated"

      - name: Upload archaeology report
        uses: actions/upload-artifact@v4
        with:
          name: archaeology-report
          path: |
            archaeology_report.md
            analysis/archaeology*.json

      - name: Log completion
        run: |
          echo "‚úÖ Code archaeology completed"
          echo "Commits analyzed: ${{ steps.archaeology.outputs.commits_analyzed }}"
          echo "Decisions found: ${{ steps.archaeology.outputs.decisions_found }}"
          echo "Technical debt found: ${{ steps.archaeology.outputs.debt_found }}"
