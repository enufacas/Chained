name: AI Workflow Orchestrator Demo
# Created by @coordinate-wizard

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'Orchestrator mode'
        required: true
        default: 'report'
        type: choice
        options:
          - report
          - simulate
          - export
  schedule:
    # Run weekly on Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  ai-orchestrator-demo:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install PyYAML>=6.0
      
      - name: Run AI Workflow Predictor
        id: predictor
        run: |
          echo "üéπ @coordinate-wizard - AI Workflow Orchestrator Demo"
          echo "=================================================="
          
          # Determine mode
          MODE="${{ github.event.inputs.mode }}"
          if [ -z "$MODE" ]; then
            MODE="report"
          fi
          
          echo "Mode: $MODE"
          
          case "$MODE" in
            "simulate")
              echo ""
              echo "üß™ Simulating workflow execution data..."
              python3 tools/ai_workflow_predictor.py --simulate --report
              ;;
            "export")
              echo ""
              echo "üíæ Exporting recommendations..."
              python3 tools/integrated_workflow_orchestrator.py --export workflow_recommendations.json
              ;;
            "report")
              echo ""
              echo "üìä Generating comprehensive orchestration report..."
              python3 tools/integrated_workflow_orchestrator.py --report
              ;;
            *)
              echo "Unknown mode: $MODE"
              exit 1
              ;;
          esac
      
      - name: Check for recommendation file
        id: check_file
        run: |
          if [ -f "workflow_recommendations.json" ]; then
            echo "has_recommendations=true" >> $GITHUB_OUTPUT
          else
            echo "has_recommendations=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Create summary
        if: steps.check_file.outputs.has_recommendations == 'true'
        run: |
          echo "## üéº AI Workflow Orchestrator Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**@coordinate-wizard** has analyzed the workflow ecosystem." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Parse JSON and create summary
          python3 << 'EOF'
          import json
          import sys
          
          try:
              with open('workflow_recommendations.json', 'r') as f:
                  data = json.load(f)
              
              total = data.get('total_workflows', 0)
              high_conf = data.get('high_confidence_count', 0)
              
              print(f"### üìä Overview")
              print(f"")
              print(f"- **Total Workflows Analyzed**: {total}")
              print(f"- **High Confidence Recommendations**: {high_conf}")
              print(f"- **Analysis Timestamp**: {data.get('timestamp', 'N/A')}")
              print(f"")
              
              if high_conf > 0:
                  print(f"### ‚úÖ Top Recommendations")
                  print(f"")
                  recommendations = data.get('recommendations', {})
                  
                  # Get high confidence recommendations
                  high_conf_recs = [(name, rec) for name, rec in recommendations.items() 
                                   if rec.get('apply_recommendation', False)]
                  
                  # Sort by confidence
                  high_conf_recs.sort(key=lambda x: x[1].get('confidence', 0), reverse=True)
                  
                  # Show top 5
                  for name, rec in high_conf_recs[:5]:
                      conf = rec.get('confidence', 0) * 100
                      schedule = rec.get('ai_schedule', 'N/A')
                      duration = rec.get('expected_duration', 0)
                      print(f"- **{name}**")
                      print(f"  - Schedule: `{schedule}`")
                      print(f"  - Confidence: {conf:.0f}%")
                      print(f"  - Expected Duration: {duration:.0f}s")
                      print(f"")
              else:
                  print(f"### ‚ÑπÔ∏è Note")
                  print(f"")
                  print(f"No high-confidence recommendations yet. More historical data is needed for accurate predictions.")
                  print(f"")
          except Exception as e:
              print(f"Error parsing recommendations: {e}", file=sys.stderr)
              sys.exit(1)
          EOF
          
          cat >> $GITHUB_STEP_SUMMARY
      
      - name: Commit recommendations (if export mode)
        if: github.event.inputs.mode == 'export' && steps.check_file.outputs.has_recommendations == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BRANCH_NAME="ai-orchestrator-recommendations/${TIMESTAMP}-${{ github.run_id }}"
          
          git checkout -b "$BRANCH_NAME"
          git add workflow_recommendations.json
          git commit -m "chore: AI workflow recommendations by @coordinate-wizard"
          git push origin "$BRANCH_NAME"
          
          # Create PR (with fallback if labels don't exist)
          gh pr create \
            --title "üéπ AI Workflow Orchestrator Recommendations" \
            --body "**@coordinate-wizard** has generated intelligent workflow scheduling recommendations.

## üìä Analysis Results

This PR contains recommendations from the AI-powered workflow orchestrator.

### What's Included
- JSON export of all workflow predictions
- Confidence scores for each recommendation
- Expected durations and success rates
- Resource impact classifications

### How to Use
1. Review the recommendations in \`workflow_recommendations.json\`
2. Apply high-confidence recommendations (>70%) to your workflows
3. Monitor the results and provide feedback

### Next Steps
- Collect real execution data to improve predictions
- Integrate with existing workflow orchestrator
- Monitor prediction accuracy

---

*Orchestrated by **@coordinate-wizard*** üéπ" \
            --label "automated,workflow-optimization" \
            --base main \
            --head "$BRANCH_NAME" || {
              echo "‚ö†Ô∏è PR creation with labels failed, retrying without labels..."
              gh pr create \
                --title "üéπ AI Workflow Orchestrator Recommendations" \
                --body "**@coordinate-wizard** has generated intelligent workflow scheduling recommendations. (Labels could not be applied - they may need to be created)" \
                --base main \
                --head "$BRANCH_NAME"
            }
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Add comment to issue (if triggered from issue)
        if: github.event_name == 'workflow_dispatch' && github.event.issue
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "üéº **@coordinate-wizard** has completed the AI workflow orchestrator demo.

‚úÖ Mode: ${{ github.event.inputs.mode }}
üìä Check the workflow run for detailed results: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

The AI orchestrator is learning from workflow patterns to optimize execution times!"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
