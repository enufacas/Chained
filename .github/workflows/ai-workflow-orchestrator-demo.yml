name: AI Workflow Orchestrator Demo
# Created by @coordinate-wizard

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'Orchestrator mode'
        required: true
        default: 'report'
        type: choice
        options:
          - report
          - simulate
          - export
          - accuracy
          - track-demo
  schedule:
    # Run weekly on Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  ai-orchestrator-demo:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install PyYAML>=6.0
      
      - name: Run AI Workflow Predictor
        id: predictor
        run: |
          echo "üéπ @coordinate-wizard - AI Workflow Orchestrator Demo"
          echo "=================================================="
          
          # Determine mode
          MODE="${{ github.event.inputs.mode }}"
          if [ -z "$MODE" ]; then
            MODE="report"
          fi
          
          echo "Mode: $MODE"
          
          case "$MODE" in
            "simulate")
              echo ""
              echo "üß™ Simulating workflow execution data..."
              python3 tools/ai_workflow_predictor.py --simulate --report
              ;;
            "export")
              echo ""
              echo "üíæ Exporting recommendations..."
              python3 tools/integrated_workflow_orchestrator.py --export workflow_recommendations.json
              ;;
            "report")
              echo ""
              echo "üìä Generating comprehensive orchestration report..."
              python3 tools/integrated_workflow_orchestrator.py --report
              ;;
            "accuracy")
              echo ""
              echo "üìà Analyzing prediction accuracy..."
              python3 tools/workflow_execution_tracker.py --simulate --report
              python3 tools/workflow_execution_tracker.py --export accuracy_metrics.json
              ;;
            "track-demo")
              echo ""
              echo "üéØ Demonstrating execution time tracking..."
              echo ""
              echo "Step 1: Creating prediction data..."
              python3 tools/ai_workflow_predictor.py --simulate
              echo ""
              echo "Step 2: Simulating tracked executions..."
              python3 tools/workflow_execution_tracker.py --simulate
              echo ""
              echo "Step 3: Generating accuracy report..."
              python3 tools/workflow_execution_tracker.py --report
              echo ""
              echo "Step 4: Showing integrated orchestrator with accuracy..."
              python3 tools/integrated_workflow_orchestrator.py --report
              ;;
            *)
              echo "Unknown mode: $MODE"
              exit 1
              ;;
          esac
      
      - name: Check for recommendation file
        id: check_file
        run: |
          if [ -f "workflow_recommendations.json" ]; then
            echo "has_recommendations=true" >> $GITHUB_OUTPUT
          else
            echo "has_recommendations=false" >> $GITHUB_OUTPUT
          fi
          
          if [ -f "accuracy_metrics.json" ]; then
            echo "has_accuracy=true" >> $GITHUB_OUTPUT
          else
            echo "has_accuracy=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Create summary
        if: steps.check_file.outputs.has_recommendations == 'true'
        run: |
          echo "## üéº AI Workflow Orchestrator Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**@coordinate-wizard** has analyzed the workflow ecosystem." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Parse JSON and create summary
          python3 << 'EOF'
          import json
          import sys
          
          try:
              with open('workflow_recommendations.json', 'r') as f:
                  data = json.load(f)
              
              total = data.get('total_workflows', 0)
              high_conf = data.get('high_confidence_count', 0)
              
              print(f"### üìä Overview")
              print(f"")
              print(f"- **Total Workflows Analyzed**: {total}")
              print(f"- **High Confidence Recommendations**: {high_conf}")
              print(f"- **Analysis Timestamp**: {data.get('timestamp', 'N/A')}")
              print(f"")
              
              if high_conf > 0:
                  print(f"### ‚úÖ Top Recommendations")
                  print(f"")
                  recommendations = data.get('recommendations', {})
                  
                  # Get high confidence recommendations
                  high_conf_recs = [(name, rec) for name, rec in recommendations.items() 
                                   if rec.get('apply_recommendation', False)]
                  
                  # Sort by confidence
                  high_conf_recs.sort(key=lambda x: x[1].get('confidence', 0), reverse=True)
                  
                  # Show top 5
                  for name, rec in high_conf_recs[:5]:
                      conf = rec.get('confidence', 0) * 100
                      schedule = rec.get('ai_schedule', 'N/A')
                      duration = rec.get('expected_duration', 0)
                      print(f"- **{name}**")
                      print(f"  - Schedule: `{schedule}`")
                      print(f"  - Confidence: {conf:.0f}%")
                      print(f"  - Expected Duration: {duration:.0f}s")
                      print(f"")
              else:
                  print(f"### ‚ÑπÔ∏è Note")
                  print(f"")
                  print(f"No high-confidence recommendations yet. More historical data is needed for accurate predictions.")
                  print(f"")
          except Exception as e:
              print(f"Error parsing recommendations: {e}", file=sys.stderr)
              sys.exit(1)
          EOF
          
          cat >> $GITHUB_STEP_SUMMARY
      
      - name: Create accuracy summary
        if: steps.check_file.outputs.has_accuracy == 'true'
        run: |
          echo "## üìà Prediction Accuracy Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**@workflows-tech-lead** has analyzed prediction accuracy." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Parse accuracy JSON and create summary
          python3 << 'EOF'
          import json
          import sys
          
          try:
              with open('accuracy_metrics.json', 'r') as f:
                  data = json.load(f)
              
              overall = data.get('overall_metrics', {})
              total = overall.get('total_comparisons', 0)
              mean_error = overall.get('mean_error_percent', 0)
              accuracy = overall.get('overall_accuracy_score', 0)
              
              print(f"### üìä Overall Accuracy")
              print(f"")
              print(f"- **Total Predictions Tracked**: {total}")
              print(f"- **Mean Error**: {mean_error:.1f}%")
              print(f"- **Overall Accuracy Score**: {accuracy:.1f}%")
              print(f"")
              
              dist = overall.get('accuracy_distribution', {})
              excellent = dist.get('excellent_10_percent', 0)
              good = dist.get('good_25_percent', 0)
              fair = dist.get('fair_50_percent', 0)
              poor = dist.get('poor_over_50_percent', 0)
              
              print(f"### üéØ Accuracy Distribution")
              print(f"")
              print(f"| Category | Count | Percentage |")
              print(f"|----------|-------|------------|")
              print(f"| Excellent (‚â§10%) | {excellent} | {excellent/total*100:.0f}% |")
              print(f"| Good (10-25%) | {good} | {good/total*100:.0f}% |")
              print(f"| Fair (25-50%) | {fair} | {fair/total*100:.0f}% |")
              print(f"| Poor (>50%) | {poor} | {poor/total*100:.0f}% |")
              print(f"")
              
              # Show per-workflow top performers
              per_workflow = data.get('per_workflow_metrics', {})
              if per_workflow:
                  print(f"### üèÜ Top Performing Workflows")
                  print(f"")
                  
                  # Sort by accuracy
                  sorted_wf = sorted(per_workflow.items(), 
                                   key=lambda x: x[1].get('overall_accuracy_score', 0), 
                                   reverse=True)
                  
                  print(f"| Workflow | Comparisons | Mean Error | Accuracy |")
                  print(f"|----------|-------------|------------|----------|")
                  
                  for wf_name, metrics in sorted_wf[:5]:
                      comp = metrics.get('total_comparisons', 0)
                      error = metrics.get('mean_error_percent', 0)
                      acc = metrics.get('overall_accuracy_score', 0)
                      wf_short = wf_name[:30] + '...' if len(wf_name) > 30 else wf_name
                      print(f"| {wf_short} | {comp} | {error:.1f}% | {acc:.0f}% |")
                  
                  print(f"")
              
              print(f"### üîÑ Continuous Improvement")
              print(f"")
              print(f"The AI orchestrator learns from these comparisons to improve future predictions.")
              print(f"As more workflows are tracked, accuracy will continue to increase.")
              print(f"")
              
          except Exception as e:
              print(f"Error parsing accuracy metrics: {e}", file=sys.stderr)
              sys.exit(1)
          EOF
          
          cat >> $GITHUB_STEP_SUMMARY
      
      - name: Commit recommendations (if export mode)
        if: github.event.inputs.mode == 'export' && steps.check_file.outputs.has_recommendations == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BRANCH_NAME="ai-orchestrator-recommendations/${TIMESTAMP}-${{ github.run_id }}"
          
          git checkout -b "$BRANCH_NAME"
          git add workflow_recommendations.json
          git commit -m "chore: AI workflow recommendations by @coordinate-wizard"
          git push origin "$BRANCH_NAME"
          
          # Create PR (with fallback if labels don't exist)
          gh pr create \
            --title "üéπ AI Workflow Orchestrator Recommendations" \
            --body "**@coordinate-wizard** has generated intelligent workflow scheduling recommendations."$'\n\n'"## üìä Analysis Results"$'\n\n'"This PR contains recommendations from the AI-powered workflow orchestrator."$'\n\n'"### What's Included"$'\n'"- JSON export of all workflow predictions"$'\n'"- Confidence scores for each recommendation"$'\n'"- Expected durations and success rates"$'\n'"- Resource impact classifications"$'\n\n'"### How to Use"$'\n'"1. Review the recommendations in \`workflow_recommendations.json\`"$'\n'"2. Apply high-confidence recommendations (>70%) to your workflows"$'\n'"3. Monitor the results and provide feedback"$'\n\n'"### Next Steps"$'\n'"- Collect real execution data to improve predictions"$'\n'"- Integrate with existing workflow orchestrator"$'\n'"- Monitor prediction accuracy"$'\n\n'"---"$'\n\n'"*Orchestrated by **@coordinate-wizard*** üéπ" \
            --label "automated,workflow-optimization" \
            --base main \
            --head "$BRANCH_NAME" || {
              echo "‚ö†Ô∏è PR creation with labels failed, retrying without labels..."
              gh pr create \
                --title "üéπ AI Workflow Orchestrator Recommendations" \
                --body "**@coordinate-wizard** has generated intelligent workflow scheduling recommendations. (Labels could not be applied - they may need to be created)" \
                --base main \
                --head "$BRANCH_NAME"
            }
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Commit accuracy metrics (if accuracy mode)
        if: github.event.inputs.mode == 'accuracy' && steps.check_file.outputs.has_accuracy == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BRANCH_NAME="ai-orchestrator-accuracy/${TIMESTAMP}-${{ github.run_id }}"
          
          git checkout -b "$BRANCH_NAME"
          git add accuracy_metrics.json
          git commit -m "chore: AI workflow prediction accuracy metrics by @workflows-tech-lead"
          git push origin "$BRANCH_NAME"
          
          # Create PR
          gh pr create \
            --title "üìà AI Workflow Prediction Accuracy Metrics" \
            --body "**@workflows-tech-lead** has analyzed prediction accuracy."$'\n\n'"## üìä Accuracy Analysis"$'\n\n'"This PR contains comprehensive accuracy metrics from the execution time tracker."$'\n\n'"### What's Included"$'\n'"- Overall prediction accuracy scores"$'\n'"- Per-workflow accuracy breakdown"$'\n'"- Error distribution analysis"$'\n'"- Recent prediction comparisons"$'\n\n'"### Key Metrics"$'\n'"- Mean error percentage"$'\n'"- Median error percentage"$'\n'"- Accuracy distribution (excellent/good/fair/poor)"$'\n'"- Per-workflow performance"$'\n\n'"### How to Use"$'\n'"1. Review \`accuracy_metrics.json\` for detailed analysis"$'\n'"2. Identify workflows with poor prediction accuracy"$'\n'"3. Collect more execution data for those workflows"$'\n'"4. Monitor accuracy improvements over time"$'\n\n'"---"$'\n\n'"*Tracked by **@workflows-tech-lead*** üîß" \
            --label "automated,workflow-optimization" \
            --base main \
            --head "$BRANCH_NAME" || {
              echo "‚ö†Ô∏è PR creation with labels failed, retrying without labels..."
              gh pr create \
                --title "üìà AI Workflow Prediction Accuracy Metrics" \
                --body "**@workflows-tech-lead** has analyzed prediction accuracy." \
                --base main \
                --head "$BRANCH_NAME"
            }
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Add comment to issue (if triggered from issue)
        if: github.event_name == 'workflow_dispatch' && github.event.issue
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "üéº **@coordinate-wizard** has completed the AI workflow orchestrator demo."$'\n\n'"‚úÖ Mode: ${{ github.event.inputs.mode }}"$'\n'"üìä Check the workflow run for detailed results: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"$'\n\n'"The AI orchestrator is learning from workflow patterns to optimize execution times!"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
