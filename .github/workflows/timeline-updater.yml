name: Timeline Updater

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  issues:
    types: [opened, closed, labeled]
  pull_request:
    types: [opened, closed, merged]
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write
  issues: read
  pull-requests: write

jobs:
  update-timeline:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Fetch repository activity
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create timeline data directory
          mkdir -p docs/data
          
          # Fetch recent issues
          echo "Fetching recent issues..."
          gh issue list --limit 100 --json number,title,body,state,createdAt,closedAt,labels,url > docs/data/issues.json
          
          # Fetch recent pull requests
          echo "Fetching recent pull requests..."
          gh pr list --limit 100 --state all --json number,title,body,state,createdAt,closedAt,mergedAt,url,author > docs/data/pulls.json
          
          # Fetch workflow runs to document automation activity
          echo "Fetching workflow runs..."
          gh run list --limit 100 --json databaseId,name,status,conclusion,createdAt,displayTitle > docs/data/workflows.json
          
          # Create activity summary
          total_issues=$(gh issue list --state all --limit 1000 --json number | jq '. | length')
          open_issues=$(gh issue list --state open --limit 1000 --json number | jq '. | length')
          closed_issues=$(gh issue list --state closed --limit 1000 --json number | jq '. | length')
          
          total_prs=$(gh pr list --state all --limit 1000 --json number | jq '. | length')
          merged_prs=$(gh pr list --state merged --limit 1000 --json number | jq '. | length')
          
          ai_generated=$(gh issue list --state all --label "ai-generated" --limit 1000 --json number | jq '. | length')
          copilot_assigned=$(gh issue list --state all --label "copilot-assigned" --limit 1000 --json number | jq '. | length')
          completed=$(gh issue list --state all --label "completed" --limit 1000 --json number | jq '. | length')
          in_progress=$(gh issue list --state open --label "in-progress" --limit 1000 --json number | jq '. | length')
          
          # Calculate metrics
          if [ ${ai_generated} -gt 0 ]; then
            completion_rate=$(awk "BEGIN {printf \"%.1f\", (${completed}/${ai_generated})*100}")
          else
            completion_rate="0.0"
          fi
          
          if [ ${total_prs} -gt 0 ]; then
            merge_rate=$(awk "BEGIN {printf \"%.1f\", (${merged_prs}/${total_prs})*100}")
          else
            merge_rate="0.0"
          fi
          
          cat > docs/data/stats.json << EOF
          {
            "total_issues": ${total_issues},
            "open_issues": ${open_issues},
            "closed_issues": ${closed_issues},
            "total_prs": ${total_prs},
            "merged_prs": ${merged_prs},
            "ai_generated": ${ai_generated},
            "copilot_assigned": ${copilot_assigned},
            "completed": ${completed},
            "in_progress": ${in_progress},
            "completion_rate": ${completion_rate},
            "merge_rate": ${merge_rate},
            "last_updated": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          }
          EOF
          
          # Create automation log
          cat > docs/data/automation-log.json << EOF
          {
            "last_idea_generated": "$(gh issue list --label "ai-generated" --limit 1 --json createdAt --jq '.[0].createdAt // "N/A"')",
            "last_pr_merged": "$(gh pr list --state merged --limit 1 --json mergedAt --jq '.[0].mergedAt // "N/A"')",
            "last_issue_closed": "$(gh issue list --state closed --limit 1 --json closedAt --jq '.[0].closedAt // "N/A"')",
            "autonomous_actions_today": "$(date +%s | awk '{print int($1/86400)}')",
            "system_status": "active"
          }
          EOF
          
          echo "Timeline data updated successfully with automation metrics"

      - name: Create or update PR for timeline updates
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add docs/data/
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          # Check for existing open timeline update PRs
          existing_prs=$(gh pr list --state open --json number,headRefName,labels --jq '.[] | select(.headRefName | startswith("timeline/update-")) | .number' | head -1)
          
          if [ -n "${existing_prs}" ]; then
            pr_number="${existing_prs}"
            branch_name=$(gh pr view ${pr_number} --json headRefName --jq '.headRefName')
            
            echo "Found existing timeline PR #${pr_number} on branch ${branch_name}"
            
            # Check last update time of the PR to avoid too frequent updates
            last_update=$(gh pr view ${pr_number} --json updatedAt --jq '.updatedAt')
            last_update_seconds=$(date -d "${last_update}" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%SZ" "${last_update}" +%s 2>/dev/null || echo 0)
            current_seconds=$(date +%s)
            seconds_since_update=$((current_seconds - last_update_seconds))
            
            # Skip if updated less than 5 minutes ago (300 seconds)
            if [ ${seconds_since_update} -lt 300 ]; then
              echo "‚è≠Ô∏è  Skipping update - PR was updated ${seconds_since_update} seconds ago (< 5 minutes)"
              exit 0
            fi
            
            # Switch to the existing branch and update it
            git fetch origin "${branch_name}"
            git checkout "${branch_name}"
            git merge main --no-edit || true
            git add docs/data/
            git commit -m "üìä Update timeline data - $(date -u +"%Y-%m-%d %H:%M:%S UTC")" || {
              echo "No new changes to commit to existing PR"
              exit 0
            }
            git push origin "${branch_name}"
            
            echo "‚úÖ Updated existing PR #${pr_number}"
          else
            # No existing PR, create a new one
            branch_name="timeline/update-$(date +%Y%m%d-%H%M%S)"
            git checkout -b "${branch_name}"
            
            git commit -m "üìä Update timeline data - $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
            git push origin "${branch_name}"
            
            # Create PR with timeline-update label for tracking
            gh pr create \
              --title "üìä Timeline Update - $(date -u +"%Y-%m-%d %H:%M:%S UTC")" \
              --body "## Automated Timeline Data Update
            
            **Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
            
            ### Summary
            This PR updates the timeline data with the latest repository activity metrics.
            
            ### Changes
            - Updated issues and pull request data
            - Refreshed workflow run statistics
            - Updated automation metrics and completion rates
            - Regenerated activity summary
            
            ### Data Updated
            - \`docs/data/issues.json\` - Recent issues
            - \`docs/data/pulls.json\` - Recent pull requests
            - \`docs/data/workflows.json\` - Workflow runs
            - \`docs/data/stats.json\` - Repository statistics
            - \`docs/data/automation-log.json\` - Automation activity
            
            ---
            *This PR was automatically created by the Timeline Updater workflow and will be auto-merged.*" \
              --label "automated,copilot" \
              --base main \
              --head "${branch_name}"
            
            echo "‚úÖ PR created successfully for timeline update"
          fi

      - name: Log update
        run: |
          echo "Timeline updated successfully"
          echo "Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
