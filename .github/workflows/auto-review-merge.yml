name: Auto Review and Merge

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'learnings/**'
      - 'analysis/**'
  schedule:
    # Run every 15 minutes to sweep and check all PRs for merge readiness
    - cron: '*/15 * * * *'
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to review and merge'
        required: false
        type: string

# Prevent multiple simultaneous runs - allow scheduled runs to proceed but prevent concurrent PR runs
concurrency:
  group: ${{ github.event_name == 'schedule' && 'auto-review-scheduled' || format('auto-review-pr-{0}', github.event.pull_request.number) }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write
  issues: write
  checks: read

jobs:
  auto-review-merge:
    runs-on: ubuntu-latest
    # Skip draft PRs unless they're being converted to ready_for_review
    # Skip when PR is closed to avoid wasted runs
    if: |
      (github.event_name != 'pull_request' || 
       (github.event.action == 'ready_for_review' || 
        !github.event.pull_request.draft)) &&
      (github.event_name != 'pull_request' || 
       github.event.pull_request.state == 'open')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Label Copilot PRs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîç Checking for Copilot PRs to label..."
          
          # Get all open PRs from Copilot (matches various copilot formats including app/copilot-swe-agent)
          pr_list=$(gh pr list --repo ${{ github.repository }} --state open --json number,author,labels --jq '.[] | select(.author.login | test("^(Copilot|copilot|app/copilot)"; "i")) | .number')
          
          if [ -z "${pr_list}" ]; then
            echo "‚ÑπÔ∏è No Copilot PRs found"
          else
            echo "Found Copilot PRs: ${pr_list}"
            
            # Add label to each PR
            for pr_num in ${pr_list}; do
              # Check if PR already has the copilot label
              has_label=$(gh pr view ${pr_num} --repo ${{ github.repository }} --json labels --jq '.labels[] | select(.name == "copilot") | .name')
              
              if [ -z "${has_label}" ]; then
                echo "Adding 'copilot' label to PR #${pr_num}"
                gh pr edit ${pr_num} --add-label "copilot" --repo ${{ github.repository }} || echo "‚ö†Ô∏è Failed to add label to PR #${pr_num}"
              fi
            done
          fi

      - name: Get PRs to review
        id: get_prs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ inputs.pr_number }}" ]; then
            # Specific PR requested
            pr_numbers="${{ inputs.pr_number }}"
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            # PR event triggered
            pr_numbers="${{ github.event.pull_request.number }}"
          else
            # Scheduled run - get all open PRs
            pr_numbers=$(gh pr list --state open --json number --jq '.[].number' | tr '\n' ' ')
          fi
          
          echo "pr_numbers=${pr_numbers}" >> $GITHUB_OUTPUT
          echo "Found PRs to review: ${pr_numbers}"

      - name: Review and merge PRs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          for pr_num in ${{ steps.get_prs.outputs.pr_numbers }}; do
            if [ -z "${pr_num}" ]; then
              continue
            fi
            
            echo "Processing PR #${pr_num}"
            
            # Get PR details
            pr_data=$(gh pr view ${pr_num} --json title,body,author,labels,mergeable,state,isDraft)
            pr_state=$(echo "${pr_data}" | jq -r '.state')
            is_draft=$(echo "${pr_data}" | jq -r '.isDraft')
            mergeable=$(echo "${pr_data}" | jq -r '.mergeable')
            author=$(echo "${pr_data}" | jq -r '.author.login')
            pr_title=$(echo "${pr_data}" | jq -r '.title')
            
            # Get repository owner
            repo_owner="${{ github.repository_owner }}"
            
            # Check if PR author is the repository owner or a trusted bot
            is_repo_owner=0
            if [ "${author}" = "${repo_owner}" ]; then
              is_repo_owner=1
            fi
            
            is_trusted_bot=0
            # Match various bot author formats (gh CLI may return different formats)
            # GitHub Actions can appear as: github-actions[bot], app/github-actions
            # Dependabot appears as: dependabot[bot], app/dependabot
            # Copilot appears as: Copilot, copilot-swe-agent[bot], copilot*[bot], app/copilot-swe-agent
            if echo "${author}" | grep -qiE "^(github-actions\[bot\]|app/github-actions|dependabot\[bot\]|app/dependabot|app/copilot|copilot)"; then
              is_trusted_bot=1
            fi
            
            # Check if PR has Copilot label
            has_copilot_label=$(echo "${pr_data}" | jq -r '.labels[].name' | grep -c "copilot" || true)
            
            # Handle draft PRs that are ready (WIP removed, from trusted source)
            if [ "${is_draft}" = "true" ] && [ "${pr_state}" = "OPEN" ]; then
              echo "PR #${pr_num} is currently in draft status"
              echo "Debug - Author: '${author}', Trusted Bot: ${is_trusted_bot}, Repo Owner: ${is_repo_owner}, Copilot Label: ${has_copilot_label}"
              
              # Check if title contains WIP markers
              if echo "${pr_title}" | grep -qiE '\b(WIP|work.?in.?progress)\b'; then
                echo "PR #${pr_num} still has WIP in title, keeping as draft"
              else
                # Convert draft to ready if trusted source with copilot label
                if [ "${has_copilot_label}" -gt 0 ] && { [ "${is_trusted_bot}" -eq 1 ] || [ "${is_repo_owner}" -eq 1 ]; }; then
                  echo "‚ú® Converting PR #${pr_num} from draft to ready (no WIP in title, from trusted source)"
                  
                  if gh pr ready ${pr_num}; then
                    echo "‚úÖ PR #${pr_num} marked as ready for review"
                    
                    # Add comment explaining the conversion
                    gh pr comment ${pr_num} --body "üöÄ **Automatically Marked Ready for Review**
                    
                    This PR has been automatically converted from draft to ready status.
                    
                    **Criteria met:**
                    - ‚úÖ No WIP markers in title
                    - ‚úÖ From trusted source (${author})
                    - ‚úÖ Has copilot label
                    - ‚úÖ Part of autonomous development cycle
                    
                    **Next steps:**
                    - Auto-review will process this PR in the next cycle
                    - PR will be automatically merged if all checks pass
                    
                    **Timestamp:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')
                    
                    ---
                    *Part of the perpetual AI motion machine - autonomous draft-to-ready conversion*" || true
                    
                    # Refresh PR data after marking ready
                    pr_data=$(gh pr view ${pr_num} --json title,body,author,labels,mergeable,state,isDraft)
                    is_draft=$(echo "${pr_data}" | jq -r '.isDraft')
                  else
                    echo "‚ö†Ô∏è Failed to mark PR #${pr_num} as ready"
                  fi
                else
                  echo "PR #${pr_num} does not meet criteria for automatic ready conversion"
                fi
              fi
            fi
            
            # Skip if not open or is still draft
            if [ "${pr_state}" != "OPEN" ] || [ "${is_draft}" = "true" ]; then
              echo "Skipping PR #${pr_num} - not ready (state: ${pr_state}, draft: ${is_draft})"
              continue
            fi
            
            # Only auto-merge if:
            # 1. PR is from the repository owner AND has copilot label, OR
            # 2. PR is from a trusted bot (github-actions, dependabot, copilot)
            should_auto_merge=0
            if [ "${is_repo_owner}" -eq 1 ] && [ "${has_copilot_label}" -gt 0 ]; then
              should_auto_merge=1
              echo "PR #${pr_num} is from repository owner with copilot label, proceeding with auto-review"
            elif [ "${is_trusted_bot}" -eq 1 ] && [ "${has_copilot_label}" -gt 0 ]; then
              should_auto_merge=1
              echo "PR #${pr_num} is from trusted bot with copilot label, proceeding with auto-review"
            fi
            
            if [ "${should_auto_merge}" -eq 1 ]; then
              
              # For bot-created PRs, skip approval (can't approve own PR) and enable auto-merge
              # For owner PRs, add approval review first
              if [ "${is_trusted_bot}" -eq 1 ]; then
                echo "PR #${pr_num} is from trusted bot, skipping approval and enabling auto-merge"
                
                # Add a comment instead of approval
                gh pr comment ${pr_num} --body "ü§ñ **Automated Processing by Copilot**
                
                This PR has been automatically identified for merge.
                
                **Merge Criteria Met:**
                - ‚úÖ Created by trusted automation (${author})
                - ‚úÖ Has copilot label
                - ‚úÖ Part of autonomous development cycle
                
                **Action:** Will attempt to merge automatically
                **Processed by:** Autonomous Review System
                **Timestamp:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')
                
                ---
                *Part of the perpetual AI motion machine - no human review required.*" || true
              else
                # Repository owner PR - add approval review
                gh pr review ${pr_num} --approve --body "ü§ñ **Automated Review by Copilot**
                
                This PR has been automatically reviewed and approved.
                
                **Review Criteria:**
                - ‚úÖ Created by repository owner
                - ‚úÖ Has copilot label
                - ‚úÖ Follows repository patterns
                - ‚úÖ Part of autonomous development cycle
                
                **Status:** Approved for merge
                **Reviewed by:** Autonomous Review System
                **Timestamp:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')
                
                ---
                *Part of the perpetual AI motion machine - no human review required.*"
              fi
              
              # Wait for checks to complete or start (if any)
              sleep 30
              
              # Check if mergeable
              pr_data=$(gh pr view ${pr_num} --json mergeable)
              mergeable=$(echo "${pr_data}" | jq -r '.mergeable')
              
              if [ "${mergeable}" = "MERGEABLE" ]; then
                # Merge the PR (works since no required checks in this repo)
                # For bot PRs, just merge immediately (no approval needed/possible)
                # For owner PRs, approval was already added above
                if gh pr merge ${pr_num} --squash --delete-branch; then
                  echo "‚úÖ PR #${pr_num} merged successfully"
                else
                  # If immediate merge fails, enable auto-merge as fallback
                  # This handles cases where checks might be required in the future
                  if gh pr merge ${pr_num} --auto --squash --delete-branch; then
                    echo "‚úÖ Auto-merge enabled for PR #${pr_num} (will merge when checks pass)"
                  else
                    echo "‚ö†Ô∏è Could not merge or enable auto-merge for PR #${pr_num}"
                    gh pr comment ${pr_num} --body "‚ö†Ô∏è Unable to merge this PR automatically. Please check the PR status and merge manually if needed." || true
                  fi
                fi
                
                echo "‚úÖ PR #${pr_num} processed successfully"
                
                # Check if this is an agent spawn PR
                has_agent_system_label=$(echo "${pr_data}" | jq -r '.labels[].name' | grep -c "agent-system" || true)
                
                if [ "${has_agent_system_label}" -gt 0 ]; then
                  echo "ü§ñ Detected agent spawn PR - checking for linked work issue"
                  
                  # Look for linked issue in PR comments
                  pr_comments=$(gh pr view ${pr_num} --json comments --jq '.comments[].body' || echo "")
                  linked_issue=$(echo "${pr_comments}" | grep -oP 'issue #\K\d+' | head -1 || echo "")
                  
                  if [ -n "${linked_issue}" ]; then
                    echo "üìù Found linked work issue #${linked_issue} for agent spawn PR"
                    
                    # Remove spawn-pending label to unblock assignment
                    echo "üè∑Ô∏è  Removing spawn-pending label from issue #${linked_issue}..."
                    gh issue edit ${linked_issue} --repo ${{ github.repository }} --remove-label "spawn-pending" 2>&1 || echo "‚ö†Ô∏è Could not remove spawn-pending label (may not exist)"
                    
                    # Add comment to the work issue that the spawn is complete
                    gh issue comment ${linked_issue} --body "‚úÖ **Agent Spawn Complete**
                    
                    The agent spawn PR #${pr_num} has been merged! The agent is now active and registered in the system.
                    
                    **Status Update:**
                    - ‚úÖ Spawn PR merged
                    - ‚úÖ Agent is now active
                    - ‚úÖ Removed \`spawn-pending\` label
                    - ‚úÖ This issue is now ready to be worked on
                    
                    **Next Steps:**
                    The Copilot assignment workflow will now assign this issue to GitHub Copilot to begin implementation.
                    
                    **Merged at:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')
                    
                    ---
                    *Agent spawn sequence completed by the auto-review system*" || true
                    
                    echo "‚úÖ Notified work issue #${linked_issue} about spawn completion"
                    
                    # Trigger Copilot assignment now that spawn is complete
                    echo "ü§ñ Triggering Copilot assignment for work issue #${linked_issue}..."
                    
                    # Use workflow_dispatch to trigger copilot assignment for this specific issue
                    if gh workflow run copilot-graphql-assign.yml --repo ${{ github.repository }} -f issue_number="${linked_issue}" 2>&1; then
                      echo "‚úÖ Triggered Copilot assignment workflow for issue #${linked_issue}"
                      
                      # Add a comment to indicate assignment is being processed
                      gh issue comment ${linked_issue} --body "üîÑ **Processing Copilot Assignment**
                      
                      The Copilot assignment workflow has been triggered now that the agent spawn is complete.
                      
                      Copilot will be assigned to this issue shortly (typically within 1-2 minutes).
                      
                      ---
                      *Automated sequence: Spawn PR merged ‚Üí Assignment triggered*" || true
                    else
                      echo "‚ö†Ô∏è Failed to trigger Copilot assignment workflow"
                      
                      # Add a comment with manual instructions
                      gh issue comment ${linked_issue} --body "‚ö†Ô∏è **Assignment Workflow Not Triggered**
                      
                      The agent spawn is complete, but the automatic Copilot assignment workflow could not be triggered.
                      
                      **Manual action needed:**
                      - Wait for the scheduled assignment workflow (runs every 3 hours), OR
                      - Manually trigger the Copilot assignment workflow from the Actions tab, OR  
                      - Manually assign Copilot from the issue sidebar
                      
                      ---
                      *The scheduled assignment workflow will pick this up automatically.*" || true
                    fi
                  else
                    echo "‚ÑπÔ∏è No linked work issue found in PR comments"
                  fi
                fi
                
                # Close related issue if exists (for non-agent-spawn PRs)
                pr_body=$(gh pr view ${pr_num} --json body --jq '.body' || echo "")
                issue_numbers=$(echo "${pr_body}" | grep -oP '(?<=#)\d+' || echo "")
                
                for issue_num in ${issue_numbers}; do
                  if [ -n "${issue_num}" ]; then
                    echo "Closing issue #${issue_num} as completed by PR #${pr_num}"
                    
                    gh issue close ${issue_num} --comment "‚úÖ **Completed**
                    
                    This issue has been completed and merged via PR #${pr_num}.
                    
                    **Merged at:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')
                    
                    ---
                    *Automatically closed by the auto-review system*" || true
                    
                    gh issue edit ${issue_num} --add-label "completed" || true
                  fi
                done
              else
                echo "‚ö†Ô∏è PR #${pr_num} is not mergeable (status: ${mergeable})"
                gh pr comment ${pr_num} --body "‚ö†Ô∏è This PR is not currently mergeable. Status: ${mergeable}
                
                Please check for conflicts or failing checks." || true
              fi
            else
              echo "‚ö†Ô∏è Skipping PR #${pr_num} - not authorized for auto-merge"
              echo "Author: ${author}, Owner: ${repo_owner}, Trusted Bot: ${is_trusted_bot}, Copilot Label: ${has_copilot_label}"
              
              # Add a comment explaining why it wasn't auto-merged
              gh pr comment ${pr_num} --body "‚ö†Ô∏è **Manual Review Required**
              
              This PR was not automatically merged because it does not meet the criteria for autonomous merge.
              
              **Auto-merge criteria:**
              - PR must be from the repository owner (\`${repo_owner}\`) AND have the \`copilot\` label, OR
              - PR must be from a trusted bot (\`github-actions[bot]\`, \`app/github-actions\`, \`dependabot[bot]\`, \`app/dependabot\`, \`copilot*[bot]\`) AND have the \`copilot\` label
              
              **Current PR details:**
              - Author: \`${author}\`
              - Has copilot label: $([ "${has_copilot_label}" -gt 0 ] && echo "‚úÖ Yes" || echo "‚ùå No")
              - From repository owner: $([ "${is_repo_owner}" -eq 1 ] && echo "‚úÖ Yes" || echo "‚ùå No")
              - From trusted bot: $([ "${is_trusted_bot}" -eq 1 ] && echo "‚úÖ Yes" || echo "‚ùå No")
              
              **Next steps:**
              The repository owner will need to manually review and approve this PR before it can be merged.
              
              ---
              *Automated security check by the Auto Review and Merge workflow*" || true
            fi
          done

      - name: Log review activity
        run: |
          echo "Auto-review and merge process completed"
          echo "Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
