name: "Automation: Auto Review & Merge (Improved)"

# This workflow combines auto-review, tech lead review, and auto-merge into a single,
# maintainable workflow with clear stages. It replaces the fragile tech-lead-review system.

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'learnings/**'
      - 'analysis/**'
  pull_request_review:
    types: [submitted]
  schedule:
    # Run every 15 minutes to sweep and check all PRs
    - cron: '*/15 * * * *'
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to review and merge'
        required: false
        type: string

concurrency:
  group: ${{ github.event_name == 'schedule' && 'auto-review-scheduled' || format('auto-review-pr-{0}', github.event.pull_request.number || inputs.pr_number) }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write
  issues: write
  checks: read

jobs:
  # Stage 1: Analyze PRs and determine which need tech lead review
  analyze-prs:
    runs-on: ubuntu-latest
    outputs:
      pr_matrix: ${{ steps.build_matrix.outputs.pr_matrix }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Get PRs to process
        id: get_prs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ inputs.pr_number }}" ]; then
            pr_numbers="${{ inputs.pr_number }}"
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            pr_numbers="${{ github.event.pull_request.number }}"
          elif [ "${{ github.event_name }}" = "pull_request_review" ]; then
            pr_numbers="${{ github.event.pull_request.number }}"
          else
            # Scheduled run - get all open, non-draft PRs
            pr_numbers=$(gh pr list --state open --json number,isDraft --jq '.[] | select(.isDraft == false) | .number' | tr '\n' ' ')
          fi
          
          echo "pr_numbers=${pr_numbers}" >> $GITHUB_OUTPUT
          echo "Found PRs to process: ${pr_numbers}"

      - name: Build PR matrix with tech lead analysis
        id: build_matrix
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          pr_numbers="${{ steps.get_prs.outputs.pr_numbers }}"
          
          if [ -z "${pr_numbers}" ]; then
            echo "No PRs to process"
            echo 'pr_matrix={"include":[]}' >> $GITHUB_OUTPUT
            exit 0
          fi
          
          matrix_items='[]'
          
          for pr_num in ${pr_numbers}; do
            echo "Analyzing PR #${pr_num}..."
            
            # Get PR details
            pr_data=$(gh pr view ${pr_num} --json number,title,state,isDraft,author,labels)
            pr_state=$(echo "${pr_data}" | jq -r '.state')
            is_draft=$(echo "${pr_data}" | jq -r '.isDraft')
            pr_title=$(echo "${pr_data}" | jq -r '.title')
            author=$(echo "${pr_data}" | jq -r '.author.login')
            
            # Skip closed or draft PRs
            if [ "${pr_state}" != "OPEN" ] || [ "${is_draft}" = "true" ]; then
              echo "Skipping PR #${pr_num} (state: ${pr_state}, draft: ${is_draft})"
              continue
            fi
            
            # Check for WIP in title
            has_wip="false"
            if echo "${pr_title}" | grep -qiE '\[WIP\]|^WIP:|WIP\s|work.in.progress|\[do.not.merge\]|\[dnm\]'; then
              has_wip="true"
              echo "PR #${pr_num} has WIP marker"
            fi
            
            # Run tech lead analysis
            tech_lead_result=$(python3 tools/match-pr-to-tech-lead.py "${pr_num}" --check-complexity 2>/dev/null || echo '{"tech_leads":[],"complexity":{"requires_review":false}}')
            
            requires_tech_lead=$(echo "${tech_lead_result}" | jq -r '.complexity.requires_review // false')
            tech_leads=$(echo "${tech_lead_result}" | jq -r '.tech_leads[].name' | tr '\n' ',' | sed 's/,$//')
            
            # Check current labels
            has_copilot_label=$(echo "${pr_data}" | jq -r '.labels[].name' | grep -c "copilot" || echo "0")
            has_tech_lead_approved=$(echo "${pr_data}" | jq -r '.labels[].name' | grep -c "tech-lead-approved" || echo "0")
            has_needs_tech_lead=$(echo "${pr_data}" | jq -r '.labels[].name' | grep -c "needs-tech-lead-review" || echo "0")
            has_changes_requested=$(echo "${pr_data}" | jq -r '.labels[].name' | grep -c "tech-lead-changes-requested" || echo "0")
            
            # Build matrix item
            item=$(jq -n \
              --arg pr "$pr_num" \
              --arg title "$pr_title" \
              --arg author "$author" \
              --arg has_wip "$has_wip" \
              --arg requires_tech_lead "$requires_tech_lead" \
              --arg tech_leads "$tech_leads" \
              --arg has_copilot "$has_copilot_label" \
              --arg has_approved "$has_tech_lead_approved" \
              --arg has_needs "$has_needs_tech_lead" \
              --arg has_changes "$has_changes_requested" \
              '{
                pr: $pr,
                title: $title,
                author: $author,
                has_wip: ($has_wip == "true"),
                requires_tech_lead: ($requires_tech_lead == "true"),
                tech_leads: $tech_leads,
                has_copilot_label: ($has_copilot != "0"),
                has_tech_lead_approved: ($has_approved != "0"),
                needs_tech_lead_review: ($has_needs != "0"),
                tech_lead_changes_requested: ($has_changes != "0")
              }')
            
            matrix_items=$(echo "${matrix_items}" | jq --argjson item "${item}" '. + [$item]')
          done
          
          matrix=$(jq -n --argjson items "${matrix_items}" '{"include": $items}')
          echo "pr_matrix=${matrix}" >> $GITHUB_OUTPUT
          echo "Built matrix with $(echo "${matrix}" | jq '.include | length') PRs"

  # Stage 2: Process each PR (tech lead review, labels, feedback)
  process-pr:
    needs: analyze-prs
    if: needs.analyze-prs.outputs.pr_matrix != '{"include":[]}'
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.analyze-prs.outputs.pr_matrix) }}
      fail-fast: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Label Copilot PR
        if: contains(matrix.author, 'copilot') || contains(matrix.author, 'Copilot')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ matrix.has_copilot_label }}" = "false" ]; then
            echo "Adding copilot label to PR #${{ matrix.pr }}"
            gh pr edit ${{ matrix.pr }} --add-label "copilot" --repo ${{ github.repository }}
          fi

      - name: Skip WIP PRs
        if: matrix.has_wip
        run: |
          echo "‚ö†Ô∏è PR #${{ matrix.pr }} has WIP marker - skipping all processing"
          echo "Remove WIP markers to enable auto-review and tech lead review"

      - name: Apply tech lead labels and analysis
        if: ${{ !matrix.has_wip && matrix.requires_tech_lead && matrix.tech_leads != '' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          pr_num="${{ matrix.pr }}"
          tech_leads="${{ matrix.tech_leads }}"
          
          echo "PR #${pr_num} requires tech lead review"
          echo "Tech Leads: ${tech_leads}"
          
          # Add tech-lead identifier labels
          IFS=',' read -ra LEADS <<< "${tech_leads}"
          for lead in "${LEADS[@]}"; do
            if [ -n "${lead}" ]; then
              echo "Adding label: tech-lead:${lead}"
              gh pr edit ${pr_num} --add-label "tech-lead:${lead}" --repo ${{ github.repository }} || true
            fi
          done
          
          # Add needs-tech-lead-review label if not already approved
          if [ "${{ matrix.has_tech_lead_approved }}" = "false" ]; then
            echo "Adding needs-tech-lead-review label"
            gh pr edit ${pr_num} --add-label "needs-tech-lead-review" --repo ${{ github.repository }} || true
            gh pr edit ${pr_num} --add-label "tech-lead-review-cycle" --repo ${{ github.repository }} || true
          fi

      - name: Post initial tech lead analysis comment
        if: ${{ !matrix.has_wip && matrix.requires_tech_lead && matrix.tech_leads != '' && github.event_name != 'schedule' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          pr_num="${{ matrix.pr }}"
          tech_leads="${{ matrix.tech_leads }}"
          
          # Only post if this is a new event (not scheduled sweep)
          # Check if we already posted a comment
          existing_comment=$(gh pr view ${pr_num} --json comments --jq '.comments[] | select(.body | contains("Tech Lead Review Analysis")) | .id' | head -1 || echo "")
          
          if [ -n "${existing_comment}" ]; then
            echo "Already posted tech lead analysis comment"
            exit 0
          fi
          
          primary_lead=$(echo "${tech_leads}" | cut -d',' -f1)
          
          gh pr comment ${pr_num} --body "## üîí Tech Lead Review Required
          
          This PR requires Tech Lead review before it can be merged.
          
          **Assigned Tech Lead:** @${primary_lead}
          
          **Tech Leads Identified:** ${tech_leads}
          
          **Next Steps:**
          1. Tech Lead will review the changes
          2. If approved, the \`tech-lead-approved\` label will be added
          3. If changes are needed, the \`tech-lead-changes-requested\` label will be added
          4. Once approved, auto-merge will proceed automatically
          
          **Review Criteria:**
          - Modified protected paths (.github/workflows/, .github/agents/, etc.)
          - Security-related changes
          - Large number of changes
          - Multiple subsystems affected
          
          ---
          *ü§ñ Automated Tech Lead Review System*
          *Managed by @workflows-tech-lead*" --repo ${{ github.repository }} || true

      - name: Handle tech lead review state changes
        if: ${{ !matrix.has_wip && github.event_name == 'pull_request_review' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          pr_num="${{ matrix.pr }}"
          
          echo "Processing review state change for PR #${pr_num}"
          
          # Get recent reviews
          reviews=$(gh api /repos/${{ github.repository }}/pulls/${pr_num}/reviews \
            --jq '.[] | select(.state == "APPROVED" or .state == "CHANGES_REQUESTED") | {user: .user.login, state: .state, id: .id}' \
            | jq -s 'sort_by(.id) | reverse | .[0]' || echo "")
          
          if [ -z "$reviews" ] || [ "$reviews" = "null" ]; then
            echo "No recent reviews found"
            exit 0
          fi
          
          review_state=$(echo "$reviews" | jq -r '.state')
          reviewer=$(echo "$reviews" | jq -r '.user')
          
          echo "Latest review: ${review_state} by ${reviewer}"
          
          if [ "${review_state}" = "APPROVED" ] && [ "${{ matrix.needs_tech_lead_review }}" = "true" ]; then
            echo "Tech Lead approval detected - updating labels"
            
            gh pr edit ${pr_num} --remove-label "needs-tech-lead-review" --repo ${{ github.repository }} 2>/dev/null || true
            gh pr edit ${pr_num} --remove-label "tech-lead-changes-requested" --repo ${{ github.repository }} 2>/dev/null || true
            gh pr edit ${pr_num} --add-label "tech-lead-approved" --repo ${{ github.repository }} || true
            
            gh pr comment ${pr_num} --body "‚úÖ **Tech Lead Approval Received**
            
            This PR has been approved by a Tech Lead reviewer!
            
            **Status Changes:**
            - ‚ùå Removed \`needs-tech-lead-review\` label
            - ‚úÖ Added \`tech-lead-approved\` label
            
            **Next Steps:**
            This PR is now eligible for auto-merge if all other criteria are met.
            
            ---
            *Tech Lead review cycle completed by @workflows-tech-lead*" --repo ${{ github.repository }} || true
            
          elif [ "${review_state}" = "CHANGES_REQUESTED" ]; then
            echo "Tech Lead change requests detected"
            
            gh pr edit ${pr_num} --add-label "tech-lead-changes-requested" --repo ${{ github.repository }} || true
            gh pr edit ${pr_num} --add-label "needs-tech-lead-review" --repo ${{ github.repository }} || true
            
            # Store review body for potential agent follow-up
            review_body=$(gh api /repos/${{ github.repository }}/pulls/${pr_num}/reviews \
              --jq '.[] | select(.state == "CHANGES_REQUESTED") | .body' | tail -1)
            
            # Create follow-up issue for agent to fix (if review has actionable feedback)
            if [ -n "$review_body" ] && [ "$review_body" != "null" ]; then
              echo "Creating follow-up issue for agent..."
              
              # Match feedback to appropriate agent
              agent_match=$(python3 tools/match-issue-to-agent.py \
                "Fix tech lead feedback for PR #${pr_num}" \
                "${review_body}" \
                2>/dev/null || echo '{"agent":"create-guru","emoji":"üèóÔ∏è"}')
              
              matched_agent=$(echo "$agent_match" | jq -r '.agent')
              agent_emoji=$(echo "$agent_match" | jq -r '.emoji')
              
              # Create follow-up issue with heredoc
              gh issue create \
                --repo ${{ github.repository }} \
                --title "[Tech Lead Feedback] Address review comments for PR #${pr_num}" \
                --body "**Agent:** @${matched_agent} | **Feedback:** See PR #${pr_num} review comments | **Action:** Address tech lead feedback and push changes" \
                --label "tech-lead-feedback,agent:${matched_agent},linked-to-pr" \
                --assignee copilot || echo "Could not create follow-up issue"
            fi
            
            gh pr comment ${pr_num} --body "üîÑ **Tech Lead Requested Changes**
            
            A Tech Lead has requested changes to this PR.
            
            **Status Changes:**
            - ‚úÖ Added \`tech-lead-changes-requested\` label (blocks merge)
            - ‚úÖ Maintained \`needs-tech-lead-review\` label
            
            **Next Steps:**
            1. Address the feedback comments
            2. Push changes to the PR branch
            3. Request re-review from the Tech Lead
            
            ---
            *Tech Lead review cycle managed by @workflows-tech-lead*" --repo ${{ github.repository }} || true
          fi

  # Stage 3: Auto-merge (runs after processing)
  auto-merge:
    needs: [analyze-prs, process-pr]
    if: always() && needs.analyze-prs.outputs.pr_matrix != '{"include":[]}'
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.analyze-prs.outputs.pr_matrix) }}
      fail-fast: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Refresh PR state
        id: refresh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          pr_num="${{ matrix.pr }}"
          
          # Get fresh PR data after processing
          pr_data=$(gh pr view ${pr_num} --json state,isDraft,mergeable,author,labels,title)
          pr_state=$(echo "${pr_data}" | jq -r '.state')
          is_draft=$(echo "${pr_data}" | jq -r '.isDraft')
          mergeable=$(echo "${pr_data}" | jq -r '.mergeable')
          author=$(echo "${pr_data}" | jq -r '.author.login')
          pr_title=$(echo "${pr_data}" | jq -r '.title')
          
          # Check labels
          has_copilot=$(echo "${pr_data}" | jq -r '.labels[].name' | grep -c "copilot" || echo "0")
          has_needs_tech_lead=$(echo "${pr_data}" | jq -r '.labels[].name' | grep -c "needs-tech-lead-review" || echo "0")
          has_tech_lead_approved=$(echo "${pr_data}" | jq -r '.labels[].name' | grep -c "tech-lead-approved" || echo "0")
          has_changes_requested=$(echo "${pr_data}" | jq -r '.labels[].name' | grep -c "tech-lead-changes-requested" || echo "0")
          
          echo "pr_state=${pr_state}" >> $GITHUB_OUTPUT
          echo "is_draft=${is_draft}" >> $GITHUB_OUTPUT
          echo "mergeable=${mergeable}" >> $GITHUB_OUTPUT
          echo "author=${author}" >> $GITHUB_OUTPUT
          echo "pr_title=${pr_title}" >> $GITHUB_OUTPUT
          echo "has_copilot=${has_copilot}" >> $GITHUB_OUTPUT
          echo "has_needs_tech_lead=${has_needs_tech_lead}" >> $GITHUB_OUTPUT
          echo "has_tech_lead_approved=${has_tech_lead_approved}" >> $GITHUB_OUTPUT
          echo "has_changes_requested=${has_changes_requested}" >> $GITHUB_OUTPUT

      - name: Check merge eligibility
        id: check_merge
        run: |
          pr_num="${{ matrix.pr }}"
          pr_state="${{ steps.refresh.outputs.pr_state }}"
          is_draft="${{ steps.refresh.outputs.is_draft }}"
          author="${{ steps.refresh.outputs.author }}"
          has_copilot="${{ steps.refresh.outputs.has_copilot }}"
          has_needs_tech_lead="${{ steps.refresh.outputs.has_needs_tech_lead }}"
          has_tech_lead_approved="${{ steps.refresh.outputs.has_tech_lead_approved }}"
          has_changes_requested="${{ steps.refresh.outputs.has_changes_requested }}"
          
          # Skip if not open or still draft
          if [ "${pr_state}" != "OPEN" ] || [ "${is_draft}" = "true" ]; then
            echo "eligible=false" >> $GITHUB_OUTPUT
            echo "reason=PR not ready (state: ${pr_state}, draft: ${is_draft})" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check if from trusted source
          repo_owner="${{ github.repository_owner }}"
          is_trusted=false
          
          if [ "${author}" = "${repo_owner}" ] && [ "${has_copilot}" != "0" ]; then
            is_trusted=true
          elif echo "${author}" | grep -qiE "^(github-actions\[bot\]|app/github-actions|dependabot\[bot\]|app/dependabot|app/copilot|copilot)"; then
            if [ "${has_copilot}" != "0" ]; then
              is_trusted=true
            fi
          fi
          
          if [ "${is_trusted}" = "false" ]; then
            echo "eligible=false" >> $GITHUB_OUTPUT
            echo "reason=Not from trusted source (author: ${author}, copilot label: ${has_copilot})" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check tech lead review status
          if [ "${has_needs_tech_lead}" != "0" ] && [ "${has_tech_lead_approved}" = "0" ]; then
            echo "eligible=false" >> $GITHUB_OUTPUT
            echo "reason=Tech Lead review required but not yet approved" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          if [ "${has_changes_requested}" != "0" ]; then
            echo "eligible=false" >> $GITHUB_OUTPUT
            echo "reason=Tech Lead requested changes" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "eligible=true" >> $GITHUB_OUTPUT
          echo "reason=All criteria met" >> $GITHUB_OUTPUT

      - name: Merge PR
        if: steps.check_merge.outputs.eligible == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          pr_num="${{ matrix.pr }}"
          author="${{ steps.refresh.outputs.author }}"
          mergeable="${{ steps.refresh.outputs.mergeable }}"
          
          echo "‚úÖ PR #${pr_num} is eligible for auto-merge"
          echo "Reason: ${{ steps.check_merge.outputs.reason }}"
          
          # For bot PRs, add comment instead of approval (can't approve own PR)
          # For owner PRs, add approval review
          if echo "${author}" | grep -qiE "^(github-actions|dependabot|copilot|app/)"; then
            gh pr comment ${pr_num} --body "ü§ñ **Automated Processing**
            
            This PR meets all criteria for auto-merge.
            
            **Merge Criteria Met:**
            - ‚úÖ From trusted automation (${author})
            - ‚úÖ Has copilot label
            - ‚úÖ Tech Lead review: ${{ matrix.has_tech_lead_approved == true && 'Approved' || 'Not required' }}
            
            **Action:** Merging automatically
            
            ---
            *Auto-merge system - no human review required*" --repo ${{ github.repository }} || true
          else
            gh pr review ${pr_num} --approve --body "ü§ñ **Automated Review**
            
            This PR has been automatically reviewed and approved.
            
            **Review Criteria:**
            - ‚úÖ From repository owner
            - ‚úÖ Has copilot label
            - ‚úÖ Tech Lead review: ${{ matrix.has_tech_lead_approved == true && 'Approved' || 'Not required' }}
            
            **Status:** Approved for merge
            
            ---
            *Auto-review system*" --repo ${{ github.repository }}
          fi
          
          sleep 5
          
          # Attempt merge
          if [ "${mergeable}" = "MERGEABLE" ]; then
            if gh pr merge ${pr_num} --squash --delete-branch --repo ${{ github.repository }}; then
              echo "‚úÖ PR #${pr_num} merged successfully"
            else
              # Fallback to auto-merge
              if gh pr merge ${pr_num} --auto --squash --delete-branch --repo ${{ github.repository }}; then
                echo "‚úÖ Auto-merge enabled for PR #${pr_num}"
              else
                echo "‚ö†Ô∏è Could not merge PR #${pr_num}"
                gh pr comment ${pr_num} --body "‚ö†Ô∏è Unable to merge this PR automatically. Please check the PR status and merge manually if needed." --repo ${{ github.repository }} || true
              fi
            fi
          else
            echo "‚ö†Ô∏è PR #${pr_num} is not mergeable (status: ${mergeable})"
            gh pr comment ${pr_num} --body "‚ö†Ô∏è This PR is not currently mergeable. Status: ${mergeable}. Please check for conflicts or failing checks." --repo ${{ github.repository }} || true
          fi

      - name: Log ineligible PR
        if: steps.check_merge.outputs.eligible == 'false'
        run: |
          echo "‚è∏Ô∏è PR #${{ matrix.pr }} not eligible for auto-merge"
          echo "Reason: ${{ steps.check_merge.outputs.reason }}"
