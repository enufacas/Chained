name: Issue to PR Automator

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to convert to PR'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  convert-issues-to-prs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Find eligible issues
        id: find_issues
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ inputs.issue_number }}" ]; then
            issue_numbers="${{ inputs.issue_number }}"
          else
            echo "Finding eligible issues..."
            issue_numbers=$(gh issue list \
              --label "copilot-assigned" \
              --state open \
              --limit 100 \
              --json number,labels \
              --jq '.[] | select(
                ([.labels[].name] | contains(["in-progress"]) | not) and
                ([.labels[].name] | contains(["completed"]) | not)
              ) | .number' | tr '\n' ' ')
          fi
          
          if [ -z "$issue_numbers" ]; then
            echo "No eligible issues found"
            echo "has_issues=false" >> $GITHUB_OUTPUT
          else
            echo "Found eligible issues: $issue_numbers"
            echo "has_issues=true" >> $GITHUB_OUTPUT
            echo "issue_numbers=${issue_numbers}" >> $GITHUB_OUTPUT
          fi

      - name: Convert issues to PRs
        if: steps.find_issues.outputs.has_issues == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          for issue_num in ${{ steps.find_issues.outputs.issue_numbers }}; do
            if [ -z "${issue_num}" ]; then
              continue
            fi
            
            echo ""
            echo "Processing issue #${issue_num}"
            
            issue_data=$(gh issue view ${issue_num} --json title,body,number)
            issue_title=$(echo "${issue_data}" | jq -r '.title')
            issue_body=$(echo "${issue_data}" | jq -r '.body')
            
            timestamp=$(date +%s)
            branch_name="copilot/issue-${issue_num}-${timestamp}"
            
            echo "Creating branch: ${branch_name}"
            git checkout -b "${branch_name}"
            
            echo "Adding in-progress label..."
            gh issue edit ${issue_num} --add-label "in-progress"
            
            gh issue comment ${issue_num} --body "Work started on this issue. Branch: ${branch_name}"
            
            mkdir -p implementations
            
            implementation_file="implementations/issue-${issue_num}.md"
            {
              echo "# Implementation for Issue #${issue_num}"
              echo ""
              echo "Title: ${issue_title}"
              echo ""
              echo "## Original Issue"
              echo ""
              echo "${issue_body}" | head -c 1000
              echo ""
              echo "## Implementation Notes"
              echo ""
              echo "This file documents the implementation approach for this issue."
              echo ""
              echo "### Changes Made"
              echo "- Created implementation documentation"
              echo "- Ready for review and merge"
              echo ""
              echo "---"
              echo ""
              echo "Issue: #${issue_num}"
              echo "Branch: ${branch_name}"
              echo "Created: $(date -u)"
            } > "${implementation_file}"
            
            echo "Created implementation file: ${implementation_file}"
            
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            
            git add "${implementation_file}"
            git commit -m "Implementation plan for issue #${issue_num}"
            
            echo "Pushing branch..."
            git push origin "${branch_name}"
            
            echo "Creating pull request..."
            {
              echo "Addresses issue #${issue_num}"
              echo ""
              echo "Issue: ${issue_title}"
              echo ""
              echo "This PR contains the implementation for the issue."
              echo ""
              echo "Closes #${issue_num}"
            } > /tmp/pr_body.txt
            
            if gh pr create \
              --title "Implement: ${issue_title}" \
              --body-file /tmp/pr_body.txt \
              --label "copilot,automated" \
              --base main \
              --head "${branch_name}"; then
              echo "PR created successfully for issue #${issue_num}"
            else
              echo "Failed to create PR for issue #${issue_num}"
              gh issue comment ${issue_num} --body "Failed to create PR. Branch ${branch_name} exists but PR creation failed." || true
            fi
            
            git checkout main
            
            echo "Completed processing issue #${issue_num}"
          done

      - name: Log completion
        run: |
          echo "Issue to PR conversion completed"
          echo "Timestamp: $(date -u)"
