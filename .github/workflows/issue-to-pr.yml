name: Issue to PR Automator

on:
  schedule:
    # Run every 30 minutes to check for issues ready to be worked on
    - cron: '*/30 * * * *'
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to convert to PR'
        required: false
        type: number

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  convert-issue-to-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get issues ready for work
        id: get_issues
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ inputs.issue_number }}" ]; then
            # Specific issue requested
            issue_numbers="${{ inputs.issue_number }}"
          else
            # Get issues with copilot-assigned label that don't have 'in-progress' or 'completed'
            issue_numbers=$(gh issue list --label "copilot-assigned" --state open --json number,labels \
              --jq '.[] | select((.labels | map(.name) | contains(["in-progress"]) | not) and (.labels | map(.name) | contains(["completed"]) | not)) | .number' \
              | head -3 | tr '\n' ' ')
          fi
          
          echo "issue_numbers=${issue_numbers}" >> $GITHUB_OUTPUT
          echo "Found issues to work on: ${issue_numbers}"

      - name: Ensure required labels exist
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Ensuring required labels exist..."
          
          # Check and create 'copilot' label if it doesn't exist
          if ! gh label list | grep -q "^copilot"; then
            echo "Creating 'copilot' label..."
            gh label create "copilot" --color "0366d6" --description "Created by Copilot" || echo "Label may already exist"
          else
            echo "âœ“ Label 'copilot' exists"
          fi
          
          # Check and create 'automated' label if it doesn't exist
          if ! gh label list | grep -q "^automated"; then
            echo "Creating 'automated' label..."
            gh label create "automated" --color "fbca04" --description "Automated process" || echo "Label may already exist"
          else
            echo "âœ“ Label 'automated' exists"
          fi

      - name: Process issues
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          for issue_num in ${{ steps.get_issues.outputs.issue_numbers }}; do
            if [ -z "${issue_num}" ]; then
              continue
            fi
            
            echo "Processing issue #${issue_num}"
            
            # Get issue details
            issue_data=$(gh issue view ${issue_num} --json title,body,labels)
            issue_title=$(echo "${issue_data}" | jq -r '.title')
            issue_body=$(echo "${issue_data}" | jq -r '.body')
            
            # Mark issue as in-progress
            gh issue edit ${issue_num} --add-label "in-progress"
            gh issue comment ${issue_num} --body "ðŸš§ **Work Started**
            
            Copilot is now working on this issue. A PR will be created shortly.
            
            **Started at:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
            
            ---
            *Automated by the Issue to PR Automator*"
            
            # Create a branch for this issue
            branch_name="copilot/issue-${issue_num}-$(date +%s)"
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git checkout -b "${branch_name}"
            
            # Create a task specification file for Copilot to work with
            mkdir -p .copilot
            cat > ".copilot/task-${issue_num}.md" << EOF
          # Task Specification for Issue #${issue_num}
          
          ## Issue Title
          ${issue_title}
          
          ## Issue Description
          ${issue_body}
          
          ## Instructions for GitHub Copilot
          
          This PR is ready for implementation. Please analyze the issue above and:
          
          1. Understand the requirements from the issue description
          2. Implement the necessary code changes
          3. Add or update tests as appropriate
          4. Update documentation if needed
          5. Ensure the implementation follows repository patterns
          
          ## Context
          
          - **Issue Number:** #${issue_num}
          - **Repository:** ${{ github.repository }}
          - **Branch:** ${branch_name}
          - **Created:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          ## Expected Outcome
          
          A working implementation that fully addresses the issue requirements.
          EOF
            
            # Create an empty commit to initialize the branch for Copilot to work on
            git add .copilot/
            git commit -m "Initialize branch for Copilot to implement issue #${issue_num}: ${issue_title}" \
              -m "This PR is ready for GitHub Copilot to implement the solution." \
              -m "Issue: #${issue_num}" \
              -m "Task specification: .copilot/task-${issue_num}.md" \
              -m "@github-copilot please analyze the issue and implement the necessary changes."
            git push origin "${branch_name}"
            
            # Create PR for Copilot to work on
            pr_url=$(gh pr create \
              --title "ðŸ¤– [Ready for Copilot] ${issue_title}" \
              --body "## ðŸ”§ Implementation Request for GitHub Copilot
            
            This PR has been created for GitHub Copilot to implement the solution for issue #${issue_num}.
            
            ### ðŸ“‹ Issue Details
            
            **Original Issue:** Closes #${issue_num}
            **Title:** ${issue_title}
            
            **Issue Description:**
            ${issue_body}
            
            ### ðŸŽ¯ Task for Copilot
            
            @github-copilot Please implement this feature by:
            
            1. ðŸ“– **Analyzing** the issue requirements in detail
            2. ðŸ’» **Implementing** the necessary code changes
            3. âœ… **Testing** the implementation (add tests if appropriate)
            4. ðŸ“ **Documenting** any new functionality
            5. ðŸ” **Reviewing** for best practices and patterns
            
            ### ðŸ“‚ Task Specification
            
            See \`.copilot/task-${issue_num}.md\` for detailed task specification and context.
            
            ### ðŸš€ What Happens Next
            
            1. GitHub Copilot will analyze this PR and the linked issue
            2. Copilot will implement the necessary changes
            3. The auto-review system will review and merge the PR
            4. The original issue will be automatically closed
            
            ### âš™ï¸ Automation Status
            
            - âœ… Branch created: \`${branch_name}\`
            - âœ… Task specification prepared
            - âœ… PR created and ready
            - ðŸ”„ Awaiting Copilot implementation
            
            **Created:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
            
            ---
            
            *ðŸ¤– Generated by the Issue to PR Automator workflow - Part of the perpetual AI motion machine*" \
              --label "copilot,automated" \
              --base main \
              --head "${branch_name}")
            
            echo "Created PR: ${pr_url}"
            
            # Extract PR number from URL
            pr_number=$(echo "${pr_url}" | grep -oP '\d+$')
            
            # Request Copilot to work on this PR by adding a comment that triggers it  
            gh pr comment ${pr_number} --body "ðŸ¤– Copilot Implementation Request - GitHub Copilot, please help implement this feature. Analyze issue #${issue_num} and implement the necessary changes. Task specification: .copilot/task-${issue_num}.md"
            
            # Also trigger Copilot through repository dispatch (if available)
            # This creates a webhook event that Copilot can listen to
            gh api repos/${{ github.repository }}/dispatches \
              -f event_type="copilot_work_request" \
              -f client_payload[pr_number]="${pr_number}" \
              -f client_payload[issue_number]="${issue_num}" \
              -f client_payload[title]="${issue_title}" \
              2>/dev/null || echo "Note: repository_dispatch not available, relying on @mention"
            
            # Comment back on the issue
            gh issue comment ${issue_num} --body "ðŸš€ **PR Created and Copilot Requested**
            
            A pull request has been created and GitHub Copilot has been requested to implement the solution.
            
            **PR:** ${pr_url}
            **Branch:** \`${branch_name}\`
            **Status:** ðŸ”„ Awaiting Copilot implementation
            
            ### What's Next?
            
            1. âœ… PR created with task specification
            2. âœ… GitHub Copilot has been mentioned and requested to work
            3. ðŸ”„ Copilot will analyze the issue and implement the solution
            4. ðŸ”„ Once implemented, auto-review will validate and merge
            5. âœ… Issue will be automatically closed when PR is merged
            
            **Created at:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
            
            ---
            
            *ðŸ¤– Part of the perpetual AI motion machine - Copilot will handle the actual implementation*"
            
            # Return to main branch for next issue
            git checkout main
            
            # Small delay between issues
            sleep 5
          done

      - name: Log activity
        run: |
          echo "Issue to PR conversion completed"
          echo "Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
