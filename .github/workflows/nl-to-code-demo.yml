name: "NL to Code Translation Demo"

# This workflow demonstrates the Natural Language to Code Translator
# Created by @investigate-champion
#
# Triggers when an issue is labeled with 'translate-to-code'
# Analyzes the issue and posts a comment with the generated code

on:
  issues:
    types: [labeled]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to translate'
        required: true
        type: number

permissions:
  issues: write
  contents: read

jobs:
  translate-issue:
    runs-on: ubuntu-latest
    # Only run if issue was labeled with 'translate-to-code' or via workflow_dispatch
    if: |
      (github.event_name == 'issues' && github.event.label.name == 'translate-to-code') ||
      github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: Get issue details
        id: issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            issue_number="${{ inputs.issue_number }}"
          else
            issue_number="${{ github.event.issue.number }}"
          fi
          
          echo "issue_number=$issue_number" >> $GITHUB_OUTPUT
          
          # Get issue body
          issue_body=$(gh issue view "$issue_number" --json body --jq '.body')
          
          # Save to file for processing
          echo "$issue_body" > /tmp/issue_body.txt
          
          echo "Issue $issue_number will be translated"
      
      - name: Translate issue to code
        id: translate
        run: |
          # Run the translator
          python3 tools/nl-to-code-translator.py /tmp/issue_body.txt --json > /tmp/translation.json
          
          # Extract key information
          intent=$(python3 -c "import json; data=json.load(open('/tmp/translation.json')); print(data['intent'])")
          confidence=$(python3 -c "import json; data=json.load(open('/tmp/translation.json')); print(data['confidence'])")
          entity_count=$(python3 -c "import json; data=json.load(open('/tmp/translation.json')); print(data['metadata']['entity_count'])")
          
          echo "intent=$intent" >> $GITHUB_OUTPUT
          echo "confidence=$confidence" >> $GITHUB_OUTPUT
          echo "entity_count=$entity_count" >> $GITHUB_OUTPUT
          
          echo "Translation complete: intent=$intent, confidence=$confidence"
      
      - name: Format results
        id: format
        run: |
          python3 << 'PYTHON_SCRIPT'
          import json
          import sys
          
          # Load translation result
          with open('/tmp/translation.json', 'r') as f:
              result = json.load(f)
          
          # Format entities
          entities_md = ""
          if result['entities']:
              entities_md = "\n### ðŸ” Extracted Entities\n\n"
              for entity in result['entities']:
                  entities_md += f"- **{entity['type']}**: `{entity['name']}` (confidence: {entity['confidence']:.2f})\n"
          
          # Format file suggestions
          files_md = ""
          if result['file_suggestions']:
              files_md = "\n### ðŸ“ Suggested Files\n\n"
              for file in result['file_suggestions']:
                  files_md += f"- `{file}`\n"
          
          # Format implementation plan
          plan_md = "\n### ðŸ—ºï¸ Implementation Plan\n\n"
          for i, step in enumerate(result['implementation_plan'], 1):
              plan_md += f"{i}. {step}\n"
          
          # Format code template
          template_md = f"\n### ðŸ“ Generated Code Template\n\n```python\n{result['code_template']}\n```\n"
          
          # Complete comment - build dynamically to avoid YAML parsing issues
          agent_mention = "@" + "investigate-champion"
          comment_header = f"## ðŸ¤– Natural Language to Code Translation\n\n"
          comment_header += f"**{agent_mention}** has analyzed this issue and generated the following translation:\n\n"
          
          comment_body = f"### ðŸŽ¯ Detected Intent\n\n"
          comment_body += f"**{result['intent'].upper()}** (confidence: {result['confidence']:.2%})\n\n"
          comment_body += f"{entities_md}\n"
          comment_body += f"{files_md}\n"
          comment_body += f"{plan_md}\n"
          comment_body += f"{template_md}\n"
          comment_body += "---\n\n"
          
          comment_footer = "### â„¹ï¸ About This Translation\n\n"
          comment_footer += "This translation was automatically generated by the Natural Language to Code Translator.\n\n"
          comment_footer += f"- **Entities found**: {result['metadata']['entity_count']}\n"
          comment_footer += f"- **Entity types**: {', '.join(result['metadata']['entity_types'])}\n"
          comment_footer += f"- **Confidence**: {result['confidence']:.2%}\n\n"
          comment_footer += "The generated code is a starting point and may need refinement. Review and modify as needed.\n\n"
          comment_footer += "### ðŸ“š Learn More\n\n"
          comment_footer += "- [NL-to-Code Translator Documentation](https://github.com/{repo}/blob/main/tools/NL_TO_CODE_TRANSLATOR_README.md)\n"
          comment_footer += "- [Run Demo](https://github.com/{repo}/blob/main/tools/examples/nl-to-code-demo.py)\n"
          comment_footer += "- [View Tests](https://github.com/{repo}/blob/main/tests/test_nl_to_code_translator.py)\n\n"
          comment_footer += f"*Translation powered by **{agent_mention}***\n"
          
          comment = comment_header + comment_body + comment_footer
          
          # Save comment to file
          with open('/tmp/comment.md', 'w') as f:
              f.write(comment.replace('{repo}', '${{ github.repository }}'))
          
          print("Comment formatted and saved")
          PYTHON_SCRIPT
      
      - name: Post translation as comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment "${{ steps.issue.outputs.issue_number }}" \
            --body-file /tmp/comment.md
          
          echo "âœ… Translation posted to issue #${{ steps.issue.outputs.issue_number }}"
      
      - name: Add completion label
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Add 'translated' label
          gh issue edit "${{ steps.issue.outputs.issue_number }}" \
            --add-label "translated"
          
          echo "âœ… Added 'translated' label"
      
      - name: Log activity
        run: |
          echo "NL-to-Code translation completed successfully"
          echo "Issue: #${{ steps.issue.outputs.issue_number }}"
          echo "Intent: ${{ steps.translate.outputs.intent }}"
          echo "Confidence: ${{ steps.translate.outputs.confidence }}"
          echo "Entities: ${{ steps.translate.outputs.entity_count }}"
