name: Copilot Request via Mention

on:
  issues:
    types: [opened, labeled]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to assign to Copilot'
        required: true
        type: string

permissions:
  issues: write
  contents: read

jobs:
  request-copilot:
    runs-on: ubuntu-latest
    # Only run if issue has appropriate label or was just created
    if: |
      (github.event_name == 'issues' && (github.event.action == 'opened' || 
       (github.event.action == 'labeled' && github.event.label.name == 'copilot-assigned'))) ||
      github.event_name == 'workflow_dispatch'
    steps:
      - name: Check if already processed
        id: check_processed
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if we already added a Copilot request comment
          comments=$(gh issue view ${{ steps.issue.outputs.number }} --repo ${{ github.repository }} --json comments --jq '.comments[].body')
          if echo "$comments" | grep -q "ü§ñ Copilot Assignment Request"; then
            echo "already_processed=true" >> $GITHUB_OUTPUT
            echo "Already requested Copilot for this issue"
          else
            echo "already_processed=false" >> $GITHUB_OUTPUT
          fi

      - name: Get issue number
        id: issue
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "number=${{ inputs.issue_number }}" >> $GITHUB_OUTPUT
          else
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          fi

      - name: Add copilot-assigned label
        if: steps.check_processed.outputs.already_processed != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if label already exists
          labels=$(gh issue view ${{ steps.issue.outputs.number }} --repo ${{ github.repository }} --json labels --jq '.labels[].name')
          if ! echo "$labels" | grep -q "copilot-assigned"; then
            gh issue edit ${{ steps.issue.outputs.number }} --repo ${{ github.repository }} --add-label "copilot-assigned"
            echo "Added copilot-assigned label"
          fi

      - name: Request Copilot via mention
        if: steps.check_processed.outputs.already_processed != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Request Copilot to work on this issue using @mention
          # This triggers Copilot agents to analyze and work on the issue
          gh issue comment ${{ steps.issue.outputs.number }} --repo ${{ github.repository }} --body "ü§ñ **Copilot Assignment Request**
          
          @github-copilot please help implement this feature.
          
          **Instructions:**
          - Analyze the issue requirements carefully
          - Create a new branch for your implementation
          - Implement the necessary code changes
          - Write appropriate tests
          - Open a pull request with your changes
          
          **What happens next:**
          1. ü§ñ Copilot analyzes the requirements
          2. üíª Copilot implements the solution
          3. üìù Copilot opens a PR
          4. ‚úÖ Auto-review merges the PR
          5. üéâ Issue is automatically closed
          
          **Note:** If Copilot doesn't respond, you may need to:
          - Manually assign a Copilot agent in your repository settings
          - Or manually implement the feature
          
          **Requested at:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          
          ---
          *ü§ñ Automated by Copilot Issue Assignment workflow*"
          
          echo "‚úÖ Posted Copilot request comment"

      - name: Log assignment activity
        run: |
          echo "Copilot request workflow completed"
          echo "Issue: #${{ steps.issue.outputs.number }}"
          echo "Already processed: ${{ steps.check_processed.outputs.already_processed }}"
          echo "Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
