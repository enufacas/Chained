name: Copilot Issue Assignment via API

on:
  issues:
    types: [opened, labeled]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to assign to Copilot'
        required: true
        type: string

permissions:
  issues: write
  contents: read

jobs:
  assign-to-copilot:
    runs-on: ubuntu-latest
    # Only run if issue has appropriate label or was just created
    if: |
      (github.event_name == 'issues' && (github.event.action == 'opened' || 
       (github.event.action == 'labeled' && github.event.label.name == 'copilot-assigned'))) ||
      github.event_name == 'workflow_dispatch'
    steps:
      - name: Get issue number
        id: issue
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "number=${{ inputs.issue_number }}" >> $GITHUB_OUTPUT
          else
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          fi

      - name: Check if already assigned to Copilot
        id: check_assigned
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get current assignees
          assignees=$(gh issue view ${{ steps.issue.outputs.number }} --repo ${{ github.repository }} --json assignees --jq '.assignees[].login')
          
          # Check if any assignee matches Copilot patterns
          if echo "$assignees" | grep -qE 'copilot|github-copilot'; then
            echo "already_assigned=true" >> $GITHUB_OUTPUT
            echo "‚úì Issue already assigned to Copilot"
          else
            echo "already_assigned=false" >> $GITHUB_OUTPUT
          fi

      - name: Add copilot-assigned label
        if: steps.check_assigned.outputs.already_assigned != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Add label if not present
          labels=$(gh issue view ${{ steps.issue.outputs.number }} --repo ${{ github.repository }} --json labels --jq '.labels[].name')
          if ! echo "$labels" | grep -q "copilot-assigned"; then
            gh issue edit ${{ steps.issue.outputs.number }} --repo ${{ github.repository }} --add-label "copilot-assigned"
            echo "‚úì Added copilot-assigned label"
          fi

      - name: Assign issue to Copilot via GitHub API
        if: steps.check_assigned.outputs.already_assigned != 'true'
        id: assign
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Assigning issue #${{ steps.issue.outputs.number }} to Copilot..."
          
          # Use the official GitHub CLI method to assign to Copilot
          # As documented: gh issue edit --add-assignee "@copilot"
          if gh issue edit ${{ steps.issue.outputs.number }} --repo ${{ github.repository }} --add-assignee "@copilot"; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Successfully assigned issue to Copilot"
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "‚ùå Failed to assign issue to Copilot"
            echo "This could mean:"
            echo "  - Copilot is not enabled for this repository"
            echo "  - You don't have a Copilot subscription"
            echo "  - The repository is on GitHub Enterprise Server (not supported)"
          fi

      - name: Add success comment
        if: steps.assign.outputs.success == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ steps.issue.outputs.number }} --repo ${{ github.repository }} --body "ü§ñ **Copilot Assigned Successfully**
          
          GitHub Copilot has been automatically assigned to this issue via the GitHub API.
          
          **What happens next:**
          1. ‚úÖ Copilot will analyze the issue requirements
          2. üíª Copilot will create a branch and implement the solution
          3. üìù Copilot will open a PR with the implementation
          4. üîç Auto-review workflow will validate and merge
          5. ‚úÖ Issue will be automatically closed when complete
          
          **Estimated time:** Copilot typically starts work within a few minutes
          **Assigned at:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          
          ---
          *ü§ñ Automated via the official GitHub API method - True autonomous operation!*"

      - name: Add error comment
        if: steps.assign.outputs.success == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ steps.issue.outputs.number }} --repo ${{ github.repository }} --body "‚ö†Ô∏è **Failed to Assign Copilot**
          
          The workflow attempted to assign GitHub Copilot to this issue but the assignment failed.
          
          **Possible reasons:**
          1. GitHub Copilot is not enabled for this repository
          2. Copilot coding agent is not activated
          3. You need a GitHub Copilot subscription (Individual, Business, or Enterprise)
          4. This repository is on GitHub Enterprise Server (Copilot assignment not supported)
          
          **To enable Copilot:**
          1. Ensure you have an active Copilot subscription
          2. Enable Copilot for this repository in repository Settings
          3. Verify Copilot agents are available for your account
          
          **For now:**
          - This issue has been labeled \`copilot-assigned\` for tracking
          - You can manually assign Copilot from the GitHub UI
          - Or assign a developer to implement this manually
          
          **To manually assign Copilot:**
          - Click on \"Assignees\" in the right sidebar
          - Select \"Copilot\" from the dropdown
          
          ---
          *ü§ñ Automated via the official GitHub API*"

      - name: Log assignment activity
        run: |
          echo "Copilot assignment workflow completed"
          echo "Issue: #${{ steps.issue.outputs.number }}"
          echo "Already assigned: ${{ steps.check_assigned.outputs.already_assigned }}"
          echo "Assignment successful: ${{ steps.assign.outputs.success }}"
          echo "Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
