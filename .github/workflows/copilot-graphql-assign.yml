name: Copilot Assignment Workflow

on:
  issues:
    types: [opened]
  schedule:
    # Run every 3 hours to check for unassigned issues
    - cron: '0 */3 * * *'
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to assign to Copilot (leave empty to process all open issues)'
        required: false
        type: string
      assignment_method:
        description: 'Assignment method: graphql (default), cli, or auto (try CLI first, fallback to GraphQL)'
        required: false
        type: choice
        default: 'auto'
        options:
          - auto
          - graphql
          - cli

permissions:
  issues: write
  contents: read

jobs:
  assign-to-copilot:
    runs-on: ubuntu-latest
    # Only run if issue was just created, on schedule, or via workflow_dispatch
    if: |
      github.event_name == 'issues' ||
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch'
    steps:
      - name: Check for PAT configuration
        env:
          GH_TOKEN: ${{ secrets.COPILOT_PAT }}
        run: |
          if [ -z "$GH_TOKEN" ]; then
            echo "‚ö†Ô∏è WARNING: COPILOT_PAT secret is not configured!"
            echo ""
            echo "The default GITHUB_TOKEN cannot assign issues to Copilot due to licensing restrictions."
            echo "You must create a Personal Access Token (PAT) with 'repo' scope and add it as a secret."
            echo ""
            echo "See COPILOT_SETUP.md for detailed setup instructions."
            echo ""
            echo "üìö Documentation: https://docs.github.com/en/copilot/how-tos/use-copilot-agents/coding-agent/create-a-pr"
            echo ""
            echo "Proceeding with GITHUB_TOKEN (will likely fail to find Copilot actor)..."
          else
            echo "‚úÖ COPILOT_PAT is configured"
          fi
      
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -q PyYAML
      
      - name: Discover and process issues
        env:
          # IMPORTANT: Use a Personal Access Token (PAT) instead of GITHUB_TOKEN
          # The default GITHUB_TOKEN does not have permissions to assign Copilot
          # See: https://docs.github.com/en/copilot/how-tos/use-copilot-agents/coding-agent/create-a-pr
          # Create a PAT with 'repo' scope and add it as a secret named COPILOT_PAT
          GH_TOKEN: ${{ secrets.COPILOT_PAT || secrets.GITHUB_TOKEN }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
          GITHUB_REPOSITORY_NAME: ${{ github.event.repository.name }}
          INPUT_ISSUE_NUMBER: ${{ inputs.issue_number }}
          INPUT_ASSIGNMENT_METHOD: ${{ inputs.assignment_method }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          ./tools/assign-copilot-to-issue.sh
