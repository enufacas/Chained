name: Copilot Assignment Workflow

on:
  issues:
    types: [opened, labeled]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to assign to Copilot'
        required: true
        type: string

permissions:
  issues: write
  contents: read

jobs:
  assign-to-copilot:
    runs-on: ubuntu-latest
    # Only run if issue has appropriate label or was just created
    if: |
      (github.event_name == 'issues' && (github.event.action == 'opened' || 
       (github.event.action == 'labeled' && github.event.label.name == 'copilot-assigned'))) ||
      github.event_name == 'workflow_dispatch'
    steps:
      - name: Discover and process all open issues
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ” Discovering all open issues..."
          
          # If workflow_dispatch with specific issue number, process only that issue
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ inputs.issue_number }}" ]; then
            echo "Processing specific issue #${{ inputs.issue_number }}"
            issue_numbers="${{ inputs.issue_number }}"
          else
            # Get all open issues
            issue_numbers=$(gh issue list --repo ${{ github.repository }} --state open --limit 1000 --json number --jq '.[].number')
          fi
          
          if [ -z "$issue_numbers" ]; then
            echo "â„¹ï¸ No open issues found"
            exit 0
          fi
          
          echo "Found issues to check: $issue_numbers"
          
          success_count=0
          already_assigned_count=0
          failed_count=0
          
          # Process each issue
          for issue_number in $issue_numbers; do
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "Processing issue #$issue_number"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # Get current assignees
            assignees=$(gh issue view $issue_number --repo ${{ github.repository }} --json assignees --jq '.assignees[].login')
            
            # Check if any assignee matches Copilot patterns
            if echo "$assignees" | grep -qE 'copilot|github-copilot'; then
              echo "âœ“ Issue #$issue_number already assigned to Copilot"
              already_assigned_count=$((already_assigned_count + 1))
              continue
            fi
            
            echo "ğŸ“ Issue #$issue_number not yet assigned to Copilot"
            
            # Add copilot-assigned label if not present
            labels=$(gh issue view $issue_number --repo ${{ github.repository }} --json labels --jq '.labels[].name')
            if ! echo "$labels" | grep -q "copilot-assigned"; then
              gh issue edit $issue_number --repo ${{ github.repository }} --add-label "copilot-assigned"
              echo "âœ“ Added copilot-assigned label to issue #$issue_number"
            fi
            
            # Assign issue to Copilot
            echo "ğŸ¤– Assigning issue #$issue_number to Copilot..."
            if gh issue edit $issue_number --repo ${{ github.repository }} --add-assignee "@copilot"; then
              echo "âœ… Successfully assigned issue #$issue_number to Copilot"
              success_count=$((success_count + 1))
              
              # Add success comment
              gh issue comment $issue_number --repo ${{ github.repository }} --body "ğŸ¤– **Copilot Assigned Successfully**
          
          GitHub Copilot has been automatically assigned to this issue via the GitHub API.
          
          **What happens next:**
          1. âœ… Copilot will analyze the issue requirements
          2. ğŸ’» Copilot will create a branch and implement the solution
          3. ğŸ“ Copilot will open a PR with the implementation
          4. ğŸ” Auto-review workflow will validate and merge
          5. âœ… Issue will be automatically closed when complete
          
          **Estimated time:** Copilot typically starts work within a few minutes
          **Assigned at:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          
          ---
          *ğŸ¤– Automated via the official GitHub API method - True autonomous operation!*"
            else
              echo "âŒ Failed to assign issue #$issue_number to Copilot"
              failed_count=$((failed_count + 1))
              
              # Add error comment
              gh issue comment $issue_number --repo ${{ github.repository }} --body "âš ï¸ **Failed to Assign Copilot**
          
          The workflow attempted to assign GitHub Copilot to this issue but the assignment failed.
          
          **Possible reasons:**
          1. GitHub Copilot is not enabled for this repository
          2. Copilot coding agent is not activated
          3. You need a GitHub Copilot subscription (Individual, Business, or Enterprise)
          4. This repository is on GitHub Enterprise Server (Copilot assignment not supported)
          
          **To enable Copilot:**
          1. Ensure you have an active Copilot subscription
          2. Enable Copilot for this repository in repository Settings
          3. Verify Copilot agents are available for your account
          
          **For now:**
          - This issue has been labeled \`copilot-assigned\` for tracking
          - You can manually assign Copilot from the GitHub UI
          - Or assign a developer to implement this manually
          
          **To manually assign Copilot:**
          - Click on \"Assignees\" in the right sidebar
          - Select \"Copilot\" from the dropdown
          
          ---
          *ğŸ¤– Automated via the official GitHub API*"
            fi
          done
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Successfully assigned: $success_count"
          echo "âœ“ Already assigned: $already_assigned_count"
          echo "âŒ Failed: $failed_count"
          echo "Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
