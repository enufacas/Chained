name: Copilot Assignment Workflow

on:
  issues:
    types: [opened]
  schedule:
    # Run every 3 hours to check for unassigned issues
    - cron: '0 */3 * * *'
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to assign to Copilot (leave empty to process all open issues)'
        required: false
        type: string

permissions:
  issues: write
  contents: read

jobs:
  assign-to-copilot:
    runs-on: ubuntu-latest
    # Only run if issue was just created, on schedule, or via workflow_dispatch
    if: |
      github.event_name == 'issues' ||
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch'
    steps:
      - name: Check for PAT configuration
        env:
          GH_TOKEN: ${{ secrets.COPILOT_PAT }}
        run: |
          if [ -z "$GH_TOKEN" ]; then
            echo "âš ï¸ WARNING: COPILOT_PAT secret is not configured!"
            echo ""
            echo "The default GITHUB_TOKEN cannot assign issues to Copilot due to licensing restrictions."
            echo "You must create a Personal Access Token (PAT) with 'repo' scope and add it as a secret."
            echo ""
            echo "See COPILOT_SETUP.md for detailed setup instructions."
            echo ""
            echo "ğŸ“š Documentation: https://docs.github.com/en/copilot/how-tos/use-copilot-agents/coding-agent/create-a-pr"
            echo ""
            echo "Proceeding with GITHUB_TOKEN (will likely fail to find Copilot actor)..."
          else
            echo "âœ… COPILOT_PAT is configured"
          fi
      
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -q PyYAML
      
      - name: Discover and process issues
        env:
          # IMPORTANT: Use a Personal Access Token (PAT) instead of GITHUB_TOKEN
          # The default GITHUB_TOKEN does not have permissions to assign Copilot
          # See: https://docs.github.com/en/copilot/how-tos/use-copilot-agents/coding-agent/create-a-pr
          # Create a PAT with 'repo' scope and add it as a secret named COPILOT_PAT
          GH_TOKEN: ${{ secrets.COPILOT_PAT || secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ” Determining which issues to process..."
          
          # If workflow_dispatch with specific issue number, process only that issue
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ inputs.issue_number }}" ]; then
            echo "Processing specific issue #${{ inputs.issue_number }}"
            issue_numbers="${{ inputs.issue_number }}"
          # If triggered by issue opened event, process only that issue
          elif [ "${{ github.event_name }}" = "issues" ]; then
            issue_numbers="${{ github.event.issue.number }}"
            echo "Processing newly opened issue #$issue_numbers"
          else
            # For scheduled runs or manual dispatch without issue number, get all open issues
            echo "Processing all open issues (scheduled or manual run)"
            issue_numbers=$(gh issue list --repo ${{ github.repository }} --state open --limit 1000 --json number --jq '.[].number')
          fi
          
          if [ -z "$issue_numbers" ]; then
            echo "â„¹ï¸ No open issues found"
            exit 0
          fi
          
          echo "Found issues to check: $issue_numbers"
          
          success_count=0
          already_assigned_count=0
          failed_count=0
          
          # Process each issue
          for issue_number in $issue_numbers; do
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "Processing issue #$issue_number"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # Get current assignees
            assignees=$(gh issue view $issue_number --repo ${{ github.repository }} --json assignees --jq '.assignees[].login')
            
            # Check if any assignee matches Copilot patterns
            if echo "$assignees" | grep -qE 'copilot|github-copilot'; then
              echo "âœ“ Issue #$issue_number already assigned to Copilot"
              already_assigned_count=$((already_assigned_count + 1))
              continue
            fi
            
            echo "ğŸ“ Issue #$issue_number not yet assigned to Copilot"
            
            # Check if we've already commented on this issue to avoid duplicate comments
            existing_comments=$(gh issue view $issue_number --repo ${{ github.repository }} --json comments --jq '.comments[].body')
            if echo "$existing_comments" | grep -q "ğŸ¤– **Copilot"; then
              echo "âœ“ Issue #$issue_number already has assignment comment, skipping to avoid duplicates"
              already_assigned_count=$((already_assigned_count + 1))
              continue
            fi
            
            # âœ¨ Intelligent Agent Matching âœ¨
            echo "ğŸ§  Analyzing issue content to match with appropriate agent..."
            issue_title=$(gh issue view $issue_number --repo ${{ github.repository }} --json title --jq '.title')
            issue_body=$(gh issue view $issue_number --repo ${{ github.repository }} --json body --jq '.body // ""')
            
            # Use intelligent matching to determine best agent
            agent_match=$(python3 tools/match-issue-to-agent.py "$issue_title" "$issue_body" 2>/dev/null || echo '{"agent":"feature-architect","score":0,"confidence":"low"}')
            matched_agent=$(echo "$agent_match" | jq -r '.agent')
            agent_score=$(echo "$agent_match" | jq -r '.score')
            agent_confidence=$(echo "$agent_match" | jq -r '.confidence')
            agent_emoji=$(echo "$agent_match" | jq -r '.emoji')
            agent_description=$(echo "$agent_match" | jq -r '.description')
            
            echo "âœ… Matched to agent: $agent_emoji $matched_agent"
            echo "   Score: $agent_score | Confidence: $agent_confidence"
            echo "   Description: $agent_description"
            
            # Add copilot-assigned label and agent-specific label
            labels=$(gh issue view $issue_number --repo ${{ github.repository }} --json labels --jq '.labels[].name')
            if ! echo "$labels" | grep -q "copilot-assigned"; then
              gh issue edit $issue_number --repo ${{ github.repository }} --add-label "copilot-assigned"
              echo "âœ“ Added copilot-assigned label to issue #$issue_number"
            fi
            
            # Add agent-specific label to help Copilot identify which custom agent to use
            agent_label="agent:$matched_agent"
            if ! echo "$labels" | grep -q "$agent_label"; then
              # Create label if it doesn't exist (will fail silently if it already exists)
              gh label create "$agent_label" --repo ${{ github.repository }} --description "Custom agent: $matched_agent" --color "0E8A16" 2>/dev/null || true
              gh issue edit $issue_number --repo ${{ github.repository }} --add-label "$agent_label"
              echo "âœ“ Added $agent_label label to issue #$issue_number"
            fi
            
            # Add agent directive to issue body so Copilot knows which custom agent to use
            # This is crucial: Copilot reads the issue body when assigned to understand context
            echo "ğŸ“ Adding agent directive to issue body..."
            issue_body_original=$(gh issue view $issue_number --repo ${{ github.repository }} --json body --jq '.body // ""')
            
            # Check if agent directive already exists in the issue body
            if ! echo "$issue_body_original" | grep -q "<!-- COPILOT_AGENT:"; then
              # Prepend agent directive to issue body
              agent_directive="<!-- COPILOT_AGENT:$matched_agent -->
          
          > **ğŸ¤– Agent Assignment**
          > 
          > This issue has been assigned to GitHub Copilot with the **$agent_emoji $matched_agent** custom agent profile.
          > Please use the specialized approach and tools defined in [\`.github/agents/${matched_agent}.md\`](https://github.com/${{ github.repository }}/blob/main/.github/agents/${matched_agent}.md).
          
          ---
          
          "
              # Combine directive with original body
              new_body="${agent_directive}${issue_body_original}"
              
              # Update issue body using gh issue edit
              echo "$new_body" | gh issue edit $issue_number --repo ${{ github.repository }} --body-file -
              echo "âœ“ Added agent directive to issue #$issue_number body"
            else
              echo "âœ“ Agent directive already exists in issue #$issue_number body"
            fi
            
            # Get the issue node ID (required for GraphQL mutation)
            echo "ğŸ” Fetching issue node ID for issue #$issue_number..."
            issue_node_id=$(gh issue view $issue_number --repo ${{ github.repository }} --json id --jq '.id')
            
            if [ -z "$issue_node_id" ]; then
              echo "âŒ Failed to get issue node ID for issue #$issue_number"
              failed_count=$((failed_count + 1))
              continue
            fi
            
            echo "ğŸ“ Issue node ID: $issue_node_id"
            
            # Get Copilot's actor ID from the repository's suggested actors
            echo "ğŸ” Fetching Copilot actor ID..."
            copilot_actor_id=$(gh api graphql -f query='
              query($owner: String!, $repo: String!) {
                repository(owner: $owner, name: $repo) {
                  suggestedActors(capabilities: [CAN_BE_ASSIGNED], first: 100) {
                    nodes {
                      login
                      __typename
                      ... on Bot { id }
                      ... on User { id }
                    }
                  }
                }
              }' -f owner="${{ github.repository_owner }}" -f repo="${{ github.event.repository.name }}" | jq -r '.data.repository.suggestedActors.nodes[] | select(.login | test("copilot"; "i")) | .id' | head -1)
            
            if [ -z "$copilot_actor_id" ]; then
              echo "âŒ Could not find Copilot actor ID in suggested actors"
              echo "â„¹ï¸  Copilot may not be enabled for this repository"
              failed_count=$((failed_count + 1))
              
              gh issue comment $issue_number --repo ${{ github.repository }} --body "âš ï¸ **Copilot Not Available**
          
          Could not find GitHub Copilot in the list of available assignees for this repository.
          
          **This means:**
          - GitHub Copilot is not enabled for this repository, OR
          - The workflow is not using a Personal Access Token (PAT) with proper permissions
          
          **To fix this:**
          1. **Enable Copilot:** Go to repository Settings â†’ Copilot and enable GitHub Copilot
          2. **Set up PAT:** Create a Personal Access Token with \`repo\` scope at https://github.com/settings/tokens
          3. **Add Secret:** Add the PAT as a repository secret named \`COPILOT_PAT\`
          4. **Verify Subscription:** Ensure your account has a Copilot subscription (Individual, Business, or Enterprise)
          
          **Note:** The default \`GITHUB_TOKEN\` cannot assign Copilot due to licensing restrictions. A PAT is required.
          
          **For now:**
          - This issue has been labeled \`copilot-assigned\` for tracking
          - You can manually assign Copilot from the GitHub UI, or assign a developer
          
          ---
          *ğŸ¤– Automated check via GitHub GraphQL API - See https://docs.github.com/en/copilot/how-tos/use-copilot-agents/coding-agent/create-a-pr*"
              continue
            fi
            
            echo "ğŸ“ Copilot actor ID: $copilot_actor_id"
            
            # Assign issue to Copilot using GraphQL API
            echo "ğŸ¤– Assigning issue #$issue_number to Copilot via GraphQL API..."
            
            # Use GraphQL mutation to assign Copilot (this is the official method per GitHub docs)
            mutation_result=$(gh api graphql -f query='
              mutation($issueId: ID!, $actorId: ID!) {
                replaceActorsForAssignable(input: {
                  assignableId: $issueId,
                  actorIds: [$actorId]
                }) {
                  assignable {
                    ... on Issue {
                      id
                      assignees(first: 10) {
                        nodes {
                          login
                        }
                      }
                    }
                  }
                }
              }' -f issueId="$issue_node_id" -f actorId="$copilot_actor_id" 2>&1)
            
            if echo "$mutation_result" | jq -e '.data.replaceActorsForAssignable.assignable' > /dev/null 2>&1; then
              echo "âœ… Successfully assigned issue #$issue_number to Copilot"
              success_count=$((success_count + 1))
              
              # Add success comment with agent matching info and directive for Copilot
              gh issue comment $issue_number --repo ${{ github.repository }} --body "ğŸ¤– **Copilot Assigned Successfully**
          
          GitHub Copilot has been automatically assigned to this issue via the official GitHub GraphQL API.
          
          ## ğŸ§  Intelligent Agent Matching
          
          This issue has been analyzed and matched to the **$agent_emoji $matched_agent** specialization:
          
          - **Agent**: $matched_agent
          - **Match Confidence**: $agent_confidence
          - **Match Score**: $agent_score
          - **Description**: $agent_description
          
          ## ğŸ¯ Copilot Agent Directive
          
          @copilot please use the **$matched_agent** custom agent profile from \`.github/agents/${matched_agent}.md\` when working on this issue. Follow the specialized approach, tools, and best practices defined in that agent's configuration.
          
          The implementation should align with the [$matched_agent agent definition](https://github.com/${{ github.repository }}/blob/main/.github/agents/${matched_agent}.md) and its specialized capabilities.
          
          **What happens next:**
          1. âœ… Copilot will analyze the issue requirements using the $matched_agent specialization
          2. ğŸ’» Copilot will create a branch and implement the solution following the $matched_agent approach
          3. ğŸ“ Copilot will open a PR with the implementation
          4. ğŸ” Auto-review workflow will validate and merge
          5. âœ… Issue will be automatically closed when complete
          
          **Estimated time:** Copilot typically starts work within a few minutes
          **Assigned at:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          
          ---
          *ğŸ¤– Automated via intelligent agent matching + GitHub GraphQL API - True autonomous operation!*"
            else
              echo "âŒ Failed to assign issue #$issue_number to Copilot"
              echo "Error details: $mutation_result"
              failed_count=$((failed_count + 1))
              
              # Add error comment with details
              gh issue comment $issue_number --repo ${{ github.repository }} --body "âš ï¸ **Failed to Assign Copilot via GraphQL API**
          
          The workflow attempted to assign GitHub Copilot to this issue using the official GraphQL API method, but the assignment failed.
          
          **API Method Used:**
          - GraphQL mutation: \`replaceActorsForAssignable\`
          - Actor ID: \`$copilot_actor_id\`
          
          **Most Common Cause:**
          This workflow is using the default \`GITHUB_TOKEN\` which cannot assign Copilot due to licensing restrictions. A Personal Access Token (PAT) is required.
          
          **To Fix:**
          1. Create a PAT with \`repo\` scope at https://github.com/settings/tokens
          2. Add it as a repository secret named \`COPILOT_PAT\`
          3. Re-run this workflow
          
          **Other Possible Reasons:**
          - GitHub Copilot is not enabled for this repository
          - Copilot coding agent is not activated for your organization
          - You need a GitHub Copilot subscription (Individual, Business, or Enterprise)
          - The repository lacks necessary Copilot permissions
          
          **For now:**
          - This issue has been labeled \`copilot-assigned\` for tracking
          - You can manually assign Copilot from the GitHub UI
          - Or assign a developer to implement this manually
          
          **To manually assign Copilot:**
          - Click on \"Assignees\" in the right sidebar
          - Select \"Copilot\" from the dropdown
          - Copilot should automatically pick up the issue
          
          ---
          *ğŸ¤– Automated via the official GitHub GraphQL API as documented at https://docs.github.com/en/copilot/how-tos/use-copilot-agents/coding-agent/create-a-pr*"
            fi
          done
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Successfully assigned: $success_count"
          echo "âœ“ Already assigned: $already_assigned_count"
          echo "âŒ Failed: $failed_count"
          echo "Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
