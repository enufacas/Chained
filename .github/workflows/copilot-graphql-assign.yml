name: Copilot Issue Assignment via API

on:
  issues:
    types: [opened, labeled]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to assign to Copilot'
        required: true
        type: string

permissions:
  issues: write
  contents: read

jobs:
  assign-to-copilot:
    runs-on: ubuntu-latest
    # Only run if issue has appropriate label or was just created
    if: |
      (github.event_name == 'issues' && (github.event.action == 'opened' || 
       (github.event.action == 'labeled' && github.event.label.name == 'copilot-assigned'))) ||
      github.event_name == 'workflow_dispatch'
    steps:
      - name: Get issue number
        id: issue
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "number=${{ inputs.issue_number }}" >> $GITHUB_OUTPUT
          else
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          fi

      - name: Check if already assigned to Copilot
        id: check_assigned
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get current assignees
          assignees=$(gh issue view ${{ steps.issue.outputs.number }} --repo ${{ github.repository }} --json assignees --jq '.assignees[].login')
          
          # Check if any assignee matches Copilot patterns
          if echo "$assignees" | grep -qE 'copilot|github-copilot'; then
            echo "already_assigned=true" >> $GITHUB_OUTPUT
            echo "‚úì Issue already assigned to Copilot"
          else
            echo "already_assigned=false" >> $GITHUB_OUTPUT
          fi

      - name: Find Copilot bot user ID
        if: steps.check_assigned.outputs.already_assigned != 'true'
        id: find_copilot
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Query for suggested actors with CAN_BE_ASSIGNED capability to find Copilot
          echo "Querying for Copilot bot actor..."
          
          # Use GraphQL to find Copilot actor using suggestedActors
          copilot_data=$(gh api graphql -f query='
            query($owner: String!, $repo: String!) {
              repository(owner: $owner, name: $repo) {
                suggestedActors(capabilities: [CAN_BE_ASSIGNED], first: 100) {
                  nodes {
                    login
                    id
                    __typename
                  }
                }
              }
            }
          ' -f owner="${{ github.repository_owner }}" -f repo="${{ github.event.repository.name }}")
          
          # Extract Copilot actor info (look for Bot type with copilot in name)
          copilot_login=$(echo "$copilot_data" | jq -r '.data.repository.suggestedActors.nodes[] | select(.__typename == "Bot" and (.login | test("copilot"; "i"))) | .login' | head -1)
          copilot_id=$(echo "$copilot_data" | jq -r '.data.repository.suggestedActors.nodes[] | select(.__typename == "Bot" and (.login | test("copilot"; "i"))) | .id' | head -1)
          
          if [ -n "$copilot_login" ] && [ -n "$copilot_id" ]; then
            echo "found=true" >> $GITHUB_OUTPUT
            echo "login=$copilot_login" >> $GITHUB_OUTPUT
            echo "id=$copilot_id" >> $GITHUB_OUTPUT
            echo "‚úì Found Copilot bot: $copilot_login (ID: $copilot_id)"
          else
            echo "found=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Copilot bot not found in suggested actors"
          fi

      - name: Add copilot-assigned label
        if: steps.check_assigned.outputs.already_assigned != 'true' && steps.find_copilot.outputs.found == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Add label if not present
          labels=$(gh issue view ${{ steps.issue.outputs.number }} --repo ${{ github.repository }} --json labels --jq '.labels[].name')
          if ! echo "$labels" | grep -q "copilot-assigned"; then
            gh issue edit ${{ steps.issue.outputs.number }} --repo ${{ github.repository }} --add-label "copilot-assigned"
            echo "‚úì Added copilot-assigned label"
          fi

      - name: Assign issue to Copilot via GraphQL
        if: steps.check_assigned.outputs.already_assigned != 'true' && steps.find_copilot.outputs.found == 'true'
        id: assign
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Assigning issue #${{ steps.issue.outputs.number }} to ${{ steps.find_copilot.outputs.login }}..."
          
          # Get issue node ID for GraphQL mutation
          issue_id=$(gh api graphql -f query='
            query($owner: String!, $repo: String!, $number: Int!) {
              repository(owner: $owner, name: $repo) {
                issue(number: $number) {
                  id
                }
              }
            }
          ' -f owner="${{ github.repository_owner }}" \
            -f repo="${{ github.event.repository.name }}" \
            -F number=${{ steps.issue.outputs.number }} \
            --jq '.data.repository.issue.id')
          
          # Assign using replaceActorsForAssignable mutation (required for Copilot)
          result=$(gh api graphql -f query='
            mutation($issueId: ID!, $actorIds: [ID!]!) {
              replaceActorsForAssignable(input: {
                assignableId: $issueId
                actorIds: $actorIds
              }) {
                assignable {
                  ... on Issue {
                    number
                    assignees(first: 10) {
                      nodes {
                        login
                      }
                    }
                  }
                }
              }
            }
          ' -f issueId="$issue_id" -f actorIds="[\"${{ steps.find_copilot.outputs.id }}\"]")
          
          if echo "$result" | jq -e '.data.replaceActorsForAssignable.assignable' > /dev/null; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Successfully assigned issue to Copilot via GraphQL"
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "‚ùå Failed to assign issue"
            echo "$result"
          fi

      - name: Add success comment
        if: steps.assign.outputs.success == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ steps.issue.outputs.number }} --repo ${{ github.repository }} --body "ü§ñ **Copilot Assigned Successfully**
          
          GitHub Copilot (\`${{ steps.find_copilot.outputs.login }}\`) has been automatically assigned to this issue via the GitHub API.
          
          **What happens next:**
          1. ‚úÖ Copilot will analyze the issue requirements
          2. üíª Copilot will create a branch and implement the solution
          3. üìù Copilot will open a PR with the implementation
          4. üîç Auto-review workflow will validate and merge
          5. ‚úÖ Issue will be automatically closed when complete
          
          **Estimated time:** Copilot typically starts work within a few minutes
          **Assigned at:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          
          ---
          *ü§ñ Automated via the official GitHub API method - True autonomous operation!*"

      - name: Add informational comment (Copilot not found)
        if: steps.check_assigned.outputs.already_assigned != 'true' && steps.find_copilot.outputs.found == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ steps.issue.outputs.number }} --repo ${{ github.repository }} --body "‚ö†Ô∏è **Copilot Bot Not Available**
          
          The GitHub Copilot bot is not available as a suggested actor in this repository.
          
          **This could mean:**
          1. GitHub Copilot is not enabled for this repository
          2. Copilot coding agent is not activated
          3. You need a GitHub Copilot subscription (Pro or Enterprise)
          4. The repository owner needs to enable Copilot access
          
          **To enable Copilot:**
          1. Ensure you have an active Copilot subscription
          2. Enable Copilot for this repository in Settings
          3. Verify Copilot agents are available
          4. Make sure the token used has Copilot access (user PAT required)
          
          **For now:**
          - This issue has been labeled \`copilot-assigned\` for tracking
          - Manual implementation will be needed
          - Any PR with the \`copilot\` label will still auto-merge
          
          **Alternative:** You can manually assign a developer or implement the feature yourself.
          
          ---
          *ü§ñ Automated check via GitHub API - Copilot not found in suggested actors*"

      - name: Log assignment activity
        run: |
          echo "Copilot assignment workflow completed"
          echo "Issue: #${{ steps.issue.outputs.number }}"
          echo "Already assigned: ${{ steps.check_assigned.outputs.already_assigned }}"
          echo "Copilot found: ${{ steps.find_copilot.outputs.found }}"
          echo "Assignment successful: ${{ steps.assign.outputs.success }}"
          echo "Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
