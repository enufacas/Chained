name: "Self-Documenting AI: Enhanced Learning"

on:
  issues:
    types: [closed]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to analyze'
        required: true
        type: number
      live_analysis:
        description: 'Perform live analysis (true/false)'
        required: false
        type: boolean
        default: false

# Prevent concurrent runs to avoid git conflicts
concurrency:
  group: self-documenting-ai-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  issues: read
  pull-requests: write

jobs:
  enhanced-learning:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest  # For testing if needed
      
      - name: Get issue number
        id: get_issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ISSUE_NUMBER="${{ github.event.inputs.issue_number }}"
            LIVE_ANALYSIS="${{ github.event.inputs.live_analysis }}"
          else
            ISSUE_NUMBER="${{ github.event.issue.number }}"
            LIVE_ANALYSIS="false"
          fi
          
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          echo "live_analysis=$LIVE_ANALYSIS" >> $GITHUB_OUTPUT
          
          echo "‚úÖ Processing issue #$ISSUE_NUMBER"
      
      - name: Fetch issue data
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER="${{ steps.get_issue.outputs.issue_number }}"
          
          # Fetch complete issue data including comments
          gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/${{ github.repository }}/issues/${ISSUE_NUMBER}" \
            > /tmp/issue_base.json
          
          # Fetch comments
          gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/${{ github.repository }}/issues/${ISSUE_NUMBER}/comments" \
            > /tmp/issue_comments.json
          
          # Combine into single file
          python3 << 'PYTHON_SCRIPT'
          import json
          
          with open('/tmp/issue_base.json', 'r') as f:
              issue_data = json.load(f)
          
          with open('/tmp/issue_comments.json', 'r') as f:
              comments = json.load(f)
          
          issue_data['comments'] = comments
          
          with open('/tmp/issue_data.json', 'w') as f:
              json.dump(issue_data, f, indent=2)
          
          print(f"‚úÖ Fetched issue data with {len(comments)} comments")
          PYTHON_SCRIPT
      
      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Run enhanced learning analysis
        id: analyze
        continue-on-error: true
        run: |
          ISSUE_NUMBER="${{ steps.get_issue.outputs.issue_number }}"
          LIVE_ANALYSIS="${{ steps.get_issue.outputs.live_analysis }}"
          
          # Create learnings directory
          mkdir -p learnings/discussions
          
          # Run enhanced learner with retry logic
          MAX_RETRIES=3
          RETRY_COUNT=0
          SUCCESS=false
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$SUCCESS" = "false" ]; do
            if [ $RETRY_COUNT -gt 0 ]; then
              echo "‚ö†Ô∏è  Retry attempt $RETRY_COUNT of $MAX_RETRIES"
              sleep $((RETRY_COUNT * 5))  # Exponential backoff
            fi
            
            if [ "$LIVE_ANALYSIS" == "true" ]; then
              echo "üîÑ Performing live analysis..."
              if python3 tools/enhanced-discussion-learner.py /tmp/issue_data.json \
                --output-dir learnings/discussions \
                --live-analysis 2>&1 | tee /tmp/analysis_log.txt; then
                SUCCESS=true
              fi
            else
              echo "üîç Performing full enhanced analysis..."
              if python3 tools/enhanced-discussion-learner.py /tmp/issue_data.json \
                --output-dir learnings/discussions 2>&1 | tee /tmp/analysis_log.txt; then
                SUCCESS=true
              fi
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
          done
          
          if [ "$SUCCESS" = "true" ]; then
            echo "‚úÖ Analysis completed successfully"
            echo "analysis_complete=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Analysis failed after $MAX_RETRIES attempts"
            echo "Last error log:"
            tail -20 /tmp/analysis_log.txt || echo "No log available"
            echo "analysis_complete=false" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: Create PR with learnings
        if: steps.analyze.outputs.analysis_complete == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER="${{ steps.get_issue.outputs.issue_number }}"
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BRANCH_NAME="self-documenting-ai/${TIMESTAMP}-${GITHUB_RUN_ID}"
          
          # Check for changes
          git add learnings/
          
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è No new learnings to commit"
            exit 0
          fi
          
          # Fetch latest main to reduce conflicts
          git fetch origin main
          git reset --soft origin/main
          git add learnings/
          
          # Create branch from latest main
          git checkout -b "$BRANCH_NAME"
          
          # Commit changes (using here-doc to avoid YAML issues)
          cat > /tmp/commit_msg.txt << 'COMMITMSG'
          feat: enhanced learning from issue #${ISSUE_NUMBER} (@engineer-master)
          
          Engineer-master has analyzed issue using the enhanced self-documenting AI system.
          
          ## Learning Enhancements
          
          - Advanced pattern recognition
          - Knowledge graph connections
          - Real-time learning insights
          - Proactive suggestions
          
          The AI system continuously learns from every discussion, improving its capabilities over time.
          COMMITMSG
          
          # Replace variable in commit message
          sed -i "s/\${ISSUE_NUMBER}/${ISSUE_NUMBER}/g" /tmp/commit_msg.txt
          git commit -F /tmp/commit_msg.txt
          
          # Push with retry logic
          MAX_PUSH_RETRIES=3
          PUSH_RETRY_COUNT=0
          PUSH_SUCCESS=false
          
          while [ $PUSH_RETRY_COUNT -lt $MAX_PUSH_RETRIES ] && [ "$PUSH_SUCCESS" = "false" ]; do
            if [ $PUSH_RETRY_COUNT -gt 0 ]; then
              echo "‚ö†Ô∏è  Push retry attempt $PUSH_RETRY_COUNT of $MAX_PUSH_RETRIES"
              sleep $((PUSH_RETRY_COUNT * 3))
            fi
            
            if git push origin "$BRANCH_NAME"; then
              PUSH_SUCCESS=true
            else
              echo "‚ùå Push failed, will retry..."
            fi
            
            PUSH_RETRY_COUNT=$((PUSH_RETRY_COUNT + 1))
          done
          
          if [ "$PUSH_SUCCESS" != "true" ]; then
            echo "‚ùå Failed to push branch after $MAX_PUSH_RETRIES attempts"
            exit 1
          fi
          
          echo "‚úÖ Branch pushed successfully"
          
          # Create PR with retry logic
          MAX_PR_RETRIES=3
          PR_RETRY_COUNT=0
          PR_SUCCESS=false
          
          while [ $PR_RETRY_COUNT -lt $MAX_PR_RETRIES ] && [ "$PR_SUCCESS" = "false" ]; do
            if [ $PR_RETRY_COUNT -gt 0 ]; then
              echo "‚ö†Ô∏è  PR creation retry attempt $PR_RETRY_COUNT of $MAX_PR_RETRIES"
              sleep $((PR_RETRY_COUNT * 5))
            fi
            
            # Create PR body in a file to avoid YAML escaping issues
            cat > /tmp/pr_body.md << 'PRBODY'
            ## üß† Enhanced Self-Documenting AI Learning
            
            Engineer-master has completed enhanced analysis of the issue.
            
            ### What Was Learned
            
            This PR contains learnings extracted using the Enhanced Self-Documenting AI system.
            
            ‚ú® Advanced Pattern Recognition
            - Detects complex discussion patterns
            - Identifies collaboration success stories
            - Recognizes decision-making processes
            
            üîó Knowledge Graph Connections
            - Links related insights across discussions
            - Builds semantic connections
            - Enables discovery of related learnings
            
            üì° Real-Time Learning
            - Live analysis during active discussions
            - Proactive suggestions for documentation
            - Related past discussion recommendations
            
            üéØ Proactive Suggestions
            - Context-aware recommendations
            - Best practice reminders
            - Related insight discovery
            
            ### Files Added
            
            - Discussion analysis (JSON)
            - Enhanced documentation (Markdown)
            - Knowledge graph connections
            - Enhancement metadata
            
            ### Impact
            
            The AI system becomes smarter with each discussion, continuously improving its ability to:
            - Understand technical concepts
            - Recognize effective collaboration
            - Suggest relevant insights
            - Connect related knowledge
            PRBODY
            
            # Add closing text with issue number
            echo "" >> /tmp/pr_body.md
            echo "---" >> /tmp/pr_body.md
            echo "" >> /tmp/pr_body.md
            echo "Closes #${ISSUE_NUMBER}" >> /tmp/pr_body.md
            
            if gh pr create \
              --title "üìö Enhanced Learning: Issue #${ISSUE_NUMBER} (@engineer-master)" \
              --body-file /tmp/pr_body.md \
              --label "automated,self-documenting-ai,learning" \
              --base main \
              --head "$BRANCH_NAME" 2>&1; then
              PR_SUCCESS=true
              echo "‚úÖ PR created successfully"
            else
              echo "‚ùå PR creation failed, will retry..."
            fi
            
            PR_RETRY_COUNT=$((PR_RETRY_COUNT + 1))
          done
          
          if [ "$PR_SUCCESS" != "true" ]; then
            echo "‚ùå Failed to create PR after $MAX_PR_RETRIES attempts"
            echo "Note: Branch $BRANCH_NAME was pushed successfully"
            echo "You can manually create the PR from this branch"
            exit 1
          fi
      
      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.analyze.outputs.analysis_complete }}" = "true" ]; then
            echo "‚úÖ Enhanced self-documenting AI workflow complete!"
            echo "Issue #${{ steps.get_issue.outputs.issue_number }} analyzed with advanced learning"
          else
            echo "‚ö†Ô∏è  Workflow completed with warnings"
            echo "Some steps may have been skipped due to errors"
          fi
