name: Autonomous Code Reviewer

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: read

jobs:
  review:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Get changed files
        id: changed-files
        run: |
          git fetch origin ${{ github.base_ref }}
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | jq -R -s -c 'split("\n")[:-1]')
          echo "files=${CHANGED_FILES}" >> $GITHUB_OUTPUT
          echo "Changed files: ${CHANGED_FILES}"

      - name: Run autonomous review
        id: review
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Run the reviewer from repo root
          python3 .github/review-system/autonomous_reviewer.py review \
            --files '${{ steps.changed-files.outputs.files }}' \
            --pr-number ${{ github.event.pull_request.number }} \
            --output .github/review-system/review_result.json
          
          # Store results in outputs
          if [ -f .github/review-system/review_result.json ]; then
            SCORE=$(jq -r '.results.overall_score' .github/review-system/review_result.json)
            COMMENT=$(jq -r '.comment' .github/review-system/review_result.json)
            LABEL=$(jq -r '.suggested_label' .github/review-system/review_result.json)
            
            echo "score=${SCORE}" >> $GITHUB_OUTPUT
            echo "label=${LABEL}" >> $GITHUB_OUTPUT
            
            # Save comment to file to handle multiline properly
            jq -r '.comment' .github/review-system/review_result.json > /tmp/review_comment.txt
            
            echo "comment<<COMMENT_EOF" >> $GITHUB_OUTPUT
            cat /tmp/review_comment.txt >> $GITHUB_OUTPUT
            echo "COMMENT_EOF" >> $GITHUB_OUTPUT
            
            echo "Review complete with score: ${SCORE}"
          else
            echo "Error: Review result file not found"
            exit 1
          fi

      - name: Post review comment
        if: steps.review.outputs.comment != ''
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `${{ steps.review.outputs.comment }}`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: Add quality label
        if: steps.review.outputs.label != ''
        uses: actions/github-script@v7
        with:
          script: |
            const label = '${{ steps.review.outputs.label }}';
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: [label]
            });

      - name: Store review results
        run: |
          mkdir -p .github/review-system/reviews
          if [ -f .github/review-system/review_result.json ]; then
            TIMESTAMP=$(date +%Y%m%d-%H%M%S)
            cp .github/review-system/review_result.json \
               .github/review-system/reviews/pr-${{ github.event.pull_request.number }}-${TIMESTAMP}.json
          fi

      - name: Create PR for criteria update if needed
        if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd .github/review-system
          
          # Check if criteria was updated
          if git diff --quiet criteria.json; then
            echo "No criteria changes to commit"
            exit 0
          fi
          
          # Create branch
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          RUN_ID="${{ github.run_id }}"
          BRANCH_NAME="criteria-evolution/${TIMESTAMP}-${RUN_ID}"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "${BRANCH_NAME}"
          
          git add criteria.json
          
          total_reviews=$(jq -r '.metadata.total_reviews' criteria.json)
          success_rate=$(jq -r '.metadata.success_rate' criteria.json)
          
          git commit -m "chore: update autonomous review criteria (@workflows-tech-lead)" \
            -m "" \
            -m "Criteria evolved based on PR review." \
            -m "" \
            -m "- Total reviews: ${total_reviews}" \
            -m "- Success rate: ${success_rate}" \
            -m "" \
            -m "Reviewed by @workflows-tech-lead"
          
          git push origin "${BRANCH_NAME}"
          
          gh pr create \
            --title "chore: autonomous reviewer criteria evolution" \
            --body "Automated criteria update by autonomous reviewer system." \
            --label "automated,copilot" \
            --base main \
            --head "${BRANCH_NAME}"
