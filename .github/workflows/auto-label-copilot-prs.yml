name: Auto Label Copilot PRs

on:
  schedule:
    - cron: '*/10 * * * *'  # Run every 10 minutes
  pull_request_target:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:

permissions:
  pull-requests: write
  issues: write

jobs:
  label-copilot-prs:
    runs-on: ubuntu-latest
    steps:
      - name: Label all open Copilot PRs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîç Finding all open PRs from Copilot..."
          echo "Trigger: ${{ github.event_name }}"
          
          # Get all open PRs (matches various copilot formats including app/copilot-swe-agent)
          pr_list=$(gh pr list --repo ${{ github.repository }} --state open --json number,author,labels --jq '.[] | select(.author.login | test("^(Copilot|copilot|app/copilot)"; "i")) | .number')
          
          if [ -z "${pr_list}" ]; then
            echo "‚ÑπÔ∏è No Copilot PRs found"
            exit 0
          fi
          
          echo "Found Copilot PRs: ${pr_list}"
          
          # Add label to each PR
          for pr_num in ${pr_list}; do
            echo "Checking PR #${pr_num}..."
            
            # Check if PR already has the copilot label
            has_label=$(gh pr view ${pr_num} --repo ${{ github.repository }} --json labels --jq '.labels[] | select(.name == "copilot") | .name')
            
            if [ -n "${has_label}" ]; then
              echo "‚ÑπÔ∏è PR #${pr_num} already has 'copilot' label, skipping"
            else
              echo "Adding 'copilot' label to PR #${pr_num}"
              if gh pr edit ${pr_num} --add-label "copilot" --repo ${{ github.repository }}; then
                echo "‚úÖ Label added to PR #${pr_num}"
              else
                echo "‚ö†Ô∏è Failed to add label to PR #${pr_num}"
              fi
            fi
          done
          
          echo "‚úÖ Finished processing all Copilot PRs"
