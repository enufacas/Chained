name: Auto Label Copilot PRs

on:
  pull_request:
    types: [opened, reopened]
  workflow_dispatch:
    inputs:
      label_existing:
        description: 'Label all existing Copilot PRs'
        required: false
        type: boolean
        default: false

permissions:
  pull-requests: write
  issues: write

jobs:
  label-copilot-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Label specific PR (from pull_request event)
        if: github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          pr_number="${{ github.event.pull_request.number }}"
          author="${{ github.event.pull_request.user.login }}"
          
          echo "PR #${pr_number} author: ${author}"
          
          # Check if author is Copilot (matches various formats)
          if echo "${author}" | grep -qiE "^(Copilot|copilot-swe-agent)"; then
            echo "‚úÖ PR is from Copilot, adding label"
            gh pr edit ${pr_number} --add-label "copilot" --repo ${{ github.repository }}
            echo "‚úÖ Label added successfully to PR #${pr_number}"
          else
            echo "‚ÑπÔ∏è PR is not from Copilot, skipping"
          fi

      - name: Label all existing Copilot PRs (from workflow_dispatch)
        if: github.event_name == 'workflow_dispatch' && inputs.label_existing == true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîç Finding all open PRs from Copilot..."
          
          # Get all open PRs
          pr_list=$(gh pr list --state open --json number,author --jq '.[] | select(.author.login | test("^(Copilot|copilot-swe-agent)"; "i")) | .number')
          
          if [ -z "${pr_list}" ]; then
            echo "‚ÑπÔ∏è No Copilot PRs found"
            exit 0
          fi
          
          echo "Found Copilot PRs: ${pr_list}"
          
          # Add label to each PR
          for pr_num in ${pr_list}; do
            echo "Adding 'copilot' label to PR #${pr_num}"
            if gh pr edit ${pr_num} --add-label "copilot" --repo ${{ github.repository }}; then
              echo "‚úÖ Label added to PR #${pr_num}"
            else
              echo "‚ö†Ô∏è Failed to add label to PR #${pr_num}"
            fi
          done
          
          echo "‚úÖ Finished labeling all Copilot PRs"
