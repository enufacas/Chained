name: Progress Tracker

on:
  schedule:
    # Run every 12 hours
    - cron: '0 */12 * * *'
  workflow_dispatch: # Allow manual trigger

permissions:
  issues: write
  contents: write

jobs:
  track-progress:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Analyze repository progress
        id: analyze
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get issue statistics
          total_issues=$(gh issue list --state all --limit 1000 --json number | jq '. | length')
          open_issues=$(gh issue list --state open --limit 1000 --json number | jq '. | length')
          closed_issues=$(gh issue list --state closed --limit 1000 --json number | jq '. | length')
          
          # Get AI-generated issue statistics
          ai_issues=$(gh issue list --state all --label "ai-generated" --limit 1000 --json number | jq '. | length')
          ai_completed=$(gh issue list --state closed --label "ai-generated" --limit 1000 --json number | jq '. | length')
          
          # Get Copilot-assigned statistics
          copilot_issues=$(gh issue list --state all --label "copilot-assigned" --limit 1000 --json number | jq '. | length')
          
          # Calculate completion rate
          if [ ${ai_issues} -gt 0 ]; then
            completion_rate=$(awk "BEGIN {printf \"%.1f\", (${ai_completed}/${ai_issues})*100}")
          else
            completion_rate="0.0"
          fi
          
          echo "total_issues=${total_issues}" >> $GITHUB_OUTPUT
          echo "open_issues=${open_issues}" >> $GITHUB_OUTPUT
          echo "closed_issues=${closed_issues}" >> $GITHUB_OUTPUT
          echo "ai_issues=${ai_issues}" >> $GITHUB_OUTPUT
          echo "ai_completed=${ai_completed}" >> $GITHUB_OUTPUT
          echo "copilot_issues=${copilot_issues}" >> $GITHUB_OUTPUT
          echo "completion_rate=${completion_rate}" >> $GITHUB_OUTPUT

      - name: Create progress report
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create a progress report as a comment on a tracking issue or create a new one
          report="## ðŸ“Š Progress Report - $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          ### Overall Statistics
          - **Total Issues:** ${{ steps.analyze.outputs.total_issues }}
          - **Open Issues:** ${{ steps.analyze.outputs.open_issues }}
          - **Closed Issues:** ${{ steps.analyze.outputs.closed_issues }}

          ### AI Motion Machine Statistics
          - **AI-Generated Ideas:** ${{ steps.analyze.outputs.ai_issues }}
          - **Completed AI Tasks:** ${{ steps.analyze.outputs.ai_completed }}
          - **Copilot Assignments:** ${{ steps.analyze.outputs.copilot_issues }}
          - **Completion Rate:** ${{ steps.analyze.outputs.completion_rate }}%

          ### System Status
          - âœ… Idea Generator: Active
          - âœ… Copilot Auto-Assign: Active
          - âœ… Timeline Updater: Active
          - âœ… Progress Tracker: Active

          ---

          *This report was automatically generated by the Progress Tracker workflow.*"
          
          # Try to find existing progress tracking issue
          tracking_issue=$(gh issue list --label "progress-report" --state open --limit 1 --json number | jq -r '.[0].number // empty')
          
          if [ -n "${tracking_issue}" ]; then
            echo "Adding progress report to issue #${tracking_issue}"
            echo "${report}" | gh issue comment ${tracking_issue} --body-file -
          else
            echo "No tracking issue found. Progress logged to workflow output."
            echo "${report}"
          fi

      - name: Log progress
        run: |
          echo "Progress tracking completed"
          echo "Total Issues: ${{ steps.analyze.outputs.total_issues }}"
          echo "AI-Generated: ${{ steps.analyze.outputs.ai_issues }}"
          echo "Completed: ${{ steps.analyze.outputs.ai_completed }}"
          echo "Completion Rate: ${{ steps.analyze.outputs.completion_rate }}%"
