name: "Tech Lead Feedback Handler"

# Handles tech lead review comments and creates follow-up issues for agents to fix
# This bridges the gap between tech lead reviews and agent work assignments

on:
  pull_request_review:
    types: [submitted]
  pull_request_review_comment:
    types: [created]
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to process feedback for'
        required: true
        type: string

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  process-tech-lead-feedback:
    runs-on: ubuntu-latest
    # Only run if this is on a PR and involves a tech lead review or feedback comment
    if: |
      (github.event_name == 'pull_request_review' && github.event.review.state == 'changes_requested') ||
      (github.event_name == 'pull_request_review' && github.event.review.state == 'commented') ||
      (github.event_name == 'pull_request_review_comment') ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request) ||
      github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Get PR and review information
        id: get_info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            pr_number="${{ inputs.pr_number }}"
          elif [ "${{ github.event_name }}" = "pull_request_review" ]; then
            pr_number="${{ github.event.pull_request.number }}"
          elif [ "${{ github.event_name }}" = "pull_request_review_comment" ]; then
            pr_number="${{ github.event.pull_request.number }}"
          elif [ "${{ github.event_name }}" = "issue_comment" ]; then
            pr_number="${{ github.event.issue.number }}"
          fi
          
          echo "pr_number=${pr_number}" >> $GITHUB_OUTPUT
          
          # Get PR information
          pr_info=$(gh pr view ${pr_number} --json title,body,author,labels,url --repo ${{ github.repository }})
          pr_title=$(echo "${pr_info}" | jq -r '.title')
          pr_author=$(echo "${pr_info}" | jq -r '.author.login')
          pr_url=$(echo "${pr_info}" | jq -r '.url')
          pr_labels=$(echo "${pr_info}" | jq -r '.labels[].name' | tr '\n' ',' | sed 's/,$//')
          
          echo "pr_title=${pr_title}" >> $GITHUB_OUTPUT
          echo "pr_author=${pr_author}" >> $GITHUB_OUTPUT
          echo "pr_url=${pr_url}" >> $GITHUB_OUTPUT
          echo "pr_labels=${pr_labels}" >> $GITHUB_OUTPUT
          
          # Check for WIP in title
          if echo "${pr_title}" | grep -qiE '\[WIP\]|^WIP:|WIP\s|work.in.progress|\[do.not.merge\]|\[dnm\]'; then
            echo "has_wip=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ PR has WIP marker in title - will skip feedback processing"
          else
            echo "has_wip=false" >> $GITHUB_OUTPUT
          fi
          
          # Check if this PR has tech lead labels
          tech_lead_label=$(echo "${pr_labels}" | grep -o 'tech-lead:[^,]*' | head -1 || echo "")
          echo "tech_lead_label=${tech_lead_label}" >> $GITHUB_OUTPUT

      - name: Check if review is from tech lead
        if: steps.get_info.outputs.has_wip == 'false'
        id: check_tech_lead
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          pr_number="${{ steps.get_info.outputs.pr_number }}"
          tech_lead_label="${{ steps.get_info.outputs.tech_lead_label }}"
          
          # Skip if no tech lead assigned
          if [ -z "${tech_lead_label}" ]; then
            echo "is_tech_lead_review=false" >> $GITHUB_OUTPUT
            echo "No tech lead assigned to this PR"
            exit 0
          fi
          
          # Extract tech lead name from label
          tech_lead_name=$(echo "${tech_lead_label}" | sed 's/tech-lead://')
          echo "tech_lead_name=${tech_lead_name}" >> $GITHUB_OUTPUT
          
          # Get the review/comment body
          if [ "${{ github.event_name }}" = "pull_request_review" ]; then
            review_body="${{ github.event.review.body }}"
            reviewer="${{ github.event.review.user.login }}"
            review_state="${{ github.event.review.state }}"
          elif [ "${{ github.event_name }}" = "pull_request_review_comment" ]; then
            review_body="${{ github.event.comment.body }}"
            reviewer="${{ github.event.comment.user.login }}"
            review_state="commented"
          elif [ "${{ github.event_name }}" = "issue_comment" ]; then
            review_body="${{ github.event.comment.body }}"
            reviewer="${{ github.event.comment.user.login }}"
            review_state="commented"
          else
            # workflow_dispatch - get latest review
            latest_review=$(gh pr view ${pr_number} --json reviews --jq '.reviews[-1]' --repo ${{ github.repository }})
            review_body=$(echo "${latest_review}" | jq -r '.body // ""')
            reviewer=$(echo "${latest_review}" | jq -r '.author.login // ""')
            review_state=$(echo "${latest_review}" | jq -r '.state // ""')
          fi
          
          echo "reviewer=${reviewer}" >> $GITHUB_OUTPUT
          echo "review_body<<EOF" >> $GITHUB_OUTPUT
          echo "${review_body}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "review_state=${review_state}" >> $GITHUB_OUTPUT
          
          # For now, consider any review as potentially from tech lead
          # In production, you might want to verify the reviewer has tech lead permissions
          echo "is_tech_lead_review=true" >> $GITHUB_OUTPUT
          
          echo "Review from: ${reviewer}"
          echo "Review state: ${review_state}"
          echo "Tech Lead: ${tech_lead_name}"

      - name: Analyze feedback for actionable items
        id: analyze_feedback
        if: steps.get_info.outputs.has_wip == 'false' && steps.check_tech_lead.outputs.is_tech_lead_review == 'true'
        run: |
          review_body="${{ steps.check_tech_lead.outputs.review_body }}"
          review_state="${{ steps.check_tech_lead.outputs.review_state }}"
          
          # Check if this is a changes_requested review
          if [ "${review_state}" != "changes_requested" ]; then
            echo "has_actionable_feedback=false" >> $GITHUB_OUTPUT
            echo "Not a changes_requested review, skipping"
            exit 0
          fi
          
          # Check if review body is empty
          if [ -z "${review_body}" ] || [ "${review_body}" = "null" ]; then
            echo "has_actionable_feedback=false" >> $GITHUB_OUTPUT
            echo "Review body is empty"
            exit 0
          fi
          
          echo "has_actionable_feedback=true" >> $GITHUB_OUTPUT
          
          # Count action items (lines starting with - [ ] or numbered lists)
          action_item_count=$(echo "${review_body}" | grep -c '^[-*] \[ \]\|^[0-9]\+\.' || echo "0")
          echo "action_item_count=${action_item_count}" >> $GITHUB_OUTPUT
          
          echo "Found ${action_item_count} potential action items"

      - name: Match feedback to appropriate agent
        id: match_agent
        if: steps.get_info.outputs.has_wip == 'false' && steps.analyze_feedback.outputs.has_actionable_feedback == 'true'
        run: |
          pr_title="${{ steps.get_info.outputs.pr_title }}"
          review_body="${{ steps.check_tech_lead.outputs.review_body }}"
          pr_number="${{ steps.get_info.outputs.pr_number }}"
          
          echo "Analyzing feedback to match appropriate agent..."
          
          # Use match-issue-to-agent.py to determine which agent should handle the fixes
          agent_match=$(python3 tools/match-issue-to-agent.py \
            "Fix tech lead feedback for PR #${pr_number}: ${pr_title}" \
            "${review_body}" \
            2>/dev/null || echo '{"agent":"create-guru","score":0,"confidence":"low"}')
          
          matched_agent=$(echo "$agent_match" | jq -r '.agent')
          agent_score=$(echo "$agent_match" | jq -r '.score')
          agent_confidence=$(echo "$agent_match" | jq -r '.confidence')
          agent_emoji=$(echo "$agent_match" | jq -r '.emoji')
          agent_description=$(echo "$agent_match" | jq -r '.description')
          
          echo "matched_agent=${matched_agent}" >> $GITHUB_OUTPUT
          echo "agent_score=${agent_score}" >> $GITHUB_OUTPUT
          echo "agent_confidence=${agent_confidence}" >> $GITHUB_OUTPUT
          echo "agent_emoji=${agent_emoji}" >> $GITHUB_OUTPUT
          
          echo "âœ… Matched to agent: ${agent_emoji} @${matched_agent}"
          echo "   Score: ${agent_score} | Confidence: ${agent_confidence}"

      - name: Create follow-up issue for agent
        id: create_issue
        if: steps.get_info.outputs.has_wip == 'false' && steps.analyze_feedback.outputs.has_actionable_feedback == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          pr_number="${{ steps.get_info.outputs.pr_number }}"
          pr_title="${{ steps.get_info.outputs.pr_title }}"
          pr_url="${{ steps.get_info.outputs.pr_url }}"
          pr_author="${{ steps.get_info.outputs.pr_author }}"
          
          tech_lead_name="${{ steps.check_tech_lead.outputs.tech_lead_name }}"
          reviewer="${{ steps.check_tech_lead.outputs.reviewer }}"
          review_body="${{ steps.check_tech_lead.outputs.review_body }}"
          
          matched_agent="${{ steps.match_agent.outputs.matched_agent }}"
          agent_emoji="${{ steps.match_agent.outputs.agent_emoji }}"
          agent_confidence="${{ steps.match_agent.outputs.agent_confidence }}"
          
          # Create issue title
          issue_title="[Tech Lead Feedback] Address review comments for PR #${pr_number}"
          
          # Create issue body
          issue_body=$(cat <<EOF
> **ðŸ¤– Agent Assignment**
> 
> This issue has been assigned to GitHub Copilot with the **${agent_emoji} @${matched_agent}** custom agent profile.
> 
> **@${matched_agent}** - Please use the specialized approach and tools defined in \`.github/agents/${matched_agent}.md\`.
> 
> **IMPORTANT**: Always mention **@${matched_agent}** by name in all conversations, comments, and PRs related to this issue.

---

## ðŸ“‹ Tech Lead Feedback to Address

**Original PR:** ${pr_url}
**PR Title:** ${pr_title}
**Tech Lead:** @${tech_lead_name} (via @${reviewer})
**Agent Assignment Confidence:** ${agent_confidence}

---

## ðŸ” Review Feedback

${review_body}

---

## âœ… Instructions for @${matched_agent}

1. **Review the feedback** above from **@${tech_lead_name}**
2. **Checkout the PR branch** for PR #${pr_number}
3. **Address each point** mentioned in the review
4. **Commit your changes** with clear commit messages
5. **Push to the same branch** to update PR #${pr_number}
6. **Comment on this issue** when complete with a summary of changes made
7. **Comment on the PR** to notify the tech lead that feedback has been addressed

### Expected Workflow

\`\`\`bash
# 1. Checkout the PR branch
gh pr checkout ${pr_number}

# 2. Make your fixes according to tech lead feedback

# 3. Commit changes
git add .
git commit -m "fix: address @${tech_lead_name} feedback - [specific change]"

# 4. Push to update the PR
git push

# 5. Comment on PR
gh pr comment ${pr_number} --body "@${tech_lead_name}, I've addressed your feedback. Please re-review when convenient."

# 6. Update this issue
gh issue comment [THIS_ISSUE_NUMBER] --body "âœ… Completed fixes for PR #${pr_number}. See PR for details."
\`\`\`

---

## ðŸ”„ Review Cycle

This issue is part of the **Tech Lead Review Cycle**:

1. âœ… Tech Lead reviewed PR #${pr_number}
2. âœ… Feedback extracted and analyzed
3. âœ… **@${matched_agent}** assigned to make fixes (YOU ARE HERE)
4. â³ Agent makes fixes and updates PR
5. â³ Tech Lead re-reviews
6. â³ Repeat until approved or PR merged

---

## ðŸ“Ž Related Links

- **PR to Fix:** ${pr_url}
- **Tech Lead Profile:** \`.github/agents/${tech_lead_name}.md\`
- **Agent Profile:** \`.github/agents/${matched_agent}.md\`
- **Review Cycle Docs:** \`docs/TECH_LEAD_REVIEW_CYCLE.md\`

---

*ðŸ¤– Automated issue created by Tech Lead Feedback Handler*
*Agent: @${matched_agent} | Tech Lead: @${tech_lead_name} | PR: #${pr_number}*
EOF
)
          
          # Create the issue
          echo "Creating follow-up issue for @${matched_agent}..."
          
          issue_url=$(gh issue create \
            --repo ${{ github.repository }} \
            --title "${issue_title}" \
            --body "${issue_body}" \
            --label "tech-lead-feedback,agent:${matched_agent},linked-to-pr" \
            --assignee copilot)
          
          issue_number=$(echo "${issue_url}" | grep -oP '\d+$')
          
          echo "issue_number=${issue_number}" >> $GITHUB_OUTPUT
          echo "issue_url=${issue_url}" >> $GITHUB_OUTPUT
          
          echo "âœ… Created issue #${issue_number}: ${issue_url}"

      - name: Link issue to PR
        if: steps.get_info.outputs.has_wip == 'false' && steps.create_issue.outputs.issue_number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          pr_number="${{ steps.get_info.outputs.pr_number }}"
          issue_number="${{ steps.create_issue.outputs.issue_number }}"
          issue_url="${{ steps.create_issue.outputs.issue_url }}"
          matched_agent="${{ steps.match_agent.outputs.matched_agent }}"
          tech_lead_name="${{ steps.check_tech_lead.outputs.tech_lead_name }}"
          
          # Comment on PR to link the follow-up issue
          gh pr comment ${pr_number} --repo ${{ github.repository }} --body "## ðŸ¤– Tech Lead Feedback Processing

**@${tech_lead_name}** requested changes. A follow-up issue has been created for **@${matched_agent}** to address the feedback.

**Follow-up Issue:** ${issue_url}

**@${matched_agent}** will:
1. Review the feedback
2. Make necessary fixes
3. Update this PR with changes
4. Notify when ready for re-review

---

*Automated by Tech Lead Feedback Handler*"
          
          echo "âœ… Linked issue #${issue_number} to PR #${pr_number}"

      - name: Update tech-lead-changes-requested label
        if: steps.get_info.outputs.has_wip == 'false' && steps.create_issue.outputs.issue_number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          pr_number="${{ steps.get_info.outputs.pr_number }}"
          
          # Ensure tech-lead-changes-requested label is present
          echo "Adding tech-lead-changes-requested label to PR #${pr_number}"
          gh pr edit ${pr_number} --add-label "tech-lead-changes-requested" --repo ${{ github.repository }} || true
          
          echo "âœ… Updated PR labels"

      - name: Post summary
        if: steps.get_info.outputs.has_wip == 'false' && steps.create_issue.outputs.issue_number != ''
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
## ðŸ¤– Tech Lead Feedback Processed

**PR:** #${{ steps.get_info.outputs.pr_number }}
**Tech Lead:** @${{ steps.check_tech_lead.outputs.tech_lead_name }}
**Assigned Agent:** @${{ steps.match_agent.outputs.matched_agent }}

**Created Follow-up Issue:** #${{ steps.create_issue.outputs.issue_number }}
${{ steps.create_issue.outputs.issue_url }}

### Next Steps

1. **@${{ steps.match_agent.outputs.matched_agent }}** will address the feedback
2. PR #${{ steps.get_info.outputs.pr_number }} will be updated with fixes
3. **@${{ steps.check_tech_lead.outputs.tech_lead_name }}** will be notified for re-review

---

*Tech Lead Review Cycle active - automated feedback loop in progress*
EOF
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Tech Lead Feedback Handler completed successfully"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Follow-up issue: ${{ steps.create_issue.outputs.issue_url }}"
          echo "Assigned to: @${{ steps.match_agent.outputs.matched_agent }}"
          echo ""
