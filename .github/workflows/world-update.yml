name: World Model Update

on:
  schedule:
    # Run every 2 hours
    - cron: '0 */2 * * *'
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: write
  pull-requests: write

jobs:
  update-world:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
      
      - name: Sync agents from registry to world
        run: |
          python3 world/sync_agents_to_world.py
      
      - name: Sync learnings to world ideas
        run: |
          python3 world/sync_learnings_to_ideas.py || echo "No learnings to sync (OK)"
      
      - name: Update agent state
        run: |
          python3 scripts/update_agent.py
      
      - name: Sync world data to docs
        run: |
          # Ensure docs/world directory exists
          mkdir -p docs/world
          
          # Copy world data files to docs for GitHub Pages
          cp world/world_state.json docs/world/
          cp world/knowledge.json docs/world/
          
          echo "âœ… Synced world data to docs/world for GitHub Pages"
      
      - name: Check for changes
        id: check_changes
        run: |
          git add world/ docs/world/
          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes to commit"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected"
          fi
      
      - name: Create issue for world model update
        if: steps.check_changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Extract current tick value for issue body
          CURRENT_TICK=$(python3 -c "import json; print(json.load(open('world/world_state.json'))['tick'])" 2>/dev/null || echo "N/A")
          TODAY=$(date +%Y-%m-%d)
          
          # Check if there's already an open issue for today's world model update
          EXISTING_ISSUE=$(gh issue list \
            --label "world-model,automated" \
            --search "ðŸŒ World Model Update in:title is:open created:>=$TODAY" \
            --json number \
            --jq '.[0].number // ""' 2>/dev/null || echo "")
          
          if [ -n "$EXISTING_ISSUE" ]; then
            echo "â­ï¸  Issue already exists for today's world model update: #$EXISTING_ISSUE"
            echo "Skipping issue creation to avoid duplicates"
            
            # Discard the changes since we're not creating a PR yet
            git reset --hard HEAD
          else
            echo "Creating issue for world model update..."
            
            # Create temporary file for issue body to avoid YAML parsing issues
            TEMP_BODY_FILE=$(mktemp)
            cat > "$TEMP_BODY_FILE" <<'EOF'
## World Model Update Request

The world model has pending updates that need to be committed.

### Changes Detected
- Agent positions updated
- World tick incremented (current tick: **${CURRENT_TICK}**)
- Agent state synchronized
- Learnings synchronized to world ideas
- World data synced to docs/world for GitHub Pages

### Task
Please create a PR with the current world model updates.

**Files to Update:**
- `world/world_state.json`
- `world/knowledge.json`
- `docs/world/world_state.json`
- `docs/world/knowledge.json`

**Steps:**
1. Run the world sync scripts to generate latest state:
   - `python3 world/sync_agents_to_world.py`
   - `python3 world/sync_learnings_to_ideas.py`
   - `python3 scripts/update_agent.py`
   - Copy `world/world_state.json` and `world/knowledge.json` to `docs/world/`
2. Commit the changes with message: `chore: world model update - tick ${CURRENT_TICK}`
3. Create PR with title: `ðŸŒ World Model Update - ${TODAY}`

**PR Labels:**
- `automated`
- `world-model`

---
*ðŸ¤– This issue will be automatically assigned to **@investigate-champion** for implementation*
EOF
            
            # Substitute variables in the temp file
            sed -i "s/\${CURRENT_TICK}/${CURRENT_TICK}/g" "$TEMP_BODY_FILE"
            sed -i "s/\${TODAY}/${TODAY}/g" "$TEMP_BODY_FILE"
            
            # Create issue that will be auto-assigned to Copilot
            gh issue create \
              --title "ðŸŒ World Model Update - ${TODAY}" \
              --body-file "$TEMP_BODY_FILE" \
              --label "world-model" \
              --label "automated" \
              --label "ai-generated"
            
            # Clean up temp file
            rm "$TEMP_BODY_FILE"
            
            echo "âœ… Issue created for world model update"
            
            # Discard the changes since we're creating an issue instead of a PR
            git reset --hard HEAD
          fi
