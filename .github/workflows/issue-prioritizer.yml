name: "Issue Prioritizer: Multi-Armed Bandit"

on:
  # Run when new issues are opened or labeled
  issues:
    types: [opened, labeled]
  
  # Run daily to update priorities
  schedule:
    - cron: '0 12 * * *'  # Daily at noon UTC
  
  # Allow manual triggering
  workflow_dispatch:

permissions:
  issues: write
  contents: read

jobs:
  prioritize-issues:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install PyYAML

      - name: Update bandit state from history
        run: |
          python3 tools/issue-prioritizer.py update
          echo "âœ… Updated multi-armed bandit state from historical data"

      - name: Show current statistics
        run: |
          echo "## Current Multi-Armed Bandit Statistics"
          python3 tools/issue-prioritizer.py stats

      - name: Prioritize new issue
        if: github.event_name == 'issues' && github.event.action == 'opened'
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          # Get issue labels
          LABELS=$(gh issue view $ISSUE_NUMBER --json labels --jq '.labels[].name' | tr '\n' ' ')
          
          # Prioritize the issue
          RESULT=$(python3 tools/issue-prioritizer.py prioritize \
            --issue-number $ISSUE_NUMBER \
            --title "$ISSUE_TITLE" \
            --body "$ISSUE_BODY" \
            --labels $LABELS)
          
          echo "$RESULT"
          echo "PRIORITY_RESULT=$RESULT" >> $GITHUB_ENV
          
          # Extract key values
          PRIORITY_SCORE=$(echo "$RESULT" | jq -r '.priority_score')
          PRIORITY_TIER=$(echo "$RESULT" | jq -r '.priority_tier')
          ISSUE_TYPE=$(echo "$RESULT" | jq -r '.issue_type')
          ACTION=$(echo "$RESULT" | jq -r '.recommended_action')
          
          echo "PRIORITY_SCORE=$PRIORITY_SCORE" >> $GITHUB_ENV
          echo "PRIORITY_TIER=$PRIORITY_TIER" >> $GITHUB_ENV
          echo "ISSUE_TYPE=$ISSUE_TYPE" >> $GITHUB_ENV
          echo "RECOMMENDED_ACTION=$ACTION" >> $GITHUB_ENV
        
      - name: Add priority label
        if: github.event_name == 'issues' && github.event.action == 'opened'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          # Add priority tier as label (normalized)
          LABEL=$(echo "$PRIORITY_TIER" | tr '[:upper:]' '[:lower:]')
          gh issue edit $ISSUE_NUMBER --add-label "priority:$LABEL"
          
          # Also add issue type label
          gh issue edit $ISSUE_NUMBER --add-label "type:$ISSUE_TYPE"
          
          echo "âœ… Added labels: priority:$LABEL, type:$ISSUE_TYPE"

      - name: Comment with priority analysis
        if: github.event_name == 'issues' && github.event.action == 'opened'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          # Get UCB1 stats
          ATTEMPTS=$(echo "$PRIORITY_RESULT" | jq -r '.ucb1_stats.attempts')
          AVG_REWARD=$(echo "$PRIORITY_RESULT" | jq -r '.ucb1_stats.avg_reward')
          
          # Create comment with priority analysis
          cat << EOF > comment.md
          ## ðŸŽ¯ Autonomous Priority Analysis
          
          This issue has been analyzed using a **multi-armed bandit algorithm** that learns from historical data.
          
          ### Priority Assessment
          
          - **Priority Score:** \`$PRIORITY_SCORE\` (0.0 - 1.0 scale)
          - **Priority Tier:** \`$PRIORITY_TIER\`
          - **Issue Type:** \`$ISSUE_TYPE\`
          - **Recommended Action:** $RECOMMENDED_ACTION
          
          ### Learning Stats
          
          The algorithm has processed **$ATTEMPTS** similar issues with an average success rate of **$AVG_REWARD**.
          
          ---
          
          *ðŸ¤– This prioritization uses Upper Confidence Bound (UCB1) algorithm to balance exploration and exploitation. The system learns from each resolved issue to improve future prioritization.*
          
          *Generated by @accelerate-master autonomous issue prioritizer*
          EOF
          
          gh issue comment $ISSUE_NUMBER --body-file comment.md
          echo "âœ… Added priority analysis comment"

      - name: Generate daily priority report
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get all open issues
          gh issue list --state open --json number,title,labels --limit 100 > open_issues.json
          
          # Prioritize each issue and collect results
          python3 << 'PYTHON_SCRIPT'
          import json
          import subprocess
          
          with open('open_issues.json') as f:
              issues = json.load(f)
          
          prioritized = []
          for issue in issues:
              labels = [label['name'] for label in issue['labels']]
              
              # Run prioritization
              result = subprocess.run([
                  'python3', 'tools/issue-prioritizer.py', 'prioritize',
                  '--issue-number', str(issue['number']),
                  '--title', issue['title'],
                  '--body', '',
                  '--labels', *labels
              ], capture_output=True, text=True)
              
              if result.returncode == 0:
                  priority_data = json.loads(result.stdout)
                  prioritized.append(priority_data)
          
          # Save prioritized issues
          with open('prioritized_issues.json', 'w') as f:
              json.dump(prioritized, f, indent=2)
          
          print(f"âœ… Prioritized {len(prioritized)} open issues")
          PYTHON_SCRIPT

      - name: Create priority dashboard issue
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Generate report from prioritized issues
          python3 << 'PYTHON_SCRIPT'
          import json
          from datetime import datetime
          
          with open('prioritized_issues.json') as f:
              issues = json.load(f)
          
          # Sort by priority score
          issues.sort(key=lambda x: x['priority_score'], reverse=True)
          
          # Group by tier
          tiers = {'P0-Critical': [], 'P1-High': [], 'P2-Medium': [], 'P3-Low': []}
          for issue in issues:
              tier = issue['priority_tier']
              if tier in tiers:
                  tiers[tier].append(issue)
          
          # Generate report
          report = f"""# ðŸŽ¯ Daily Issue Priority Report
          
          **Generated:** {datetime.utcnow().strftime('%Y-%m-%d %H:%M UTC')}
          **Total Open Issues:** {len(issues)}
          
          This report is generated by an autonomous prioritization system using multi-armed bandit algorithms.
          
          ## ðŸ“Š Statistics
          
          - **P0-Critical:** {len(tiers['P0-Critical'])} issues
          - **P1-High:** {len(tiers['P1-High'])} issues
          - **P2-Medium:** {len(tiers['P2-Medium'])} issues
          - **P3-Low:** {len(tiers['P3-Low'])} issues
          
          ## ðŸ”¥ Priority Tiers
          
          """
          
          for tier_name in ['P0-Critical', 'P1-High', 'P2-Medium', 'P3-Low']:
              if tiers[tier_name]:
                  report += f"\n### {tier_name}\n\n"
                  for issue in tiers[tier_name]:
                      report += f"- **#{issue['issue_number']}**: {issue['title']}\n"
                      report += f"  - Type: `{issue['issue_type']}` | Score: `{issue['priority_score']}`\n"
                      report += f"  - Action: {issue['recommended_action']}\n"
          
          report += """
          
          ---
          
          *ðŸ¤– This prioritization uses UCB1 (Upper Confidence Bound) algorithm to learn from historical issue outcomes and balance exploration vs exploitation when assigning priorities.*
          
          *Generated by @accelerate-master autonomous issue prioritizer*
          """
          
          with open('priority_report.md', 'w') as f:
              f.write(report)
          PYTHON_SCRIPT
          
          # Post as issue
          gh issue create \
            --title "ðŸ“Š Daily Issue Priority Report - $(date +%Y-%m-%d)" \
            --body-file priority_report.md \
            --label "automated,priority-report,copilot" || echo "Report issue may already exist"
          
          echo "âœ… Created priority report issue"
