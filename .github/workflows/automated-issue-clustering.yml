name: Automated Issue Clustering

on:
  schedule:
    # Run weekly on Monday at 00:00 UTC
    - cron: '0 0 * * 1'
  workflow_dispatch:
    inputs:
      num_clusters:
        description: 'Number of clusters to create'
        required: false
        default: '5'
      min_cluster_size:
        description: 'Minimum issues per cluster'
        required: false
        default: '2'
  issues:
    types: [opened, labeled, closed]

permissions:
  contents: write
  issues: read
  pull-requests: write

jobs:
  cluster-issues:
    name: Cluster Repository Issues
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      
      - name: Fetch repository issues
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Fetch open issues
          gh issue list \
            --repo ${{ github.repository }} \
            --json number,title,body,labels,state,createdAt,author \
            --limit 200 \
            --state all \
            > /tmp/issues.json
          
          echo "Fetched issues:"
          jq '. | length' /tmp/issues.json
      
      - name: Perform issue clustering
        env:
          NUM_CLUSTERS: ${{ github.event.inputs.num_clusters || '5' }}
          MIN_SIZE: ${{ github.event.inputs.min_cluster_size || '2' }}
        run: |
          # Create output directory
          mkdir -p analysis/clustering
          
          # Run clustering analysis
          python3 tools/issue_clustering_system.py cluster \
            --input /tmp/issues.json \
            --clusters ${NUM_CLUSTERS} \
            --min-size ${MIN_SIZE} \
            --output clustering_results.json \
            --report clustering_report.md
          
          echo "‚úÖ Clustering complete"
      
      - name: Display clustering summary
        run: |
          if [ -f analysis/clustering/clustering_report.md ]; then
            echo "## Clustering Summary"
            head -50 analysis/clustering/clustering_report.md
          fi
      
      - name: Check for changes
        id: check_changes
        run: |
          if [ -f analysis/clustering/clustering_results.json ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
          else
            echo "changes=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Create PR with clustering results
        if: steps.check_changes.outputs.changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Create unique branch
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BRANCH_NAME="automated-clustering/${TIMESTAMP}-${{ github.run_id }}"
          
          # Checkout new branch
          git checkout -b "${BRANCH_NAME}"
          
          # Add clustering results
          git add analysis/clustering/
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          # Commit changes
          git commit -m "chore: update issue clustering analysis (@engineer-master)

          Automated clustering analysis performed by @engineer-master

          - Analyzed ${{ github.event.inputs.num_clusters || '5' }} clusters
          - Minimum cluster size: ${{ github.event.inputs.min_cluster_size || '2' }}
          - Generated clustering report and metrics
          
          This PR was created automatically by the Issue Clustering System."
          
          # Push to new branch
          git push origin "${BRANCH_NAME}"
          
          # Create pull request
          gh pr create \
            --title "chore: update issue clustering analysis (@engineer-master)" \
            --body "## üß† Automated Issue Clustering Update

          **@engineer-master** has performed automated issue clustering analysis.

          ### üìä Analysis Summary

          - **Clusters Created:** ${{ github.event.inputs.num_clusters || '5' }}
          - **Minimum Cluster Size:** ${{ github.event.inputs.min_cluster_size || '2' }}
          - **Trigger:** ${{ github.event_name }}

          ### üìù Changes

          - Updated clustering results in \`analysis/clustering/\`
          - Generated comprehensive clustering report
          - Identified similar issue groups
          - Suggested labels for better organization

          ### üéØ What to Review

          1. Check clustering quality metrics (silhouette score)
          2. Review identified issue categories
          3. Verify suggested labels make sense
          4. Look for actionable insights in recommendations

          ### üìà Next Steps

          - Apply suggested labels to improve organization
          - Consider consolidating duplicate issues
          - Focus efforts on high-volume categories

          ---

          *Generated by Issue Clustering System - @engineer-master*
          *Workflow: [\`automated-issue-clustering.yml\`](.github/workflows/automated-issue-clustering.yml)*" \
            --label "automated,analysis,copilot,agent:engineer-master" \
            --base main \
            --head "${BRANCH_NAME}"
          
          echo "‚úÖ PR created successfully"
      
      - name: Comment on triggering issue
        if: github.event_name == 'issues' && steps.check_changes.outputs.changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get clustering results for this issue
          ISSUE_NUMBER=${{ github.event.issue.number }}
          
          # Try to predict cluster for this issue
          python3 tools/issue_clustering_system.py predict \
            --input /tmp/issues.json \
            --title "${{ github.event.issue.title }}" \
            --body "${{ github.event.issue.body }}" \
            > /tmp/prediction.txt || echo "Prediction not available" > /tmp/prediction.txt
          
          # Post comment
          gh issue comment ${ISSUE_NUMBER} --body "## üß† Issue Clustering Analysis

          **@engineer-master** has analyzed this issue using the clustering system.

          $(cat /tmp/prediction.txt)

          This issue has been included in the latest clustering analysis. A PR with updated clustering results will be created shortly.

          ---
          *Automated by Issue Clustering System - @engineer-master*"
      
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: clustering-results
          path: |
            analysis/clustering/
            /tmp/issues.json
          retention-days: 30

  notify-completion:
    name: Notify Completion
    runs-on: ubuntu-latest
    needs: cluster-issues
    if: always()
    
    steps:
      - name: Report status
        run: |
          if [ "${{ needs.cluster-issues.result }}" == "success" ]; then
            echo "‚úÖ Issue clustering completed successfully"
          else
            echo "‚ùå Issue clustering failed"
            exit 1
          fi
