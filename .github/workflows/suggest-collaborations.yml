name: "Agent Collaboration: Suggest Helpers"

on:
  issues:
    types: [opened, edited, labeled]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to analyze for collaboration'
        required: true
        type: string

permissions:
  contents: read
  issues: write

jobs:
  suggest-collaborations:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: Analyze issue and suggest collaborators
        id: analyze
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number || inputs.issue_number }}
        run: |
          python3 << 'PYEOF'
          import json
          import os
          import sys
          import subprocess
          import re
          from datetime import datetime
          
          # Add world directory to path
          sys.path.insert(0, 'world')
          
          try:
              from agent_collaboration_manager import (
                  AgentCollaborationManager,
                  CollaborationType,
                  CollaborationRequest
              )
              from agent_learning_matcher import AgentLearningMatcher
              from agent_investment_tracker import AgentInvestmentTracker
              
              print("=" * 70)
              print("ü§ù Agent Collaboration Suggester")
              print("=" * 70)
              print()
              
              # Get issue details
              issue_number = os.getenv('ISSUE_NUMBER')
              
              print(f"üîç Analyzing issue #{issue_number}")
              
              # Fetch issue details using gh CLI
              result = subprocess.run(
                  [
                      'gh', 'issue', 'view', issue_number,
                      '--json', 'title,body,labels,assignees'
                  ],
                  capture_output=True,
                  text=True
              )
              
              if result.returncode != 0:
                  print(f"‚ùå Failed to fetch issue: {result.stderr}")
                  sys.exit(1)
              
              issue_data = json.loads(result.stdout)
              title = issue_data.get('title', '')
              body = issue_data.get('body', '')
              labels = [l['name'] for l in issue_data.get('labels', [])]
              assignees = [a['login'] for a in issue_data.get('assignees', [])]
              
              print(f"   Title: {title[:60]}...")
              print(f"   Labels: {', '.join(labels) if labels else 'none'}")
              print(f"   Assignees: {', '.join(assignees) if assignees else 'none'}")
              print()
              
              # Extract primary agent (assignee or from label)
              primary_agent = None
              
              # Check assignees first (prefer agent IDs)
              for assignee in assignees:
                  if any(suffix in assignee for suffix in ['master', 'specialist', 'guru', 'champion', 'wizard', 'expert', 'ninja', 'pro']):
                      primary_agent = assignee
                      break
              
              # Check labels
              if not primary_agent:
                  for label in labels:
                      if label.startswith('agent:'):
                          primary_agent = label.split(':', 1)[1]
                          break
              
              # Extract from body/title
              if not primary_agent:
                  agent_pattern = r'@([\w-]+(?:master|specialist|guru|champion|wizard|expert|ninja|pro))'
                  matches = re.findall(agent_pattern, title + ' ' + body)
                  if matches:
                      primary_agent = matches[0]
              
              if not primary_agent:
                  print("‚ö†Ô∏è  No primary agent identified")
                  print("   Skipping collaboration suggestions")
                  with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                      f.write("has_suggestions=false\n")
                  sys.exit(0)
              
              print(f"ü§ñ Primary agent: @{primary_agent}")
              print()
              
              # Initialize systems
              manager = AgentCollaborationManager()
              matcher = AgentLearningMatcher()
              tracker = AgentInvestmentTracker()
              
              # Integrate systems
              manager.integrate_investment_tracker(tracker)
              manager.integrate_learning_matcher(matcher)
              
              # Determine learning categories from issue content
              combined_text = f"{title} {body}".lower()
              
              # Extract category from labels
              category_labels = []
              for label in labels:
                  if label.startswith('category:'):
                      cat = label.split(':', 1)[1].title()
                      category_map = {
                          'ai': 'AI_ML',
                          'ml': 'AI_ML',
                          'devops': 'DevOps',
                          'database': 'Database',
                          'web': 'Web',
                          'security': 'Security',
                          'performance': 'Performance',
                          'tools': 'Tools',
                          'opensource': 'OpenSource'
                      }
                      category_labels.append(category_map.get(cat.lower(), cat))
              
              # Infer categories from content
              inferred_categories = []
              for category, info in matcher.categories.items():
                  keywords = info.get('keywords', [])
                  keyword_matches = sum(1 for kw in keywords if kw in combined_text)
                  if keyword_matches >= 2:
                      inferred_categories.append((category, keyword_matches))
              
              inferred_categories.sort(key=lambda x: x[1], reverse=True)
              top_inferred = [cat for cat, _ in inferred_categories[:2]]
              
              # Combine
              all_categories = list(set(category_labels + top_inferred))
              primary_category = all_categories[0] if all_categories else 'Programming'
              
              print(f"üìö Detected categories: {', '.join(all_categories)}")
              print(f"   Primary: {primary_category}")
              print()
              
              # Determine collaboration type from labels and content
              collab_type = CollaborationType.CONSULTATION  # Default
              
              if any(label in labels for label in ['bug', 'debugging', 'troubleshooting']):
                  collab_type = CollaborationType.DEBUGGING
              elif 'code-review' in labels or 'review' in combined_text:
                  collab_type = CollaborationType.CODE_REVIEW
              elif 'pair-programming' in labels or 'pairing' in combined_text:
                  collab_type = CollaborationType.PAIR_PROGRAMMING
              elif 'research' in labels or 'investigation' in combined_text:
                  collab_type = CollaborationType.RESEARCH
              elif 'learning' in labels or 'knowledge-share' in combined_text:
                  collab_type = CollaborationType.KNOWLEDGE_SHARE
              
              print(f"ü§ù Collaboration type: {collab_type.value}")
              print()
              
              # Find potential helpers
              print("üîç Finding potential helpers...")
              helpers = manager.find_helpers(
                  topic=title,
                  learning_category=primary_category,
                  collaboration_type=collab_type,
                  exclude_agents=[primary_agent],
                  max_results=5
              )
              
              if not helpers:
                  print("   No suitable helpers found")
                  with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                      f.write("has_suggestions=false\n")
                  sys.exit(0)
              
              print(f"   Found {len(helpers)} potential helpers:")
              for helper, score in helpers:
                  print(f"   - @{helper} (match: {score:.2f})")
              print()
              
              # Save suggestions
              suggestions_data = {
                  'issue_number': issue_number,
                  'primary_agent': primary_agent,
                  'primary_category': primary_category,
                  'all_categories': all_categories,
                  'collab_type': collab_type.value,
                  'helpers': [{'agent': h, 'score': s} for h, s in helpers]
              }
              
              with open('/tmp/collaboration_suggestions.json', 'w') as f:
                  json.dump(suggestions_data, f, indent=2)
              
              # Set outputs
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write("has_suggestions=true\n")
                  f.write(f"helper_count={len(helpers)}\n")
              
              print("‚úÖ Analysis complete")
              
          except Exception as e:
              print(f"‚ùå Error: {e}")
              import traceback
              traceback.print_exc()
              sys.exit(1)
          PYEOF
      
      - name: Post collaboration suggestions as comment
        if: steps.analyze.outputs.has_suggestions == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 << 'PYEOF'
          import json
          import os
          import subprocess
          import sys
          
          # Add world directory to path
          sys.path.insert(0, 'world')
          
          try:
              from agent_collaboration_manager import AgentCollaborationManager
              
              # Load suggestions
              with open('/tmp/collaboration_suggestions.json') as f:
                  data = json.load(f)
              
              issue_number = data['issue_number']
              primary_agent = data['primary_agent']
              primary_category = data['primary_category']
              all_categories = data['all_categories']
              collab_type = data['collab_type']
              helpers = data['helpers']
              
              # Build comment
              comment = f"""## ü§ù Collaboration Suggestions for @{primary_agent}

          Based on the content of this issue, here are some agents who might be able to help:

          ### üéØ Recommended Collaborators

          """
              
              for i, helper_info in enumerate(helpers[:3], 1):
                  agent = helper_info['agent']
                  score = helper_info['score']
                  
                  # Describe why this helper is a good match
                  if score >= 0.8:
                      match_desc = "**Excellent match**"
                  elif score >= 0.6:
                      match_desc = "**Good match**"
                  else:
                      match_desc = "**Potential helper**"
                  
                  comment += f"""
          **{i}. @{agent}** - {match_desc} (score: {score:.2f})
          """
              
              comment += f"""

          ### üìö Collaboration Details

          - **Type:** `{collab_type}`
          - **Primary category:** {primary_category}
          - **All categories:** {', '.join(all_categories)}

          ### üöÄ How to Request Collaboration

          To request help from any of these agents, you can:

          1. **Mention them** in a comment: `@agent-name, could you help with...`
          2. **Create a collaboration request** using the Agent Collaboration Manager
          3. **Add labels** like `collaboration-request` and tag the helper

          ### üí° Why These Suggestions?

          These agents were selected based on:
          - ‚úÖ Expertise in relevant learning categories
          - ‚úÖ Investment levels and specializations
          - ‚úÖ Availability and collaboration history
          - ‚úÖ Match with the collaboration type needed

          """
              
              # Add a note about creating formal requests
              if len(helpers) > 3:
                  comment += f"""
          **Note:** {len(helpers)} total potential helpers were found. The top 3 are shown above.
          """
              
              comment += """

          ---

          *ü§ñ Automated collaboration suggestions via Agent Collaboration Manager*
          """
              
              # Post comment
              result = subprocess.run(
                  ['gh', 'issue', 'comment', issue_number, '--body', comment],
                  capture_output=True,
                  text=True
              )
              
              if result.returncode == 0:
                  print(f"‚úÖ Posted collaboration suggestions to issue #{issue_number}")
              else:
                  print(f"‚ùå Failed to post comment: {result.stderr}")
                  sys.exit(1)
              
          except Exception as e:
              print(f"‚ùå Error posting suggestions: {e}")
              import traceback
              traceback.print_exc()
              sys.exit(1)
          PYEOF
      
      - name: Create collaboration request (optional)
        if: steps.analyze.outputs.has_suggestions == 'true' && contains(github.event.issue.labels.*.name, 'collaboration-request')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 << 'PYEOF'
          import json
          import os
          import subprocess
          import sys
          from datetime import datetime
          
          # Add world directory to path
          sys.path.insert(0, 'world')
          
          try:
              from agent_collaboration_manager import (
                  AgentCollaborationManager,
                  CollaborationType,
                  CollaborationStatus
              )
              
              # Load suggestions
              with open('/tmp/collaboration_suggestions.json') as f:
                  data = json.load(f)
              
              issue_number = data['issue_number']
              primary_agent = data['primary_agent']
              primary_category = data['primary_category']
              collab_type_str = data['collab_type']
              helpers = data['helpers']
              
              if not helpers:
                  print("No helpers to create requests for")
                  sys.exit(0)
              
              # Initialize manager
              manager = AgentCollaborationManager()
              
              # Create collaboration request for top helper
              top_helper = helpers[0]['agent']
              
              # Get issue title and body for context
              result = subprocess.run(
                  ['gh', 'issue', 'view', issue_number, '--json', 'title,body'],
                  capture_output=True,
                  text=True
              )
              
              if result.returncode == 0:
                  issue_data = json.loads(result.stdout)
                  title = issue_data.get('title', '')
                  body = issue_data.get('body', '')
              else:
                  title = f"Issue #{issue_number}"
                  body = ""
              
              # Create request
              collab_type = CollaborationType(collab_type_str)
              
              request = manager.create_request(
                  requester=primary_agent,
                  helper=top_helper,  # Pre-assign to top match
                  collaboration_type=collab_type,
                  topic=title,
                  description=f"Help needed on issue #{issue_number}. {body[:200]}...",
                  learning_category=primary_category,
                  context={'issue_number': issue_number, 'github_issue': True},
                  priority=0.7,
                  estimated_duration=2.0
              )
              
              manager.save()
              
              print(f"‚úÖ Created collaboration request: {request.request_id}")
              print(f"   Requester: @{primary_agent}")
              print(f"   Helper: @{top_helper}")
              print(f"   Type: {collab_type.value}")
              
              # Post notification comment
              comment = f"""## üéâ Collaboration Request Created

          A formal collaboration request has been created:

          - **Request ID:** `{request.request_id}`
          - **Requester:** @{primary_agent}
          - **Helper:** @{top_helper}
          - **Type:** {collab_type.value}
          - **Category:** {primary_category}

          @{top_helper}, you've been identified as the best match to help with this issue. Please review and accept the collaboration if you're available!

          ---

          *ü§ñ Automated collaboration request via Agent Collaboration Manager*
          """
              
              result = subprocess.run(
                  ['gh', 'issue', 'comment', issue_number, '--body', comment],
                  capture_output=True,
                  text=True
              )
              
              if result.returncode == 0:
                  print(f"‚úÖ Posted collaboration request notification")
              
          except Exception as e:
              print(f"‚ö†Ô∏è  Error creating collaboration request: {e}")
              import traceback
              traceback.print_exc()
              # Don't fail the workflow
          PYEOF
      
      - name: Summary
        if: always()
        run: |
          if [ -f /tmp/collaboration_suggestions.json ]; then
            python3 << 'PYEOF'
          import json
          
          with open('/tmp/collaboration_suggestions.json') as f:
              data = json.load(f)
          
          print("=" * 70)
          print("üìä Collaboration Suggestion Summary")
          print("=" * 70)
          print()
          print(f"Issue: #{data['issue_number']}")
          print(f"Primary agent: @{data['primary_agent']}")
          print(f"Helpers suggested: {len(data['helpers'])}")
          print()
          print("Top suggestions:")
          for helper in data['helpers'][:3]:
              print(f"  - @{helper['agent']} (score: {helper['score']:.2f})")
          PYEOF
          fi
