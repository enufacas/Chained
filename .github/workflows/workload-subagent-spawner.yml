name: ðŸ¤– Workload-Based Sub-Agent Spawner

on:
  schedule:
    # Run every 6 hours (4 times per day)
    - cron: '0 */6 * * *'
  
  workflow_dispatch:
    inputs:
      max_spawns:
        description: 'Maximum agents to spawn'
        required: false
        default: '5'
      dry_run:
        description: 'Dry run (no actual spawning)'
        required: false
        default: 'false'

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  analyze-and-spawn:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install PyYAML requests beautifulsoup4 lxml psutil
      
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Fetch current issues and PRs
        id: fetch_workload
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Fetching open issues..."
          gh issue list --json number,title,labels,state --limit 100 > /tmp/issues.json
          
          echo "Fetching open PRs..."
          gh pr list --json number,title,labels,state --limit 100 > /tmp/prs.json
          
          echo "Issues fetched: $(jq length /tmp/issues.json)"
          echo "PRs fetched: $(jq length /tmp/prs.json)"
      
      - name: Analyze workload
        id: analyze
        run: |
          echo "ðŸ” Analyzing system workload..."
          
          python3 tools/workload_monitor.py \
            --output .github/agent-system/workload_analysis.json \
            --report \
            --max-spawns ${{ github.event.inputs.max_spawns || '5' }}
          
          # Check if spawning is needed
          NEEDS_SPAWN=$(jq -r '.summary.spawning_needed' .github/agent-system/workload_analysis.json)
          RECOMMENDED=$(jq -r '.summary.recommended_spawns' .github/agent-system/workload_analysis.json)
          
          echo "needs_spawn=$NEEDS_SPAWN" >> $GITHUB_OUTPUT
          echo "recommended_spawns=$RECOMMENDED" >> $GITHUB_OUTPUT
          
          if [ "$NEEDS_SPAWN" = "true" ]; then
            echo "âš ï¸  Spawning needed: $RECOMMENDED agent(s)"
          else
            echo "âœ… System is balanced - no spawning needed"
          fi
      
      - name: Spawn sub-agents
        if: steps.analyze.outputs.needs_spawn == 'true'
        id: spawn
        run: |
          echo "ðŸš€ Spawning sub-agents based on workload analysis..."
          
          DRY_RUN_FLAG=""
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            DRY_RUN_FLAG="--dry-run"
            echo "ðŸ” DRY RUN MODE"
          fi
          
          python3 tools/workload_subagent_spawner.py \
            --analysis .github/agent-system/workload_analysis.json \
            --max-spawns ${{ github.event.inputs.max_spawns || '5' }} \
            --report \
            $DRY_RUN_FLAG | tee /tmp/spawn_report.txt
          
          # Count spawned agents
          SPAWNED=$(grep -c "âœ… Created:" /tmp/spawn_report.txt || echo "0")
          echo "spawned_count=$SPAWNED" >> $GITHUB_OUTPUT
          
          echo "âœ… Spawned $SPAWNED agent(s)"
      
      - name: Commit and push changes
        if: steps.analyze.outputs.needs_spawn == 'true' && github.event.inputs.dry_run != 'true'
        run: |
          # Add workload analysis and agent profiles
          git add .github/agent-system/
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸ¤– Workload-based sub-agent spawn: ${{ steps.spawn.outputs.spawned_count }} agent(s)

Automated spawning triggered by workload analysis.

- Analyzed workload across specializations
- Identified bottlenecks in: $(jq -r '.recommendations[].specialization' .github/agent-system/workload_analysis.json | tr '\n' ', ' | sed 's/,$//')
- Spawned ${{ steps.spawn.outputs.spawned_count }} sub-agent(s) to address workload

Generated by: @accelerate-specialist
Workflow: workload-subagent-spawner.yml"
            
            git push
          fi
      
      - name: Create summary issue
        if: steps.analyze.outputs.needs_spawn == 'true' && steps.spawn.outputs.spawned_count > 0
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Read spawn report
          REPORT=$(cat /tmp/spawn_report.txt | tail -50)
          
          # Create issue
          gh issue create \
            --title "ðŸ¤– Sub-Agent Spawn Report: ${{ steps.spawn.outputs.spawned_count }} agent(s) spawned" \
            --label "automated,agent-system,workload-optimization" \
            --body "## Workload-Based Sub-Agent Spawning

**Timestamp:** $(date -u +%Y-%m-%dT%H:%M:%SZ)
**Spawned Agents:** ${{ steps.spawn.outputs.spawned_count }}
**Recommended:** ${{ steps.analyze.outputs.recommended_spawns }}

### Workload Analysis Summary

\`\`\`json
$(jq '.summary' .github/agent-system/workload_analysis.json)
\`\`\`

### Spawning Recommendations

$(jq -r '.recommendations[] | \"- **\(.specialization)**: \(.count) agent(s) (Priority: \(.priority))\"' .github/agent-system/workload_analysis.json)

### Spawn Report

\`\`\`
$REPORT
\`\`\`

### Analysis Details

View full workload analysis at: \`.github/agent-system/workload_analysis.json\`

---

*ðŸ¤– Created by workflow: [workload-subagent-spawner.yml](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*
*Generated by @accelerate-specialist - Intelligent workload optimization*"
      
      - name: Post summary
        if: always()
        run: |
          echo "## ðŸ“Š Workload Analysis Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f .github/agent-system/workload_analysis.json ]; then
            echo "**Spawning Needed:** ${{ steps.analyze.outputs.needs_spawn }}" >> $GITHUB_STEP_SUMMARY
            echo "**Recommended Spawns:** ${{ steps.analyze.outputs.recommended_spawns }}" >> $GITHUB_STEP_SUMMARY
            
            if [ "${{ steps.analyze.outputs.needs_spawn }}" = "true" ]; then
              echo "**Actually Spawned:** ${{ steps.spawn.outputs.spawned_count }}" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Recommendations" >> $GITHUB_STEP_SUMMARY
              jq -r '.recommendations[] | "- **\(.specialization)**: \(.count) agent(s) - \(.reason)"' .github/agent-system/workload_analysis.json >> $GITHUB_STEP_SUMMARY
            else
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âœ… All specializations operating within capacity" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ Analysis file not generated" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Upload analysis artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: workload-analysis-${{ github.run_number }}
          path: |
            .github/agent-system/workload_analysis.json
            /tmp/spawn_report.txt
          retention-days: 30
