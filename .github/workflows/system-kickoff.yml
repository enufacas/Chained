name: "System: Kickoff"

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      trigger_initial_workflows:
        description: 'Trigger initial workflows after kickoff'
        required: false
        type: boolean
        default: true
      create_labels:
        description: 'Create required labels'
        required: false
        type: boolean
        default: true
      force_kickoff:
        description: 'Force kickoff even if already completed'
        required: false
        type: boolean
        default: false

permissions:
  issues: write
  contents: write
  actions: write

jobs:
  kickoff:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check if already kicked off
        id: check
        if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.force_kickoff != true)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if kickoff issue exists
          if gh issue list --state all --label "automated,completed" --search "System Kickoff Complete" --json title | grep -q "System Kickoff Complete"; then
            echo "already_kicked_off=true" >> $GITHUB_OUTPUT
            echo "System already kicked off. Skipping."
          else
            echo "already_kicked_off=false" >> $GITHUB_OUTPUT
            echo "System not yet kicked off."
          fi

      - name: Skip message
        if: steps.check.outputs.already_kicked_off == 'true'
        run: |
          echo "================================================================"
          echo "System already kicked off - skipping automatic kickoff"
          echo "================================================================"
          echo ""
          echo "The Chained system is already running!"
          echo ""
          echo "To manually trigger workflows, use workflow_dispatch with force_kickoff=true"
          echo ""
          exit 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Run validation
        id: validate
        if: steps.check.outputs.already_kicked_off != 'true'
        run: |
          echo "Running pre-flight validation..."
          chmod +x validate-system.sh
          ./validate-system.sh || {
            echo "validation_failed=true" >> $GITHUB_OUTPUT
            exit 0  # Don't fail the job, just mark validation failed
          }
          echo "validation_passed=true" >> $GITHUB_OUTPUT

      - name: Check validation results
        if: steps.check.outputs.already_kicked_off != 'true' && steps.validate.outputs.validation_failed == 'true'
        run: |
          echo "::error::Validation failed. Please fix errors before kickoff."
          exit 1

      - name: Create required labels
        if: steps.check.outputs.already_kicked_off != 'true' && (inputs.create_labels == true || github.event_name == 'push')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Creating required labels..."
          
          # Define labels with colors and descriptions
          declare -A labels=(
            ["ai-generated"]="7057ff:Created by AI Idea Generator"
            ["copilot-assigned"]="0366d6:Assigned to Copilot"
            ["copilot"]="0366d6:Created by Copilot"
            ["automated"]="fbca04:Automated process"
            ["in-progress"]="fbca04:Work in progress"
            ["completed"]="0e8a16:Completed task"
            ["learning"]="d93f0b:Learning or insight"
            ["progress-report"]="c5def5:Progress tracking"
            ["enhancement"]="a2eeef:New feature or request"
            ["workflow-monitor"]="d73a4a:Workflow monitoring alert"
            ["workflow-failure"]="d73a4a:Workflow failure alert"
          )
          
          for label in "${!labels[@]}"; do
            IFS=':' read -r color description <<< "${labels[$label]}"
            
            # Check if label exists
            if gh label list | grep -q $'^'"${label}"$'\t'; then
              echo "âœ“ Label '$label' already exists"
            else
              if gh label create "$label" --color "$color" --description "$description" 2>/dev/null; then
                echo "âœ“ Created label '$label'"
              else
                echo "âš  Could not create label '$label' (may already exist)"
              fi
            fi
          done

      - name: Initialize learnings directory
        if: steps.check.outputs.already_kicked_off != 'true'
        run: |
          echo "Initializing learnings directory..."
          mkdir -p learnings
          
          if [ ! -f "learnings/README.md" ]; then
            cat > learnings/README.md << 'LEARNINGS_EOF'
          # Learning Database

          This directory contains learnings collected from external sources.

          ## Sources

          - **TLDR Tech**: Tech news summaries (twice daily)
          - **Hacker News**: Trending discussions (3x daily)

          ## Format

          Learning files are stored as JSON with the following structure:
          - `timestamp`: When the learning was captured
          - `source`: Where it came from (tldr, hackernews)
          - `topics`: Categorized topics
          - `insights`: Key takeaways
          - `trends`: Identified trends

          ## Usage

          These learnings influence the Smart Idea Generator to create
          trend-aware ideas based on what's happening in the tech world.
          LEARNINGS_EOF
            echo "âœ“ Created learnings/README.md"
          else
            echo "âœ“ learnings/README.md already exists"
          fi

      - name: Commit initialization changes
        if: steps.check.outputs.already_kicked_off != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if git diff --quiet && git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git add learnings/
            git commit -m "Initialize learnings directory [automated]" || echo "Nothing to commit"
            git push || echo "Nothing to push"
          fi

      - name: Verify scheduled workflows
        if: steps.check.outputs.already_kicked_off != 'true' && (inputs.trigger_initial_workflows == true || github.event_name == 'push')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸŽ¯ System Kickoff - Autonomous Workflow Scheduling"
          echo ""
          echo "The Chained system relies on scheduled workflows that run automatically."
          echo "No manual triggering is needed - the system is self-sustaining!"
          echo ""
          echo "ðŸ“‹ Scheduled workflows will run automatically:"
          echo ""
          echo "  ðŸ“š Learning Workflows:"
          echo "    â€¢ learn-from-tldr.yml - 08:00, 20:00 UTC daily"
          echo "    â€¢ learn-from-hackernews.yml - 07:00, 13:00, 19:00 UTC daily"
          echo ""
          echo "  ðŸ’¡ Idea Generation:"
          echo "    â€¢ idea-generator.yml - 09:00 UTC daily"
          echo "    â€¢ smart-idea-generator.yml - 10:00 UTC daily"
          echo ""
          echo "  ðŸ¤– Agent System:"
          echo "    â€¢ agent-spawner.yml - 06:00, 18:00 UTC daily"
          echo "    â€¢ copilot-graphql-assign.yml - Every 15 minutes"
          echo ""
          echo "  ðŸ”„ System Maintenance:"
          echo "    â€¢ auto-review-merge.yml - Every 2 hours"
          echo "    â€¢ system-monitor.yml - Every 3-6 hours"
          echo ""
          echo "âœ… System is ready! Workflows will execute according to their schedules."
          echo ""
          echo "Note: Attempting to manually trigger workflows causes HTTP 403 errors"
          echo "due to GitHub token permissions. The scheduled approach is more reliable."
          echo ""

      - name: Create kickoff success issue
        if: steps.check.outputs.already_kicked_off != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create an issue announcing successful kickoff
          gh issue create \
            --title "ðŸš€ System Kickoff Complete!" \
            --body "## Chained System Started

          The perpetual AI motion machine has been successfully initialized and started!

          **Kickoff Time:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')

          **Workflows Triggered:**
          - âœ… Learn from TLDR Tech
          - âœ… Learn from Hacker News  
          - âœ… AI Idea Generator

          **Status:**
          - All validation checks passed
          - Required labels created
          - Learnings directory initialized
          - Initial workflows triggered

          ## What's Next?

          The autonomous system will now:
          1. Learn from external sources continuously
          2. Generate ideas daily at 10:00 UTC
          3. Create issues from ideas
          4. Convert issues to PRs every 3 hours
          5. Review and merge PRs every 2 hours
          6. Update timeline every 6 hours

          **Monitor Progress:**
          - ðŸ“Š GitHub Pages: View live timeline
          - ðŸ”„ Actions Tab: See workflow runs
          - ðŸ“‹ Issues: Watch AI-generated issues appear
          - ðŸ”€ Pull Requests: See autonomous contributions

          **Check Status:**
          \`\`\`bash
          ./check-status.sh
          \`\`\`

          ---

          This issue was created automatically by the System Kickoff workflow.
          The perpetual motion machine is now running! ðŸŽ‰" \
            --label "automated,completed"

      - name: Generate kickoff summary
        if: steps.check.outputs.already_kicked_off != 'true'
        run: |
          echo "================================================================"
          echo "ðŸŽ‰ KICKOFF COMPLETE!"
          echo "================================================================"
          echo ""
          echo "The Chained perpetual AI motion machine is now running!"
          echo ""
          echo "âœ“ Validation passed"
          echo "âœ“ Labels created"
          echo "âœ“ Learnings initialized"
          echo "âœ“ Workflows triggered"
          echo ""
          echo "Monitor progress:"
          echo "  â€¢ Actions: ${{ github.server_url }}/${{ github.repository }}/actions"
          echo "  â€¢ Issues: ${{ github.server_url }}/${{ github.repository }}/issues"
          echo "  â€¢ PRs: ${{ github.server_url }}/${{ github.repository }}/pulls"
          echo ""
          echo "The autonomous cycle has begun! ðŸš€"
          echo ""
