name: "Demos & Experiments"

# Consolidated workflow for demonstration and experimental features
# Created by @workflows-tech-lead
#
# This workflow consolidates:
# - nl-to-code-demo.yml: Natural Language to Code Translation
# - tech-lead-review-poc.yml: Tech Lead Review System PoC
#
# Each experiment can be triggered independently via workflow_dispatch

on:
  # Issue labeled for NL to Code translation
  issues:
    types: [labeled]
  
  # PR events for Tech Lead review
  pull_request:
    types: [opened, ready_for_review, synchronize]
  
  # Manual triggers with stage selection
  workflow_dispatch:
    inputs:
      stage:
        description: 'Which demo/experiment to run'
        required: true
        type: choice
        default: 'nl-to-code'
        options:
          - nl-to-code
          - tech-lead-review
      issue_number:
        description: 'Issue number (for nl-to-code stage)'
        required: false
        type: string
      pr_number:
        description: 'PR number (for tech-lead-review stage)'
        required: false
        type: string

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  # Stage 1: Natural Language to Code Translation
  nl-to-code-translation:
    name: "Natural Language to Code"
    runs-on: ubuntu-latest
    # Run on label event, or manual trigger with nl-to-code stage
    if: |
      (github.event_name == 'issues' && github.event.label.name == 'translate-to-code') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.stage == 'nl-to-code')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: Get issue details
        id: issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            issue_number="${{ github.event.inputs.issue_number }}"
          else
            issue_number="${{ github.event.issue.number }}"
          fi
          
          echo "issue_number=$issue_number" >> $GITHUB_OUTPUT
          
          # Get issue body
          issue_body=$(gh issue view "$issue_number" --json body --jq '.body')
          
          # Save to file for processing
          echo "$issue_body" > /tmp/issue_body.txt
          
          echo "Issue $issue_number will be translated"
      
      - name: Translate issue to code
        id: translate
        run: |
          # Run the translator
          python3 tools/nl-to-code-translator.py /tmp/issue_body.txt --json > /tmp/translation.json
          
          # Extract key information
          intent=$(python3 -c "import json; data=json.load(open('/tmp/translation.json')); print(data['intent'])")
          confidence=$(python3 -c "import json; data=json.load(open('/tmp/translation.json')); print(data['confidence'])")
          entity_count=$(python3 -c "import json; data=json.load(open('/tmp/translation.json')); print(data['metadata']['entity_count'])")
          
          echo "intent=$intent" >> $GITHUB_OUTPUT
          echo "confidence=$confidence" >> $GITHUB_OUTPUT
          echo "entity_count=$entity_count" >> $GITHUB_OUTPUT
          
          echo "Translation complete: intent=$intent, confidence=$confidence"
      
      - name: Format results
        id: format
        run: |
          python3 << 'PYTHON_SCRIPT'
          import json
          import sys
          
          # Load translation result
          with open('/tmp/translation.json', 'r') as f:
              result = json.load(f)
          
          # Format entities
          entities_md = ""
          if result['entities']:
              entities_md = "\n### ðŸ” Extracted Entities\n\n"
              for entity in result['entities']:
                  entities_md += f"- **{entity['type']}**: `{entity['name']}` (confidence: {entity['confidence']:.2f})\n"
          
          # Format file suggestions
          files_md = ""
          if result['file_suggestions']:
              files_md = "\n### ðŸ“ Suggested Files\n\n"
              for file in result['file_suggestions']:
                  files_md += f"- `{file}`\n"
          
          # Format implementation plan
          plan_md = "\n### ðŸ—ºï¸ Implementation Plan\n\n"
          for i, step in enumerate(result['implementation_plan'], 1):
              plan_md += f"{i}. {step}\n"
          
          # Format code template
          template_md = f"\n### ðŸ“ Generated Code Template\n\n```python\n{result['code_template']}\n```\n"
          
          # Complete comment - build dynamically to avoid YAML parsing issues
          agent_mention = "@" + "investigate-champion"
          comment_header = f"## ðŸ¤– Natural Language to Code Translation\n\n"
          comment_header += f"**{agent_mention}** has analyzed this issue and generated the following translation:\n\n"
          
          comment_body = f"### ðŸŽ¯ Detected Intent\n\n"
          comment_body += f"**{result['intent'].upper()}** (confidence: {result['confidence']:.2%})\n\n"
          comment_body += f"{entities_md}\n"
          comment_body += f"{files_md}\n"
          comment_body += f"{plan_md}\n"
          comment_body += f"{template_md}\n"
          comment_body += "---\n\n"
          
          comment_footer = "### â„¹ï¸ About This Translation\n\n"
          comment_footer += "This translation was automatically generated by the Natural Language to Code Translator.\n\n"
          comment_footer += f"- **Entities found**: {result['metadata']['entity_count']}\n"
          comment_footer += f"- **Entity types**: {', '.join(result['metadata']['entity_types'])}\n"
          comment_footer += f"- **Confidence**: {result['confidence']:.2%}\n\n"
          comment_footer += "The generated code is a starting point and may need refinement. Review and modify as needed.\n\n"
          comment_footer += "### ðŸ“š Learn More\n\n"
          comment_footer += "- [NL-to-Code Translator Documentation](https://github.com/{repo}/blob/main/tools/NL_TO_CODE_TRANSLATOR_README.md)\n"
          comment_footer += "- [Run Demo](https://github.com/{repo}/blob/main/tools/examples/nl-to-code-demo.py)\n"
          comment_footer += "- [View Tests](https://github.com/{repo}/blob/main/tests/test_nl_to_code_translator.py)\n\n"
          comment_footer += f"*Translation powered by **{agent_mention}** via consolidated demos-and-experiments.yml*\n"
          
          comment = comment_header + comment_body + comment_footer
          
          # Save comment to file
          with open('/tmp/comment.md', 'w') as f:
              f.write(comment.replace('{repo}', '${{ github.repository }}'))
          
          print("Comment formatted and saved")
          PYTHON_SCRIPT
      
      - name: Post translation as comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment "${{ steps.issue.outputs.issue_number }}" \
            --body-file /tmp/comment.md
          
          echo "âœ… Translation posted to issue #${{ steps.issue.outputs.issue_number }}"
      
      - name: Add completion label
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Add 'translated' label
          gh issue edit "${{ steps.issue.outputs.issue_number }}" \
            --add-label "translated"
          
          echo "âœ… Added 'translated' label"
      
      - name: Log activity
        run: |
          echo "NL-to-Code translation completed successfully"
          echo "Issue: #${{ steps.issue.outputs.issue_number }}"
          echo "Intent: ${{ steps.translate.outputs.intent }}"
          echo "Confidence: ${{ steps.translate.outputs.confidence }}"
          echo "Entities: ${{ steps.translate.outputs.entity_count }}"

  # Stage 2: Tech Lead Review System (PoC)
  tech-lead-review:
    name: "Tech Lead Review PoC"
    runs-on: ubuntu-latest
    # Run on PR events, or manual trigger with tech-lead-review stage
    # Skip draft PRs unless manually triggered
    if: |
      (github.event_name == 'pull_request' && github.event.pull_request.draft == false) ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.stage == 'tech-lead-review')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: Determine PR number
        id: pr_number
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "pr_number=${{ github.event.inputs.pr_number }}" >> $GITHUB_OUTPUT
          else
            echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Analyze PR for Tech Lead requirements
        id: analyze
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          PR_NUM="${{ steps.pr_number.outputs.pr_number }}"
          echo "Analyzing PR #${PR_NUM} for Tech Lead requirements..."
          
          # Run the matching script with complexity analysis
          RESULT=$(python3 tools/match-pr-to-tech-lead.py "${PR_NUM}" --check-complexity)
          echo "Analysis result:"
          echo "${RESULT}" | jq .
          
          # Extract key information
          TECH_LEADS=$(echo "${RESULT}" | jq -r '.tech_leads | length')
          REQUIRES_REVIEW=$(echo "${RESULT}" | jq -r '.complexity.requires_review // false')
          RECOMMENDATION=$(echo "${RESULT}" | jq -r '.complexity.recommendation // "optional"')
          
          echo "tech_leads_count=${TECH_LEADS}" >> $GITHUB_OUTPUT
          echo "requires_review=${REQUIRES_REVIEW}" >> $GITHUB_OUTPUT
          echo "recommendation=${RECOMMENDATION}" >> $GITHUB_OUTPUT
          
          # Save full result for later steps
          echo "${RESULT}" > /tmp/tech_lead_analysis.json
      
      - name: Check current labels
        id: check_labels
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ steps.pr_number.outputs.pr_number }}"
          
          # Get current labels
          LABELS=$(gh pr view "${PR_NUM}" --repo ${{ github.repository }} --json labels --jq '.labels[].name')
          
          # Check if already has tech-lead labels
          HAS_TECH_LEAD_LABEL=false
          if echo "${LABELS}" | grep -q "needs-tech-lead-review\|tech-lead-approved\|tech-lead-changes-requested"; then
            HAS_TECH_LEAD_LABEL=true
          fi
          
          echo "has_tech_lead_label=${HAS_TECH_LEAD_LABEL}" >> $GITHUB_OUTPUT
          echo "Current labels: ${LABELS}"
      
      - name: Add Tech Lead review label if needed
        if: steps.analyze.outputs.tech_leads_count > 0 && steps.analyze.outputs.requires_review == 'true' && steps.check_labels.outputs.has_tech_lead_label == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ steps.pr_number.outputs.pr_number }}"
          
          echo "ðŸ“‹ PR requires Tech Lead review - adding label"
          gh pr edit "${PR_NUM}" --repo ${{ github.repository }} --add-label "needs-tech-lead-review"
          
          # Add specific Tech Lead labels
          RESULT=$(cat /tmp/tech_lead_analysis.json)
          TECH_LEADS=$(echo "${RESULT}" | jq -r '.tech_leads[].name')
          
          for TECH_LEAD in ${TECH_LEADS}; do
            echo "Adding label for Tech Lead: ${TECH_LEAD}"
            gh pr edit "${PR_NUM}" --repo ${{ github.repository }} --add-label "tech-lead:${TECH_LEAD}" || true
          done
      
      - name: Post Tech Lead analysis comment
        if: steps.analyze.outputs.tech_leads_count > 0
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ steps.pr_number.outputs.pr_number }}"
          RESULT=$(cat /tmp/tech_lead_analysis.json)
          
          # Check if we already posted a comment (avoid duplicates)
          EXISTING_COMMENT=$(gh pr view "${PR_NUM}" --repo ${{ github.repository }} --json comments --jq '.comments[] | select(.body | contains("ðŸ—ï¸ Tech Lead Review Analysis")) | .id' | head -1)
          
          if [ -n "${EXISTING_COMMENT}" ]; then
            echo "Tech Lead analysis comment already exists (ID: ${EXISTING_COMMENT}), skipping duplicate"
            exit 0
          fi
          
          # Extract analysis data
          TECH_LEADS=$(echo "${RESULT}" | jq -r '.tech_leads')
          COMPLEXITY=$(echo "${RESULT}" | jq -r '.complexity // {}')
          TOTAL_FILES=$(echo "${RESULT}" | jq -r '.total_files')
          REQUIRES_REVIEW=$(echo "${COMPLEXITY}" | jq -r '.requires_review // false')
          RECOMMENDATION=$(echo "${COMPLEXITY}" | jq -r '.recommendation // "optional"')
          
          # Build Tech Lead list
          TECH_LEAD_LIST=""
          echo "${TECH_LEADS}" | jq -c '.[]' | while read -r lead; do
            NAME=$(echo "${lead}" | jq -r '.name')
            SPEC=$(echo "${lead}" | jq -r '.specialization')
            FILE_COUNT=$(echo "${lead}" | jq -r '.file_count')
            TECH_LEAD_LIST="${TECH_LEAD_LIST}\n- **@${NAME}** (${SPEC}) - ${FILE_COUNT} file(s)"
          done
          
          # Create comment body
          cat > /tmp/comment_body.md <<-COMMENT_EOF
            ## ðŸ—ï¸ Tech Lead Review Analysis
            
            This PR has been analyzed for Tech Lead review requirements.
            
            ## ðŸ“Š Analysis Summary
            - Total Files Changed: ${TOTAL_FILES}
            - Tech Leads Identified: $(echo "${TECH_LEADS}" | jq '. | length')
            - Review Recommendation: ${RECOMMENDATION}
            - Review Required: $([ "${REQUIRES_REVIEW}" = "true" ] && echo "âœ… Yes" || echo "â„¹ï¸ Optional")
            
            ## ðŸ‘¥ Relevant Tech Leads
            
            Based on the files changed, these Tech Lead agents are responsible for the affected areas:
            
            $(echo -e "${TECH_LEAD_LIST}")
            
            ## ðŸ“‹ Complexity Factors
            
            \`\`\`json
            $(echo "${COMPLEXITY}" | jq .)
            \`\`\`
            
            ## ðŸ”„ Next Steps
            
            COMMENT_EOF
          
          if [ "${REQUIRES_REVIEW}" = "true" ]; then
            cat >> /tmp/comment_body.md <<-'REVIEW_REQUIRED_EOF'
            This PR **requires Tech Lead review** before it can be merged. The `needs-tech-lead-review` label has been added to block auto-merge until review is complete.
            
            **Review Process:**
            1. â³ Tech Lead agent(s) will be assigned to review this PR
            2. ðŸ” Tech Lead will analyze changes and provide feedback
            3. âœ… Upon approval, `tech-lead-approved` label will be added
            4. ðŸš€ PR can then proceed to auto-merge
            
            **If changes are requested:**
            - ðŸ“ Tech Lead will provide detailed feedback
            - ðŸ”§ Original agent or Tech Lead will make corrections
            - ðŸ”„ Tech Lead will re-review after changes
            REVIEW_REQUIRED_EOF
          else
            cat >> /tmp/comment_body.md <<-'REVIEW_OPTIONAL_EOF'
            This PR is **optional for Tech Lead review** based on complexity analysis. However, Tech Leads listed above are available to review if needed.
            
            **To request Tech Lead review:**
            - Add the `needs-tech-lead-review` label manually
            - Or mention the Tech Lead agent in a comment
            REVIEW_OPTIONAL_EOF
          fi
          
          cat >> /tmp/comment_body.md <<-COMMENT_FOOTER_EOF
            
            ---
            *ðŸ¤– Automated Tech Lead Review System - Proof of Concept*
            *Consolidated workflow: \`demos-and-experiments.yml\` by **@workflows-tech-lead***
            *Run ID: ${{ github.run_id }}*
            COMMENT_FOOTER_EOF
          
          # Post the comment
          gh pr comment "${PR_NUM}" --repo ${{ github.repository }} --body-file /tmp/comment_body.md
          
          echo "âœ… Posted Tech Lead analysis comment to PR #${PR_NUM}"
      
      - name: Summary
        run: |
          PR_NUM="${{ steps.pr_number.outputs.pr_number }}"
          TECH_LEADS="${{ steps.analyze.outputs.tech_leads_count }}"
          REQUIRES="${{ steps.analyze.outputs.requires_review }}"
          RECOMMENDATION="${{ steps.analyze.outputs.recommendation }}"
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Tech Lead Review Analysis Complete"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "PR Number: #${PR_NUM}"
          echo "Tech Leads Identified: ${TECH_LEADS}"
          echo "Review Required: ${REQUIRES}"
          echo "Recommendation: ${RECOMMENDATION}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
