name: "Code Quality: Analyzer"

on:
  push:
    branches:
      - main
  pull_request:
    types: [closed]
  workflow_dispatch:
    inputs:
      directory:
        description: 'Directory to analyze (default: .)'
        required: false
        default: '.'
      mark_as_failure:
        description: 'Mark this analysis as a failed merge (for learning)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  analyze-code:
    runs-on: ubuntu-latest
    # Only run on merge to main or manual trigger
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true) ||
      github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Get full history for better analysis

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Run Code Analyzer
        id: analyze
        run: |
          # Determine if this was a successful merge
          merge_success="true"
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ inputs.mark_as_failure }}" = "true" ]; then
            merge_success="false"
          fi
          
          # Directory to analyze
          target_dir="${{ inputs.directory }}"
          if [ -z "${target_dir}" ]; then
            target_dir="."
          fi
          
          echo "Analyzing directory: ${target_dir}"
          echo "Merge successful: ${merge_success}"
          
          # Run analyzer with learning enabled
          if [ "${merge_success}" = "true" ]; then
            python3 tools/code-analyzer.py -d "${target_dir}" --learn --success -o analysis/latest_report.md
          else
            python3 tools/code-analyzer.py -d "${target_dir}" --learn --failure -o analysis/latest_report.md
          fi
          
          # Save summary for later
          echo "merge_success=${merge_success}" >> $GITHUB_OUTPUT
          echo "target_dir=${target_dir}" >> $GITHUB_OUTPUT

      - name: Get analysis statistics
        id: stats
        run: |
          # Ensure analysis directory exists
          mkdir -p analysis
          
          # Initialize patterns.json if missing
          if [ ! -f analysis/patterns.json ]; then
            echo '{"total_merges_analyzed": 0, "good_patterns": {}, "bad_patterns": {}}' > analysis/patterns.json
            echo "âœ“ Initialized patterns.json"
          fi
          
          # Extract statistics using a proper Python script with error handling
          python3 << 'PYEOF' >> $GITHUB_OUTPUT
          import json
          import sys
          
          try:
              with open('analysis/patterns.json', 'r') as f:
                  patterns = json.load(f)
              
              total_merges = patterns.get('total_merges_analyzed', 0)
              
              # Safe handling of potentially empty dictionaries
              good_patterns = patterns.get('good_patterns', {})
              if good_patterns:
                  top_good_item = max(good_patterns.items(), 
                                    key=lambda x: x[1].get('correlation_with_success', 0))
                  top_good = f"{top_good_item[0]} ({top_good_item[1].get('correlation_with_success', 0):.2%})"
              else:
                  top_good = "None (0.00%)"
              
              bad_patterns = patterns.get('bad_patterns', {})
              if bad_patterns:
                  top_bad_item = max(bad_patterns.items(),
                                   key=lambda x: x[1].get('correlation_with_issues', 0))
                  top_bad = f"{top_bad_item[0]} ({top_bad_item[1].get('correlation_with_issues', 0):.2%})"
              else:
                  top_bad = "None (0.00%)"
              
              print(f"total_merges={total_merges}")
              print(f"top_good={top_good}")
              print(f"top_bad={top_bad}")
              
          except Exception as e:
              print(f"Error: {e}", file=sys.stderr)
              print("total_merges=0")
              print("top_good=None")
              print("top_bad=None")
          PYEOF

      - name: Commit analysis results
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Add analysis files
          git add analysis/
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            # Create a new branch for the PR with unique name using run ID
            TIMESTAMP=$(date +%Y%m%d-%H%M%S)
            BRANCH_NAME="code-analysis/${TIMESTAMP}-${{ github.run_id }}"
            git checkout -b "$BRANCH_NAME"
            
            # Commit changes
            git commit -m "ðŸ¤– Update code analysis data after merge" \
                       -m "Analysis completed for directory: ${{ steps.analyze.outputs.target_dir }}" \
                       -m "Merge successful: ${{ steps.analyze.outputs.merge_success }}" \
                       -m "Total merges analyzed: ${{ steps.stats.outputs.total_merges }}"
            
            # Push branch
            git push origin "$BRANCH_NAME"
            
            # Create PR
            PR_DATE=$(date +%Y-%m-%d)
            gh pr create \
              --title "ðŸ¤– Update code analysis data - ${PR_DATE}" \
              --body "## Code Analysis Update"$'\n\n'"This PR updates the code analysis data after a merge to main."$'\n\n'"### Analysis Summary"$'\n'"- **Directory analyzed**: ${{ steps.analyze.outputs.target_dir }}"$'\n'"- **Merge successful**: ${{ steps.analyze.outputs.merge_success }}"$'\n'"- **Total merges analyzed**: ${{ steps.stats.outputs.total_merges }}"$'\n'"- **Top good pattern**: ${{ steps.stats.outputs.top_good }}"$'\n'"- **Top bad pattern**: ${{ steps.stats.outputs.top_bad }}"$'\n\n'"---"$'\n'"*ðŸ¤– Automated code analysis workflow*" \
              --label "code-quality,automated,copilot" \
              --base main \
              --head "$BRANCH_NAME"
            
            echo "âœ… PR created for code analysis update"
          fi

      - name: Create analysis summary comment
        if: github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Post analysis summary as PR comment
          pr_number="${{ github.event.pull_request.number }}"
          
          if [ -f analysis/latest_report.md ]; then
            # Create a simple summary (avoiding YAML special characters)
            total_merges="${{ steps.stats.outputs.total_merges }}"
            top_good="${{ steps.stats.outputs.top_good }}"
            top_bad="${{ steps.stats.outputs.top_bad }}"
            
            gh pr comment ${pr_number} --body "Code Analysis Report: Analysis complete! Total merges analyzed: ${total_merges}. Top good pattern: ${top_good}. Top bad pattern: ${top_bad}. Check analysis/ directory for full reports." || true
          fi

      - name: Create analysis issue (if significant findings)
        if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if there are significant bad patterns detected
          if [ -f analysis/latest_report.md ]; then
            bad_count=$(grep -c "Bad patterns found:" analysis/latest_report.md | head -1 || echo "0")
            
            # Extract the number from the line
            bad_number=$(grep "Bad patterns found:" analysis/latest_report.md | grep -oP '\d+' | head -1 || echo "0")
            
            # If more than 10 bad patterns, create an issue
            if [ "${bad_number}" -gt 10 ]; then
              total_merges="${{ steps.stats.outputs.total_merges }}"
              top_bad="${{ steps.stats.outputs.top_bad }}"
              
              gh issue create \
                --title "Code Quality Alert: ${bad_number} bad patterns detected" \
                --body "The self-improving code analyzer detected significant code quality issues. Total merges analyzed: ${total_merges}. Most problematic pattern: ${top_bad}. See analysis/ directory for full reports. Consider refactoring code to address the detected patterns." \
                --label "code-quality,ai-generated" || true
            fi
          fi

      - name: Log activity
        run: |
          echo "Code analysis completed"
          echo "Target: ${{ steps.analyze.outputs.target_dir }}"
          echo "Merge successful: ${{ steps.analyze.outputs.merge_success }}"
          echo "Total merges analyzed: ${{ steps.stats.outputs.total_merges }}"
          echo "Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
