name: "AI: Prompt Generator Integration"

# This workflow demonstrates how to integrate the self-improving prompt generator
# into the Copilot assignment process to generate optimized prompts based on
# issue content, learning from outcomes, and continuously improving effectiveness.

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to generate prompt for'
        required: true
        type: string
      agent:
        description: 'Agent name (e.g., engineer-master, create-guru)'
        required: false
        default: 'engineer-master'
        type: string
      enable_learning:
        description: 'Enable learning enhancement from recent TLDR/HN data'
        required: false
        default: true
        type: boolean

permissions:
  issues: write
  contents: read

jobs:
  generate-prompt:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: Get issue details
        id: issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get issue data
          issue_data=$(gh issue view ${{ inputs.issue_number }} --json title,body,labels --repo ${{ github.repository }})
          
          # Extract fields
          title=$(echo "$issue_data" | jq -r '.title')
          body=$(echo "$issue_data" | jq -r '.body // ""')
          labels=$(echo "$issue_data" | jq -r '.labels[].name' | tr '\n' ',' | sed 's/,$//')
          
          echo "title=$title" >> $GITHUB_OUTPUT
          echo "labels=$labels" >> $GITHUB_OUTPUT
          
          # Save body to file to handle multiline
          echo "$body" > /tmp/issue_body.txt
      
      - name: Detect issue category
        id: category
        run: |
          # Detect category from labels and title
          labels="${{ steps.issue.outputs.labels }}"
          title="${{ steps.issue.outputs.title }}"
          
          category="feature"  # default
          
          if echo "$labels" | grep -qi "bug"; then
            category="bug_fix"
          elif echo "$labels" | grep -qi "documentation"; then
            category="documentation"
          elif echo "$labels" | grep -qi "security"; then
            category="security"
          elif echo "$labels" | grep -qi "refactor"; then
            category="refactor"
          elif echo "$labels" | grep -qi "investigation"; then
            category="investigation"
          elif echo "$title" | grep -qi "fix\|bug\|error\|issue"; then
            category="bug_fix"
          elif echo "$title" | grep -qi "document"; then
            category="documentation"
          fi
          
          echo "category=$category" >> $GITHUB_OUTPUT
          echo "Detected category: $category"
      
      - name: Generate optimized prompt
        id: prompt
        run: |
          # Generate prompt using the self-improving prompt generator
          issue_body=$(cat /tmp/issue_body.txt)
          
          prompt_output=$(python3 tools/prompt-generator.py generate \
            --issue-body "$issue_body" \
            --category "${{ steps.category.outputs.category }}" \
            --agent "${{ inputs.agent }}")
          
          # Extract template ID and prompt
          template_id=$(echo "$prompt_output" | grep "Template ID:" | cut -d: -f2 | xargs)
          prompt=$(echo "$prompt_output" | sed -n '/Generated Prompt:/,/^$/p' | tail -n +2)
          
          echo "template_id=$template_id" >> $GITHUB_OUTPUT
          
          # Save prompt to file
          echo "$prompt" > /tmp/generated_prompt.txt
          
          echo "Generated prompt using template: $template_id"
      
      - name: Comment on issue with generated prompt
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          prompt=$(cat /tmp/generated_prompt.txt)
          
          comment="## ðŸ¤– Generated Optimized Prompt

**@${{ inputs.agent }}** - This prompt was generated by the self-improving prompt generator based on historical success patterns.

**Template Used:** \`${{ steps.prompt.outputs.template_id }}\`
**Category:** \`${{ steps.category.outputs.category }}\`
**Learning Enhancement:** \`${{ inputs.enable_learning }}\`

---

$prompt

---

*This prompt was generated by the autonomous prompt generator which learns from outcomes to continuously improve effectiveness. Template performance is tracked and optimized over time.*"
          
          # Post comment
          echo "$comment" | gh issue comment ${{ inputs.issue_number }} --repo ${{ github.repository }} --body-file -
          
          echo "âœ“ Posted generated prompt to issue #${{ inputs.issue_number }}"
      
      - name: Get prompt generator statistics
        run: |
          echo ""
          echo "ðŸ“Š Prompt Generator Performance Report:"
          echo "========================================"
          python3 tools/prompt-generator.py report | jq -r '
            "Overall Statistics:",
            "  Total prompts used: \(.insights.overall.total_prompts_used // 0)",
            "  Success rate: \((.insights.overall.success_rate // 0) * 100)%",
            "  Avg resolution time: \(.insights.overall.avg_resolution_time // 0) hours",
            "",
            "Template: \(.templates["${{ steps.prompt.outputs.template_id }}"] | 
              if . then
                "  Success rate: \((.success_rate // 0) * 100)%",
                "  Effectiveness score: \(.effectiveness_score // 0)",
                "  Total uses: \(.total_uses // 0)",
                "  Avg resolution: \(.avg_resolution_time // 0) hours"
              else
                "  (New template, no historical data yet)"
              end
            )
          '
