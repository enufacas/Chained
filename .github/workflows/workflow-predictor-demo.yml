name: Workflow Execution Time Predictor Demo
# Created by @APIs-architect
# 
# Demonstrates the AI-powered workflow orchestrator by:
# 1. Predicting optimal execution times for workflows
# 2. Recording actual execution data for learning
# 3. Comparing predictions vs actuals
# 4. Generating insights report

on:
  schedule:
    # Run weekly to generate prediction reports
    - cron: '0 0 * * 0'
  workflow_dispatch:
    inputs:
      workflow_name:
        description: 'Workflow to analyze (optional)'
        required: false
        type: string
      generate_report:
        description: 'Generate full report'
        required: false
        type: boolean
        default: true

permissions:
  contents: write
  pull-requests: write

jobs:
  predict-and-analyze:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      
      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      
      - name: Run API health check
        run: |
          echo "ðŸ¥ Checking API health..."
          python3 tools/workflow_orchestrator_api.py health --json
      
      - name: Generate predictions for key workflows
        run: |
          echo "ðŸ”® Generating workflow predictions..."
          echo ""
          
          # Key workflows to analyze
          WORKFLOWS=(
            "learn-from-tldr"
            "learn-from-hackernews" 
            "idea-generator"
            "ai-idea-spawner"
            "agent-spawner"
          )
          
          for workflow in "${WORKFLOWS[@]}"; do
            echo "ðŸ“Š Analyzing: $workflow"
            python3 tools/workflow_orchestrator_api.py predict --workflow "$workflow"
            echo ""
          done
      
      - name: Generate batch predictions
        run: |
          echo "ðŸ“¦ Generating batch predictions..."
          python3 tools/workflow_orchestrator_api.py batch \
            --workflows learn-from-tldr learn-from-hackernews idea-generator \
            --json > predictions-batch.json
          
          cat predictions-batch.json | jq '.'
      
      - name: Get execution history
        run: |
          echo "ðŸ“œ Retrieving execution history..."
          python3 tools/workflow_orchestrator_api.py history --limit 20 --json > history.json
          
          echo "Recent executions:"
          cat history.json | jq -r '.data.history[] | "\(.workflow_name): \(.duration_seconds)s (\(.success))"' | head -10
      
      - name: Calculate accuracy metrics
        run: |
          echo "ðŸŽ¯ Calculating prediction accuracy..."
          python3 tools/workflow_orchestrator_api.py accuracy --json > accuracy.json
          
          cat accuracy.json | jq '.'
      
      - name: Analyze specific workflow (if provided)
        if: inputs.workflow_name
        run: |
          echo "ðŸ” Deep dive analysis for ${{ inputs.workflow_name }}"
          python3 tools/workflow_orchestrator_api.py insights \
            --workflow "${{ inputs.workflow_name }}" \
            --json > workflow-insights.json
          
          cat workflow-insights.json | jq '.'
      
      - name: Generate comprehensive report
        if: inputs.generate_report || github.event_name == 'schedule'
        run: |
          echo "ðŸ“Š Generating comprehensive prediction report..."
          python3 tools/ai_workflow_predictor.py --report > prediction-report.txt
          
          cat prediction-report.txt
      
      - name: Simulate execution data (for testing)
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "ðŸŽ² Simulating execution data for testing..."
          python3 tools/ai_workflow_predictor.py --simulate
          
          echo "Simulated data created. Re-run predictions to see updated results."
      
      - name: Create summary
        if: always()
        run: |
          REPORT_DATE=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          cat << EOF > $GITHUB_STEP_SUMMARY
          # ðŸ”® AI Workflow Orchestrator Report
          
          **Generated by:** @APIs-architect
          **Date:** $REPORT_DATE
          
          ## Overview
          
          This report demonstrates the AI-powered workflow orchestrator capabilities:
          - âœ… Execution time predictions
          - âœ… Historical analysis
          - âœ… Accuracy metrics
          - âœ… Workflow insights
          
          ## Key Workflows Analyzed
          
          - learn-from-tldr
          - learn-from-hackernews
          - idea-generator
          - ai-idea-spawner
          - agent-spawner
          
          ## API Capabilities
          
          The orchestrator provides:
          1. **Real-time predictions** - Optimal execution time recommendations
          2. **Batch processing** - Analyze multiple workflows at once
          3. **Historical tracking** - Full execution history
          4. **Accuracy monitoring** - Prediction vs actual comparison
          5. **Workflow insights** - Comprehensive statistics
          
          ## Usage Examples
          
          ```bash
          # Predict optimal time
          python3 tools/workflow_orchestrator_api.py predict --workflow my-workflow
          
          # Get insights
          python3 tools/workflow_orchestrator_api.py insights --workflow my-workflow
          
          # Check accuracy
          python3 tools/workflow_orchestrator_api.py accuracy
          ```
          
          For full documentation, see: `tools/WORKFLOW_ORCHESTRATOR_API_README.md`
          
          ---
          *Created by **@APIs-architect** - Building reliable, intelligent systems*
          EOF
      
      - name: Upload artifacts
        if: inputs.generate_report || github.event_name == 'schedule'
        uses: actions/upload-artifact@v3
        with:
          name: workflow-predictions
          path: |
            predictions-batch.json
            history.json
            accuracy.json
            prediction-report.txt
            workflow-insights.json
          retention-days: 30

# Example: Record workflow execution for learning
# Add this to any workflow to feed data to the predictor:
#
#   - name: Record execution
#     if: always()
#     run: |
#       python3 tools/workflow_orchestrator_api.py record \
#         --workflow "${{ github.workflow }}" \
#         --start-time "${{ env.WORKFLOW_START }}" \
#         --duration "${{ env.WORKFLOW_DURATION }}" \
#         --success "${{ job.status == 'success' }}"
