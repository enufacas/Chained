name: "Idea Generation: Smart Generator"

on:
  schedule:
    # Run daily at 10 AM UTC (after learning workflows)
    - cron: '0 10 * * *'
  workflow_dispatch:

permissions:
  issues: write
  contents: read

jobs:
  generate-smart-idea:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Generate idea with learning context
        id: generate
        run: |
          python3 << 'PYTHON_SCRIPT'
          import json
          import os
          import random
          from datetime import datetime
          from pathlib import Path
          
          # Base creative ideas
          base_ideas = [
              "Create a self-improving code analyzer that learns from each merge",
              "Build an AI pair programming simulator that debates solutions",
              "Implement a neural network visualizer showing the AI's decision process",
              "Develop a sentiment analyzer for code comments and commit messages",
              "Create a code poetry generator that writes functional artistic code",
              "Build an automated architecture evolution system with visual diagrams",
              "Implement a machine learning model trainer using repository data",
              "Create an AI-powered bug predictor based on code patterns",
              "Develop a code complexity reducer that auto-simplifies algorithms",
              "Build a cross-repository pattern matcher for best practices",
              "Implement an AI code archaeologist documenting legacy decisions",
              "Create a predictive issue priority system using ML",
              "Develop an automated performance benchmark generator",
              "Build a code style harmonizer across all files",
              "Implement a knowledge graph of code relationships",
              "Create an AI-generated test suite with edge case detection",
              "Develop a natural language to code translator for issues",
              "Build a code health monitor with auto-healing suggestions",
              "Implement a repository story generator creating narratives from commits",
              "Create an AI code golf optimizer for minimal solutions",
              "Develop a cross-language code translator and comparison tool",
              "Build an automated API versioning and migration system",
              "Implement a code smell detector with auto-fix capabilities",
              "Create a visual code execution flow animator",
              "Develop an AI-powered documentation completeness checker",
              "Build a code collaboration simulator showing multiple AI perspectives",
              "Implement a repository time-travel debugger",
              "Create an automated dependency security auditor",
              "Develop a code readability scorer with improvement suggestions",
              "Build an AI creative coding challenge generator"
          ]
          
          # Check for learnings book
          enhanced_ideas = []
          learning_context = ""
          book_insights = []
          
          book_dir = Path('learnings/book')
          if book_dir.exists():
              print("ðŸ“– Reading from learnings book...")
              
              # Read README to get chapter info
              readme_file = book_dir / 'README.md'
              if readme_file.exists():
                  with open(readme_file, 'r') as f:
                      readme_content = f.read()
                  
                  # Extract chapter information
                  if 'AI & Machine Learning' in readme_content:
                      ai_file = book_dir / 'AI_ML.md'
                      if ai_file.exists():
                          enhanced_ideas.extend([
                              "Build an LLM-powered code assistant inspired by learnings book",
                              "Implement a transformer model for code generation from HN insights",
                              "Create a GPT-integrated code review system based on recent AI trends"
                          ])
                          book_insights.append('AI/ML')
                  
                  if 'Programming' in readme_content:
                      prog_file = book_dir / 'Programming.md'
                      if prog_file.exists():
                          enhanced_ideas.extend([
                              "Adopt new programming patterns from learnings book",
                              "Implement language features inspired by trending discussions"
                          ])
                          book_insights.append('Programming')
                  
                  if 'Performance' in readme_content:
                      perf_file = book_dir / 'Performance.md'
                      if perf_file.exists():
                          enhanced_ideas.extend([
                              "Build a performance profiler inspired by learnings book insights",
                              "Implement optimization techniques from trending benchmarks"
                          ])
                          book_insights.append('Performance')
                  
                  if 'Security' in readme_content:
                      sec_file = book_dir / 'Security.md'
                      if sec_file.exists():
                          enhanced_ideas.extend([
                              "Create security scanner based on learnings book vulnerabilities",
                              "Implement automated security patches from recent CVE insights"
                          ])
                          book_insights.append('Security')
                  
                  if 'DevOps' in readme_content:
                      devops_file = book_dir / 'DevOps.md'
                      if devops_file.exists():
                          enhanced_ideas.extend([
                              "Build CI/CD enhancement based on learnings book patterns",
                              "Implement infrastructure automation from DevOps insights"
                          ])
                          book_insights.append('DevOps')
                  
                  learning_context = f"Inspired by learnings book chapters: {', '.join(book_insights)}"
                  print(f"âœ“ Found insights in: {', '.join(book_insights)}")
          
          # Also check for recent learning files (backward compatibility)
          if os.path.exists('learnings'):
              learning_files = sorted([f for f in os.listdir('learnings') if f.endswith('.json')])[-5:]
              
              topics_seen = set()
              for lf in learning_files:
                  try:
                      with open(f'learnings/{lf}', 'r') as f:
                          data = json.load(f)
                          
                          if 'topics' in data:
                              topics_seen.update(data['topics'].keys())
                  except:
                      pass
              
              if topics_seen and not book_insights:
                  learning_context = f"Influenced by recent learnings: {', '.join(list(topics_seen)[:3])}"
          
          # Combine base and enhanced ideas
          all_ideas = base_ideas + enhanced_ideas
          
          # Select idea
          selected_idea = random.choice(all_ideas)
          is_learning_based = selected_idea in enhanced_ideas
          
          # Create unique identifier
          timestamp = int(datetime.utcnow().timestamp())
          idea_id = f"idea-{timestamp}"
          
          # Output
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"idea={selected_idea}\n")
              f.write(f"idea_id={idea_id}\n")
              f.write(f"is_learning_based={'true' if is_learning_based else 'false'}\n")
              f.write(f"learning_context={learning_context}\n")
              f.write(f"uses_book={'true' if book_insights else 'false'}\n")
          
          print(f"\nðŸ’¡ Generated idea: {selected_idea}")
          print(f"ðŸ“š Learning-based: {is_learning_based}")
          print(f"ðŸ“– Uses book: {bool(book_insights)}")
          print(f"ðŸŽ¯ Context: {learning_context}")
          
          PYTHON_SCRIPT

      - name: Create enhanced issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create badge for learning-based ideas
          learning_badge=""
          if [ "${{ steps.generate.outputs.is_learning_based }}" = "true" ]; then
            if [ "${{ steps.generate.outputs.uses_book }}" = "true" ]; then
              learning_badge="ðŸ“– **This idea was inspired by insights from the [Learnings Book](https://github.com/enufacas/Chained/tree/main/learnings/book)!**"
            else
              learning_badge="ðŸ§  **This idea was influenced by recent learnings from TLDR Tech and Hacker News!**"
            fi
          fi
          
          issue_url=$(gh issue create \
            --title "ðŸ¤– AI Generated Idea: ${{ steps.generate.outputs.idea }}" \
            --body "## Generated Idea

          **Idea:** ${{ steps.generate.outputs.idea }}

          **Generated on:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')

          **ID:** ${{ steps.generate.outputs.idea_id }}

          ${learning_badge}

          ${{ steps.generate.outputs.learning_context }}

          ---

          This issue was automatically generated by the Smart Idea Generator workflow.
          It incorporates learnings from external sources to stay current with tech trends.

          ### Next Steps
          - [ ] Analyze the feasibility of this idea
          - [ ] Create an implementation plan
          - [ ] Assign to Copilot for implementation
          - [ ] Review and merge the changes
          - [ ] Update documentation and timeline

          ### Implementation Context
          This idea generation considered:
          - Base creative AI-focused concepts
          - Recent learnings from TLDR Tech
          - Trending topics on Hacker News
          - Insights from the Learnings Book
          - Current repository patterns and needs

          ### ðŸ“š Learning Resources
          - [Learnings Book](https://github.com/enufacas/Chained/tree/main/learnings/book) - Browse organized chapters
          - [Recent Learnings](https://github.com/enufacas/Chained/tree/main/learnings) - View raw learning data

          ---

          *Generated by Smart Idea Generator with learnings book integration*" \
            --label "ai-generated,enhancement,copilot-assigned")
          
          echo "Created enhanced issue: ${issue_url}"

      - name: Log activity
        run: |
          echo "Smart idea generation completed"
          echo "Idea: ${{ steps.generate.outputs.idea }}"
          echo "Learning-based: ${{ steps.generate.outputs.is_learning_based }}"
          echo "Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
