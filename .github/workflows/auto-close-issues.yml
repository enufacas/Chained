name: Auto Close Completed Issues

on:
  pull_request:
    types: [closed]
  schedule:
    # Run every 4 hours to check for completed issues
    - cron: '0 */4 * * *'
  workflow_dispatch:

permissions:
  issues: write
  pull-requests: read

jobs:
  close-completed-issues:
    runs-on: ubuntu-latest
    steps:
      - name: Find and close completed issues
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # If triggered by PR merge, check if it closes any issues
          if [ "${{ github.event_name }}" = "pull_request" ] && [ "${{ github.event.pull_request.merged }}" = "true" ]; then
            pr_num="${{ github.event.pull_request.number }}"
            
            # Extract issue numbers from PR body
            pr_body=$(gh pr view ${pr_num} --json body --jq '.body')
            issue_numbers=$(echo "${pr_body}" | grep -oP '(?<=#)\d+' || echo "")
            
            for issue_num in ${issue_numbers}; do
              if [ -n "${issue_num}" ]; then
                echo "Closing issue #${issue_num} as completed by PR #${pr_num}"
                
                gh issue close ${issue_num} --comment "✅ **Completed**
                
                This issue has been completed and merged via PR #${pr_num}.
                
                **Closed at:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
                
                ---
                *Automatically closed by the completion tracker*" || true
                
                gh issue edit ${issue_num} --add-label "completed" || true
              fi
            done
          fi
          
          # Also check for issues that have been in-progress for a while with merged PRs
          in_progress_issues=$(gh issue list --label "in-progress" --state open --json number,title | jq -r '.[] | .number')
          
          for issue_num in ${in_progress_issues}; do
            # Check if there are merged PRs that reference this issue
            merged_prs=$(gh pr list --state merged --search "#${issue_num}" --json number | jq '. | length')
            
            if [ "${merged_prs}" -gt 0 ]; then
              echo "Found merged PR for issue #${issue_num}, closing..."
              
              gh issue close ${issue_num} --comment "✅ **Completed**
              
              This issue has been completed with merged PR(s).
              
              **Closed at:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
              
              ---
              *Automatically closed by the completion tracker*" || true
              
              gh issue edit ${issue_num} --add-label "completed" || true
            fi
          done

      - name: Log activity
        run: |
          echo "Issue closure check completed"
          echo "Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
