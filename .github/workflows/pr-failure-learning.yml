name: "System: PR Failure Learning"

on:
  # Run weekly to collect and analyze PR failures
  schedule:
    - cron: '0 0 * * 0'  # Every Sunday at midnight UTC
  
  # Run when PRs are closed (both merged and unmerged)
  pull_request:
    types: [closed]
  
  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      since_days:
        description: 'Number of days to look back'
        required: false
        default: '30'
      analyze_only:
        description: 'Only analyze existing data without collecting new failures'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: read
  issues: write

jobs:
  learn-from-failures:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Collect PR failures
        if: ${{ !inputs.analyze_only }}
        continue-on-error: true
        id: collect
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          since_days="${{ inputs.since_days || '30' }}"
          echo "ðŸ“Š Collecting PR failures from last ${since_days} days..."
          if python tools/pr-failure-learner.py --collect --since ${since_days} --verbose 2>&1; then
            echo "âœ… Successfully collected PR failure data"
            echo "collect_success=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Failed to collect PR failures, continuing with existing data"
            echo "collect_success=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Analyze failure patterns
        id: analyze
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ” Analyzing PR failure patterns..."
          
          output_file="learnings/pr_failure_analysis_$(date +%Y%m%d_%H%M%S).json"
          if python tools/pr-failure-learner.py --analyze --output "${output_file}" --verbose 2>&1; then
            echo "âœ… Analysis complete: ${output_file}"
            echo "output_file=${output_file}" >> $GITHUB_OUTPUT
            echo "analyze_success=true" >> $GITHUB_OUTPUT
            
            # Display summary
            echo ""
            echo "ðŸ“ˆ Analysis Summary:"
            if [ -f "${output_file}" ]; then
              cat "${output_file}" | jq -r '.patterns[] | "  - \(.pattern_type): \(.occurrences) occurrences"' 2>/dev/null || echo "  No patterns data available"
            fi
          else
            echo "âš ï¸ Analysis failed or no data available"
            echo "analyze_success=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Generate improvement suggestions
        id: suggest
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ’¡ Generating improvement suggestions..."
          
          suggestions_file="learnings/pr_improvement_suggestions_$(date +%Y%m%d_%H%M%S).json"
          if python tools/pr-failure-learner.py --suggest --verbose 2>&1 > "${suggestions_file}"; then
            echo "âœ… Suggestions generated: ${suggestions_file}"
            echo "suggestions_file=${suggestions_file}" >> $GITHUB_OUTPUT
            echo "suggest_success=true" >> $GITHUB_OUTPUT
            
            # Display top suggestions
            echo ""
            echo "ðŸ’¡ Top Improvement Suggestions:"
            if [ -f "${suggestions_file}" ]; then
              cat "${suggestions_file}" | jq -r 'to_entries | .[] | "  Agent: \(.key)\n    Failures: \(.value.total_failures)\n    Top suggestions: \(.value.improvements[0:2])"' 2>/dev/null | head -20 || echo "  No suggestions data available"
            fi
          else
            echo "âš ï¸ Suggestion generation failed or no data available"
            echo "suggest_success=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Update agent metrics
        if: success() || steps.suggest.outputs.suggest_success == 'true'
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ“Š Updating agent performance metrics with failure insights..."
          
          # Check if metrics directory exists
          if [ ! -d ".github/agent-system/metrics" ]; then
            echo "âš ï¸ Metrics directory does not exist, skipping agent metrics update"
            exit 0
          fi
          
          # For each agent with failures, create a note in their metrics directory
          updated_count=0
          for agent_dir in .github/agent-system/metrics/agent-*; do
            if [ -d "${agent_dir}" ]; then
              agent_id=$(basename "${agent_dir}")
              
              # Get agent-specific suggestions
              suggestions=$(python tools/pr-failure-learner.py --suggest --agent "${agent_id}" 2>/dev/null || echo "{}")
              
              if [ "${suggestions}" != "{}" ] && [ -n "${suggestions}" ]; then
                timestamp=$(date +%Y%m%d_%H%M%S)
                echo "${suggestions}" > "${agent_dir}/pr_failure_insights_${timestamp}.json"
                echo "  âœ“ Updated insights for ${agent_id}"
                ((updated_count++))
              fi
            fi
          done
          
          echo "âœ… Updated metrics for ${updated_count} agents"
      
      - name: Commit learning data
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add learnings/pr_*.json
          git add .github/agent-system/metrics/
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            # Create a new branch for the PR with unique name using run ID
            TIMESTAMP=$(date +%Y%m%d-%H%M%S)
            BRANCH_NAME="pr-failure-learning/${TIMESTAMP}-${{ github.run_id }}"
            git checkout -b "$BRANCH_NAME"
            
            git commit -m "ðŸ“Š Update PR failure learning data" \
                       -m "Collected and analyzed PR failures to improve future code generation." \
                       -m "Files updated:" \
                       -m "- PR failure data" \
                       -m "- Failure pattern analysis" \
                       -m "- Agent-specific improvement suggestions" \
                       -m "- Agent performance insights" \
                       -m "" \
                       -m "Generated by: @engineer-master PR Failure Learning System"
            
            # Push branch
            git push origin "$BRANCH_NAME"
            
            # Create PR
            PR_DATE=$(date +%Y-%m-%d)
            gh pr create \
              --title "ðŸ“Š Update PR failure learning data - ${PR_DATE}" \
              --body "## PR Failure Learning Update"$'\n\n'"This PR updates the PR failure learning data with new analysis and improvement suggestions."$'\n\n'"### Changes"$'\n'"- Updated PR failure analysis data"$'\n'"- Updated failure pattern analysis"$'\n'"- Updated agent-specific improvement suggestions"$'\n'"- Updated agent performance insights"$'\n\n'"---"$'\n'"*Generated by: **@engineer-master** PR Failure Learning System*" \
              --label "agent-system,automated,copilot" \
              --base main \
              --head "$BRANCH_NAME"
            
            echo "âœ… PR created for learning data update"
          fi
      
      - name: Create learning summary
        if: github.event_name == 'schedule' && success()
        env:
          ANALYSIS_FILE: ${{ steps.analyze.outputs.output_file }}
          SUGGESTIONS_FILE: ${{ steps.suggest.outputs.suggestions_file }}
        run: |
          echo "ðŸ“ Creating learning summary..."
          
          # Extract key metrics for summary
          total_failures=$(cat "${ANALYSIS_FILE}" | jq -r '.total_failures' 2>/dev/null || echo "0")
          pattern_count=$(cat "${ANALYSIS_FILE}" | jq -r '.patterns | length' 2>/dev/null || echo "0")
          
          echo "Summary: Analyzed ${total_failures} failures, identified ${pattern_count} patterns"
          echo "Files: ${ANALYSIS_FILE}, ${SUGGESTIONS_FILE}"
          
          # Summary is automatically available in workflow artifacts
          echo "âœ… Learning summary complete"
      
      - name: Generate workflow summary
        if: always()
        run: |
          echo "# ðŸ“Š PR Failure Learning Workflow" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "${{ steps.analyze.outputs.output_file }}" ]; then
            echo "## ðŸ“ˆ Analysis Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Analysis file: \`${{ steps.analyze.outputs.output_file }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -n "${{ steps.suggest.outputs.suggestions_file }}" ]; then
            echo "## ðŸ’¡ Improvement Suggestions" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Suggestions file: \`${{ steps.suggest.outputs.suggestions_file }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Built by **@engineer-master** - Systematic learning from failures*" >> $GITHUB_STEP_SUMMARY
