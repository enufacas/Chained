name: "Code Quality: Golf Optimizer"

on:
  schedule:
    # Run weekly on Mondays at 10 AM UTC
    - cron: '0 10 * * 1'
  workflow_dispatch:
    inputs:
      file_path:
        description: 'Path to file to optimize (optional)'
        required: false
        type: string
      language:
        description: 'Programming language'
        required: false
        default: 'python'
        type: choice
        options:
          - python
          - javascript
          - bash

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  optimize-code:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Run Code Golf Optimizer on Examples
        id: optimize
        run: |
          cd tools
          
          # Check if examples directory exists and has files
          if [ ! -d "examples" ] || [ -z "$(ls -A examples 2>/dev/null)" ]; then
            echo "‚ö†Ô∏è No examples directory or no example files found"
            echo "Creating a basic report..."
            
            mkdir -p optimizations
            echo "## Code Golf Optimization Report" > optimizations/report.md
            echo "" >> optimizations/report.md
            echo "Generated on: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> optimizations/report.md
            echo "" >> optimizations/report.md
            echo "‚ö†Ô∏è **No example files found to optimize**" >> optimizations/report.md
            echo "" >> optimizations/report.md
            echo "To run optimization, add example files to \`tools/examples/\`" >> optimizations/report.md
            
            echo "report_created=true" >> $GITHUB_OUTPUT
            echo "total_saved=0" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Create output directory
          mkdir -p optimizations
          
          echo "## Code Golf Optimization Report" > optimizations/report.md
          echo "" >> optimizations/report.md
          echo "Generated on: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> optimizations/report.md
          echo "" >> optimizations/report.md
          
          total_original=0
          total_optimized=0
          files_processed=0
          
          # Optimize Python examples
          echo "### Python Examples" >> optimizations/report.md
          echo "" >> optimizations/report.md
          
          for file in examples/*.py; do
            if [ -f "$file" ]; then
              echo "Optimizing: $file"
              filename=$(basename "$file")
              
              # Run optimizer and capture output (with error handling)
              if python3 code-golf-optimizer.py -f "$file" -l python > "optimizations/${filename}.txt" 2>&1; then
                # Extract metrics (with defaults if not found)
                original=$(grep "Original:" "optimizations/${filename}.txt" | grep -oP '\d+' | head -1 || echo "0")
                optimized=$(grep "Optimized:" "optimizations/${filename}.txt" | grep -oP '\d+' | head -1 || echo "0")
                reduction=$(grep "Reduction:" "optimizations/${filename}.txt" | grep -oP '\d+\.\d+' | head -1 || echo "0.0")
                
                total_original=$((total_original + original))
                total_optimized=$((total_optimized + optimized))
                files_processed=$((files_processed + 1))
                
                echo "- **$filename**: $original ‚Üí $optimized chars (${reduction}% reduction)" >> optimizations/report.md
              else
                echo "- **$filename**: ‚ö†Ô∏è Optimization failed" >> optimizations/report.md
              fi
            fi
          done
          
          # Check if any Python files were processed
          if [ $files_processed -eq 0 ]; then
            echo "*No Python files found*" >> optimizations/report.md
          fi
          
          echo "" >> optimizations/report.md
          
          # Optimize JavaScript examples
          echo "### JavaScript Examples" >> optimizations/report.md
          echo "" >> optimizations/report.md
          js_files=0
          
          for file in examples/*.js; do
            if [ -f "$file" ]; then
              echo "Optimizing: $file"
              filename=$(basename "$file")
              
              if python3 code-golf-optimizer.py -f "$file" -l javascript > "optimizations/${filename}.txt" 2>&1; then
                original=$(grep "Original:" "optimizations/${filename}.txt" | grep -oP '\d+' | head -1 || echo "0")
                optimized=$(grep "Optimized:" "optimizations/${filename}.txt" | grep -oP '\d+' | head -1 || echo "0")
                reduction=$(grep "Reduction:" "optimizations/${filename}.txt" | grep -oP '\d+\.\d+' | head -1 || echo "0.0")
                
                total_original=$((total_original + original))
                total_optimized=$((total_optimized + optimized))
                js_files=$((js_files + 1))
                
                echo "- **$filename**: $original ‚Üí $optimized chars (${reduction}% reduction)" >> optimizations/report.md
              else
                echo "- **$filename**: ‚ö†Ô∏è Optimization failed" >> optimizations/report.md
              fi
            fi
          done
          
          if [ $js_files -eq 0 ]; then
            echo "*No JavaScript files found*" >> optimizations/report.md
          fi
          
          echo "" >> optimizations/report.md
          
          # Optimize Bash examples
          echo "### Bash Examples" >> optimizations/report.md
          echo "" >> optimizations/report.md
          bash_files=0
          
          for file in examples/*.sh; do
            if [ -f "$file" ]; then
              echo "Optimizing: $file"
              filename=$(basename "$file")
              
              if python3 code-golf-optimizer.py -f "$file" -l bash > "optimizations/${filename}.txt" 2>&1; then
                original=$(grep "Original:" "optimizations/${filename}.txt" | grep -oP '\d+' | head -1 || echo "0")
                optimized=$(grep "Optimized:" "optimizations/${filename}.txt" | grep -oP '\d+' | head -1 || echo "0")
                reduction=$(grep "Reduction:" "optimizations/${filename}.txt" | grep -oP '\d+\.\d+' | head -1 || echo "0.0")
                
                total_original=$((total_original + original))
                total_optimized=$((total_optimized + optimized))
                bash_files=$((bash_files + 1))
                
                echo "- **$filename**: $original ‚Üí $optimized chars (${reduction}% reduction)" >> optimizations/report.md
              else
                echo "- **$filename**: ‚ö†Ô∏è Optimization failed" >> optimizations/report.md
              fi
            fi
          done
          
          if [ $bash_files -eq 0 ]; then
            echo "*No Bash files found*" >> optimizations/report.md
          fi
          
          echo "" >> optimizations/report.md
          echo "### Summary" >> optimizations/report.md
          echo "" >> optimizations/report.md
          echo "- **Total Original Size**: $total_original characters" >> optimizations/report.md
          echo "- **Total Optimized Size**: $total_optimized characters" >> optimizations/report.md
          
          saved=$((total_original - total_optimized))
          if [ $total_original -gt 0 ]; then
            # Use awk instead of bc for better portability
            overall_reduction=$(awk "BEGIN {printf \"%.2f\", ($saved * 100) / $total_original}")
            echo "- **Total Saved**: $saved characters (${overall_reduction}% reduction)" >> optimizations/report.md
          else
            echo "- **Total Saved**: 0 characters (no files optimized)" >> optimizations/report.md
          fi
          
          echo "" >> optimizations/report.md
          echo "---" >> optimizations/report.md
          echo "" >> optimizations/report.md
          echo "*Generated by the AI Code Golf Optimizer*" >> optimizations/report.md
          
          # Display report
          cat optimizations/report.md
          
          # Set output for issue creation
          echo "report_created=true" >> $GITHUB_OUTPUT
          echo "total_saved=$saved" >> $GITHUB_OUTPUT

      - name: Create optimization report issue
        if: steps.optimize.outputs.report_created == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd tools
          
          # Read the report
          report_body=$(cat optimizations/report.md)
          
          # Create an issue with the report (with fallback for labels)
          gh issue create \
            --title "üìä Code Golf Optimization Report - $(date +%Y-%m-%d)" \
            --body "$report_body" \
            --label "code-golf,ai-generated,report" || {
              echo "‚ö†Ô∏è Issue creation with labels failed, retrying without labels..."
              gh issue create \
                --title "üìä Code Golf Optimization Report - $(date +%Y-%m-%d)" \
                --body "$report_body"
            }
          
          echo "‚úÖ Created optimization report issue"

      - name: Log activity
        run: |
          echo "Code Golf Optimizer workflow completed"
          echo "Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
