name: "GitHub Actions Generator Agent (Using Custom Actions)"

# This is a demonstration version showing how the workflow could be simplified
# using the custom GitHub Actions generated by @engineer-master

on:
  workflow_dispatch:
    inputs:
      generate_actions:
        description: 'Actually generate and commit actions'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  generate-actions:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # BEFORE: 2 separate steps for Python setup and dependency installation
      # AFTER: Single action that handles both
      - name: Setup Python environment
        uses: ./.github/actions/python-automation
        with:
          python-version: '3.11'
          requirements-file: 'tools/requirements-generator.txt'  # Or inline: pyyaml
          run-tests: 'false'
          run-lint: 'false'

      - name: Run pattern analysis
        id: analyze
        run: |
          python3 tools/actions-pattern-analyzer.py \
            --output analysis/actions-patterns.json
          
          echo "Analysis complete"
          
          # Check if we found recommendations
          RECOMMENDATIONS=$(python3 -c "import json; data = json.load(open('analysis/actions-patterns.json')); print(len(data.get('recommendations', [])))")
          echo "recommendations_count=$RECOMMENDATIONS" >> $GITHUB_OUTPUT
          
          echo "Found $RECOMMENDATIONS recommendations"

      - name: Generate actions (dry-run)
        if: github.event.inputs.generate_actions != 'true'
        run: |
          python3 tools/actions-generator.py \
            --analysis analysis/actions-patterns.json \
            --output-dir .github/actions \
            --dry-run

      - name: Generate actions (actual)
        if: github.event.inputs.generate_actions == 'true'
        run: |
          python3 tools/actions-generator.py \
            --analysis analysis/actions-patterns.json \
            --output-dir .github/actions

      - name: Create PR with generated actions
        if: github.event.inputs.generate_actions == 'true' && steps.analyze.outputs.recommendations_count > 0
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check if there are changes
          git add .
          if git diff --staged --quiet; then
            echo "No new actions to generate"
            exit 0
          fi
          
          # Create unique branch name
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BRANCH_NAME="actions-generator/${TIMESTAMP}-${{ github.run_id }}"
          
          # Checkout new branch
          git checkout -b "$BRANCH_NAME"
          
          # Commit changes
          git commit -m "Generate custom GitHub Actions (@engineer-master)"
          
          # Push to new branch
          git push origin "$BRANCH_NAME"
          
          # Create pull request
          gh pr create \
            --title "ðŸ¤– Generated custom GitHub Actions (@engineer-master)" \
            --body "**@engineer-master** has generated ${{ steps.analyze.outputs.recommendations_count }} custom GitHub Actions based on repository patterns.

          ## ðŸŽ¯ What This PR Does

          This PR adds custom GitHub Actions generated by analyzing repository patterns:

          - Detected repeated operations that can be abstracted
          - Created reusable composite actions
          - Added comprehensive testing and deployment actions
          - All actions are validated and ready to use

          ## ðŸ“‹ Generated Actions

          See \`.github/actions/GENERATED_ACTIONS.md\` for a full list of generated actions.

          ## ðŸ” Analysis Details

          - Repository patterns analyzed
          - Existing workflows examined
          - Common operations identified
          - Recommendations prioritized

          ## ðŸš€ Usage

          Use these actions in your workflows:
          \`\`\`yaml
          - name: Use Python automation
            uses: ./.github/actions/python-automation
            with:
              python-version: '3.11'
              run-tests: 'true'
          \`\`\`

          ---
          *Generated by **@engineer-master** - Systematic action generation*" \
            --label "automated,agent:engineer-master,enhancement" \
            --base main \
            --head "$BRANCH_NAME"

      - name: Create issue for manual review
        if: github.event.inputs.generate_actions != 'true' && steps.analyze.outputs.recommendations_count > 0
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue create \
            --title "ðŸ¤– New GitHub Actions recommendations available" \
            --body "**@engineer-master** has analyzed the repository and found ${{ steps.analyze.outputs.recommendations_count }} opportunities for custom GitHub Actions.

          ## ðŸŽ¯ Summary

          The Actions Generator Agent has identified patterns that could benefit from custom GitHub Actions:

          - Repeated operations that can be abstracted
          - Testing patterns that can be automated
          - Deployment processes that can be streamlined

          ## ðŸ“Š Analysis Results

          View the full analysis in the workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          ## ðŸš€ Next Steps

          To generate these actions:
          1. Go to Actions â†’ GitHub Actions Generator Agent
          2. Click \"Run workflow\"
          3. Check \"Actually generate and commit actions\"
          4. Review the generated PR

          ---
          *Analysis by **@engineer-master** - Systematic pattern detection*" \
            --label "ai-generated,agent:engineer-master,enhancement"

      - name: Summary
        run: |
          echo "### GitHub Actions Generator Agent Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Recommendations found:** ${{ steps.analyze.outputs.recommendations_count }}" >> $GITHUB_STEP_SUMMARY
          echo "**Generate actions:** ${{ github.event.inputs.generate_actions }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event.inputs.generate_actions }}" == "true" ]; then
            echo "âœ… Actions generated and PR created" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ Dry-run mode - no actions generated" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Run with 'generate_actions' enabled to create actual actions" >> $GITHUB_STEP_SUMMARY
          fi

# Benefits of using custom actions in this workflow:
# 1. Reduced from 3 steps to 2 steps (Python setup + install)
# 2. Consistent Python environment setup
# 3. Easier to maintain - update action once, affects all workflows
# 4. Self-documenting - action name clearly indicates purpose
# 5. Reusable - same action used across 29+ workflows
