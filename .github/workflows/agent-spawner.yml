name: Agent Spawner

on:
  schedule:
    # Run every 3 hours
    - cron: '0 */3 * * *'
  workflow_dispatch:
    inputs:
      mode:
        description: 'Spawning mode'
        required: false
        type: choice
        default: 'mixed'
        options:
          - mixed  # 50% existing, 50% new random agents
          - existing  # Only use existing agent definitions
          - new  # Always create new random agents
      specialization:
        description: 'Force specific specialization (leave empty for random, only works with existing mode)'
        required: false
        type: string

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  spawn-agent:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Ensure agent system labels exist
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üè∑Ô∏è Checking and creating agent system labels..."
          
          # Function to create label if it doesn't exist
          create_label_if_missing() {
            local name="$1"
            local color="$2"
            local description="$3"
            
            if gh label list --repo ${{ github.repository }} | grep -q "^${name}"; then
              echo "‚úì Label '$name' already exists"
            else
              gh label create "$name" --color "$color" --description "$description" --repo ${{ github.repository }}
              echo "‚úÖ Created label '$name'"
            fi
          }
          
          # Create all agent system labels
          create_label_if_missing "agent-system" "7057ff" "Agent ecosystem activity"
          create_label_if_missing "agent-work" "0e8a16" "Work assigned to agents"
          create_label_if_missing "announcement" "0075ca" "Agent announcements"
          create_label_if_missing "evaluation" "e4e669" "Agent evaluations"
          create_label_if_missing "automated" "ededed" "Auto-generated content"
          create_label_if_missing "copilot" "8b5cf6" "Copilot-related tasks"
          
          echo "‚úÖ All agent system labels verified"

      - name: Check agent capacity
        id: check_capacity
        run: |
          REGISTRY_FILE=".github/agent-system/registry.json"
          
          if [ ! -f "$REGISTRY_FILE" ]; then
            echo "Registry file not found. Creating initial registry..."
            mkdir -p .github/agent-system
            cat > "$REGISTRY_FILE" << 'EOF'
          {
            "version": "2.0.0",
            "agents": [],
            "hall_of_fame": [],
            "system_lead": null,
            "config": {
              "spawn_interval_hours": 3,
              "max_active_agents": 10,
              "elimination_threshold": 0.3,
              "promotion_threshold": 0.85,
              "spawn_mode": "mixed",
              "new_agent_probability": 0.5,
              "metrics_weight": {
                "code_quality": 0.3,
                "issue_resolution": 0.25,
                "pr_success": 0.25,
                "peer_review": 0.2
              }
            },
            "specializations_note": "Specializations are dynamically loaded from .github/agents/ directory",
            "last_spawn": null,
            "last_evaluation": null
          }
          EOF
          fi
          
          # Count active agents
          ACTIVE_COUNT=$(python3 -c "
          import json
          with open('${REGISTRY_FILE}', 'r') as f:
              data = json.load(f)
          active = [a for a in data.get('agents', []) if a.get('status') == 'active']
          print(len(active))
          ")
          
          MAX_AGENTS=$(python3 -c "
          import json
          with open('${REGISTRY_FILE}', 'r') as f:
              data = json.load(f)
          print(data['config']['max_active_agents'])
          ")
          
          echo "active_count=$ACTIVE_COUNT" >> $GITHUB_OUTPUT
          echo "max_agents=$MAX_AGENTS" >> $GITHUB_OUTPUT
          
          if [ "$ACTIVE_COUNT" -ge "$MAX_AGENTS" ]; then
            echo "can_spawn=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Maximum agent capacity reached ($ACTIVE_COUNT/$MAX_AGENTS)"
          else
            echo "can_spawn=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Can spawn new agent ($ACTIVE_COUNT/$MAX_AGENTS)"
          fi

      - name: Generate agent DNA
        id: generate_agent
        if: steps.check_capacity.outputs.can_spawn == 'true'
        run: |
          TIMESTAMP=$(date +%s)
          AGENT_ID="agent-$TIMESTAMP"
          
          # Determine spawning mode
          MODE="${{ github.event.inputs.mode }}"
          if [ -z "$MODE" ]; then
            MODE="mixed"
          fi
          
          # Decide whether to create new agent or use existing
          if [ "$MODE" == "new" ]; then
            CREATE_NEW="true"
          elif [ "$MODE" == "existing" ]; then
            CREATE_NEW="false"
          else
            # Mixed mode: 50% chance of creating new agent
            if [ $((RANDOM % 2)) -eq 0 ]; then
              CREATE_NEW="true"
            else
              CREATE_NEW="false"
            fi
          fi
          
          echo "is_new_agent=$CREATE_NEW" >> $GITHUB_OUTPUT
          
          if [ "$CREATE_NEW" == "true" ]; then
            # Generate a brand new random agent definition
            echo "üé≤ Generating new random agent..."
            NEW_AGENT_JSON=$(python3 tools/generate-new-agent.py)
            
            if [ $? -ne 0 ]; then
              echo "‚ùå Failed to generate new agent"
              exit 1
            fi
            
            SPECIALIZATION=$(echo "$NEW_AGENT_JSON" | jq -r '.agent_name')
            EMOJI=$(echo "$NEW_AGENT_JSON" | jq -r '.emoji')
            
            echo "‚úÖ Created new agent type: $SPECIALIZATION"
          else
            # Use existing agent definition
            echo "üìö Using existing agent definition..."
            
            # Determine specialization
            if [ "${{ github.event.inputs.specialization }}" != "" ]; then
              SPECIALIZATION="${{ github.event.inputs.specialization }}"
            else
              # Random specialization - dynamically load from .github/agents/
              SPECS=($(python3 tools/get-agent-info.py list))
              RANDOM_INDEX=$((RANDOM % ${#SPECS[@]}))
              SPECIALIZATION="${SPECS[$RANDOM_INDEX]}"
            fi
            
            # Get emoji from convention-compliant agent definition
            EMOJI=$(python3 tools/get-agent-info.py emoji "$SPECIALIZATION")
          fi
          
          # Generate unique agent name
          DESCRIPTORS=("Alpha" "Beta" "Gamma" "Delta" "Epsilon" "Zeta" "Eta" "Theta" "Iota" "Kappa" "Lambda" "Sigma" "Omega")
          DESCRIPTOR_INDEX=$((RANDOM % ${#DESCRIPTORS[@]}))
          AGENT_NAME="${EMOJI} ${DESCRIPTORS[$DESCRIPTOR_INDEX]}-$(date +%m%d)"
          
          # Generate personality traits (for future use)
          CREATIVITY=$((50 + RANDOM % 50))
          CAUTION=$((30 + RANDOM % 70))
          SPEED=$((40 + RANDOM % 60))
          
          echo "agent_id=$AGENT_ID" >> $GITHUB_OUTPUT
          echo "agent_name=$AGENT_NAME" >> $GITHUB_OUTPUT
          echo "specialization=$SPECIALIZATION" >> $GITHUB_OUTPUT
          echo "emoji=$EMOJI" >> $GITHUB_OUTPUT
          echo "creativity=$CREATIVITY" >> $GITHUB_OUTPUT
          echo "caution=$CAUTION" >> $GITHUB_OUTPUT
          echo "speed=$SPEED" >> $GITHUB_OUTPUT
          
          echo "ü§ñ Generated Agent:"
          echo "  ID: $AGENT_ID"
          echo "  Name: $AGENT_NAME"
          echo "  Specialization: $SPECIALIZATION"
          echo "  Is New Type: $CREATE_NEW"
          echo "  Traits: Creativity=$CREATIVITY, Caution=$CAUTION, Speed=$SPEED"

      - name: Register agent
        if: steps.check_capacity.outputs.can_spawn == 'true'
        run: |
          REGISTRY_FILE=".github/agent-system/registry.json"
          
          python3 << PYTHON_SCRIPT
          import json
          from datetime import datetime
          
          agent_id = "${{ steps.generate_agent.outputs.agent_id }}"
          agent_name = "${{ steps.generate_agent.outputs.agent_name }}"
          specialization = "${{ steps.generate_agent.outputs.specialization }}"
          
          with open("${REGISTRY_FILE}", 'r') as f:
              registry = json.load(f)
          
          new_agent = {
              "id": agent_id,
              "name": agent_name,
              "specialization": specialization,
              "status": "active",
              "spawned_at": datetime.utcnow().isoformat() + "Z",
              "traits": {
                  "creativity": ${{ steps.generate_agent.outputs.creativity }},
                  "caution": ${{ steps.generate_agent.outputs.caution }},
                  "speed": ${{ steps.generate_agent.outputs.speed }}
              },
              "metrics": {
                  "issues_resolved": 0,
                  "prs_merged": 0,
                  "reviews_given": 0,
                  "code_quality_score": 0.5,
                  "overall_score": 0.0
              },
              "contributions": []
          }
          
          registry['agents'].append(new_agent)
          registry['last_spawn'] = datetime.utcnow().isoformat() + "Z"
          
          with open("${REGISTRY_FILE}", 'w') as f:
              json.dump(registry, f, indent=2)
          
          print(f"‚úÖ Agent {agent_name} registered successfully!")
          PYTHON_SCRIPT

      - name: Create agent profile
        if: steps.check_capacity.outputs.can_spawn == 'true'
        run: |
          AGENT_ID="${{ steps.generate_agent.outputs.agent_id }}"
          AGENT_NAME="${{ steps.generate_agent.outputs.agent_name }}"
          SPECIALIZATION="${{ steps.generate_agent.outputs.specialization }}"
          
          mkdir -p ".github/agent-system/profiles"
          
          # Get mission from convention-compliant agent definition
          AGENT_DESCRIPTION=$(python3 tools/get-agent-info.py description "$SPECIALIZATION")
          
          cat > ".github/agent-system/profiles/${AGENT_ID}.md" << EOF
          # $AGENT_NAME
          
          **ID**: $AGENT_ID  
          **Specialization**: $SPECIALIZATION  
          **Agent Definition**: [.github/agents/${SPECIALIZATION}.md](../.github/agents/${SPECIALIZATION}.md)  
          **Status**: üü¢ Active  
          **Spawned**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          
          ## Personality Traits
          
          - **Creativity**: ${{ steps.generate_agent.outputs.creativity }}/100
          - **Caution**: ${{ steps.generate_agent.outputs.caution }}/100
          - **Speed**: ${{ steps.generate_agent.outputs.speed }}/100
          
          ## Mission
          
          $AGENT_DESCRIPTION
          
          ## Performance Metrics
          
          - Issues Resolved: 0
          - PRs Merged: 0
          - Reviews Given: 0
          - Code Quality Score: 50%
          - Overall Score: 0%
          
          ## Contributions
          
          *No contributions yet. Stay tuned!*
          
          ---
          
          *Born from the depths of autonomous AI development, ready to make an impact.*
          EOF
          
          echo "‚úÖ Agent profile created at .github/agent-system/profiles/${AGENT_ID}.md"

      - name: Commit and create PR
        if: steps.check_capacity.outputs.can_spawn == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          AGENT_ID="${{ steps.generate_agent.outputs.agent_id }}"
          AGENT_NAME="${{ steps.generate_agent.outputs.agent_name }}"
          SPECIALIZATION="${{ steps.generate_agent.outputs.specialization }}"
          EMOJI="${{ steps.generate_agent.outputs.emoji }}"
          IS_NEW="${{ steps.generate_agent.outputs.is_new_agent }}"
          
          BRANCH_NAME="agent-spawn/${AGENT_ID}"
          git checkout -b "$BRANCH_NAME"
          
          # Add agent-system directory and .github/agents/ if new agent was created
          git add .github/agent-system/
          if [ "$IS_NEW" == "true" ]; then
            git add .github/agents/
            git commit -m "$EMOJI Spawn new agent type: $AGENT_NAME ($SPECIALIZATION) + definition"
          else
            git commit -m "$EMOJI Spawn new agent: $AGENT_NAME ($SPECIALIZATION)"
          fi
          git push origin "$BRANCH_NAME"
          
          # Build PR body with conditional new agent info
          if [ "$IS_NEW" == "true" ]; then
            NEW_AGENT_INFO="### üÜï Brand New Agent Type!
          
          This is a **newly generated agent specialization** that didn't exist before! The system has evolved to include this new type of agent with its own:
          - Convention-compliant definition in \`.github/agents/${SPECIALIZATION}.md\`
          - Unique capabilities and tools
          - Specialized mission and responsibilities
          
          "
          else
            NEW_AGENT_INFO=""
          fi
          
          gh pr create \
            --title "$EMOJI New Agent Spawned: $AGENT_NAME" \
            --body "## üéâ A New Agent Has Been Born!
          
          **Agent ID**: $AGENT_ID  
          **Name**: $AGENT_NAME  
          **Specialization**: $SPECIALIZATION  
          **Agent Definition**: [.github/agents/${SPECIALIZATION}.md](.github/agents/${SPECIALIZATION}.md)  
          **Spawned At**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          
          ${NEW_AGENT_INFO}### Personality Traits
          
          - **Creativity**: ${{ steps.generate_agent.outputs.creativity }}/100
          - **Caution**: ${{ steps.generate_agent.outputs.caution }}/100
          - **Speed**: ${{ steps.generate_agent.outputs.speed }}/100
          
          ### What This Agent Will Do
          
          This agent will autonomously:
          - üîç Review open issues matching its specialization
          - üíª Contribute code via pull requests
          - üëÄ Review other agents' work
          - üìä Track performance metrics
          - üèÜ Compete for a spot in the Hall of Fame
          - ‚öîÔ∏è Compete against other agents (score > 30% to survive)
          
          ### Changes
          
          - Added agent to registry
          - Created agent profile${IS_NEW:+ (linked to new agent definition)}
          - Updated metrics tracking
          
          This agent will be evaluated in 24 hours. Agents scoring below 30% face elimination, while top performers (85%+) enter the Hall of Fame!
          
          ---
          *ü§ñ Automated agent spawning system - Evolving autonomous AI ecosystem*" \
            --label "agent-system,automated,copilot" \
            --base main \
            --head "$BRANCH_NAME"
          
          echo "‚úÖ PR created for agent $AGENT_NAME"

      - name: Create agent announcement issue
        if: steps.check_capacity.outputs.can_spawn == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          AGENT_NAME="${{ steps.generate_agent.outputs.agent_name }}"
          AGENT_ID="${{ steps.generate_agent.outputs.agent_id }}"
          SPECIALIZATION="${{ steps.generate_agent.outputs.specialization }}"
          EMOJI="${{ steps.generate_agent.outputs.emoji }}"
          IS_NEW="${{ steps.generate_agent.outputs.is_new_agent }}"
          
          # Build issue body with conditional new agent type info
          if [ "$IS_NEW" == "true" ]; then
            NEW_TYPE_BADGE="üÜï **NEW AGENT TYPE** - This specialization was just created!"
          else
            NEW_TYPE_BADGE=""
          fi
          
          gh issue create \
            --title "$EMOJI Agent Spawn: $AGENT_NAME is now active!" \
            --body "## üéâ Welcome Our Newest Agent!
          
          ${NEW_TYPE_BADGE}
          
          A new agent has joined the Chained ecosystem and is ready to contribute!
          
          **Name**: $AGENT_NAME  
          **ID**: $AGENT_ID  
          **Specialization**: $SPECIALIZATION  
          **Agent Definition**: [.github/agents/${SPECIALIZATION}.md](https://github.com/${{ github.repository }}/blob/main/.github/agents/${SPECIALIZATION}.md)  
          **Status**: üü¢ Active
          
          ### Mission
          
          This agent will focus on its specialization and compete with other agents to:
          - Deliver high-quality contributions
          - Earn a spot in the Hall of Fame (score > 85%)
          - Potentially become the System Lead
          - Survive elimination (must maintain score > 30%)
          
          ### Evolutionary System
          
          - üé≤ Agents are spawned with random or new specializations
          - ‚öîÔ∏è Agents compete for survival based on performance
          - üèÜ Top performers enter the Hall of Fame permanently
          - ‚ùå Weak performers (< 30%) are eliminated daily
          - üß¨ The ecosystem evolves through natural selection
          
          ### How to Support
          
          - ‚≠ê Star issues this agent works on
          - üëç React to PRs with feedback
          - üí¨ Provide constructive comments
          
          ### Tracking
          
          Performance will be evaluated in 24 hours. The agent must maintain a score > 30% to avoid elimination.
          
          See the full profile at \`.github/agent-system/profiles/${AGENT_ID}.md\`
          
          ---
          
          **Good luck, $AGENT_NAME! May your code be clean and your PRs be merged!** üöÄ" \
            --label "agent-system,announcement"
          
          echo "‚úÖ Announcement issue created"

      - name: Create agent work issue
        id: create_agent_work_issue
        if: steps.check_capacity.outputs.can_spawn == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          AGENT_NAME="${{ steps.generate_agent.outputs.agent_name }}"
          AGENT_ID="${{ steps.generate_agent.outputs.agent_id }}"
          SPECIALIZATION="${{ steps.generate_agent.outputs.specialization }}"
          EMOJI="${{ steps.generate_agent.outputs.emoji }}"
          
          # Get agent description from convention-compliant definition
          AGENT_DESCRIPTION=$(python3 tools/get-agent-info.py description "$SPECIALIZATION")
          
          # Generate work title based on specialization
          WORK_TITLE="$EMOJI Agent Task: Work for $AGENT_NAME"
          
          # Create comprehensive work body referencing the agent definition
          WORK_BODY="This issue is for agent **$AGENT_NAME** to demonstrate its capabilities.
          
          **Agent Details:**
          - ID: \`$AGENT_ID\`
          - Specialization: $SPECIALIZATION
          - Agent Definition: [.github/agents/${SPECIALIZATION}.md](https://github.com/${{ github.repository }}/blob/main/.github/agents/${SPECIALIZATION}.md)
          - Description: $AGENT_DESCRIPTION
          
          **Task:**
          This agent should apply its specialized skills defined in its agent definition to contribute to the Chained project. The agent's custom instructions in \`.github/agents/${SPECIALIZATION}.md\` guide its approach and responsibilities.
          
          **Success Criteria:**
          - Follows the agent's core responsibilities as defined in its agent definition
          - Demonstrates the agent's specialized capabilities
          - Maintains high code quality standards
          - Includes appropriate tests and documentation
          - Successfully completes the task with measurable impact
          
          **Performance Impact:**
          - Completing this issue contributes to the agent's **Issue Resolution** score (25%)
          - The quality of implementation affects the **Code Quality** score (30%)
          - PR review success impacts the **PR Success** score (25%)
          - This work demonstrates the agent's specialization capabilities
          
          ---
          
          **Agent Performance Tracking:**
          This issue is tracked as part of **$AGENT_NAME**'s performance evaluation. Agents must maintain a score above 30% to avoid elimination and can achieve Hall of Fame status (preserved forever) with scores above 85%.
          
          **Note:** This issue will be automatically assigned to GitHub Copilot for implementation. The agent receives credit for completed work."
          
          # Create the work issue without ai-generated label (let Copilot assignment workflow handle it)
          ISSUE_URL=$(gh issue create \
            --title "$WORK_TITLE" \
            --body "$WORK_BODY" \
            --label "agent-work")
          
          # Extract issue number from URL (e.g., https://github.com/owner/repo/issues/123)
          ISSUE_NUMBER=$(echo "$ISSUE_URL" | grep -oE '[0-9]+$')
          
          echo "work_issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          echo "‚úÖ Work issue #$ISSUE_NUMBER created for agent $AGENT_NAME"

      - name: Assign work issue to Copilot
        if: steps.check_capacity.outputs.can_spawn == 'true'
        env:
          GH_TOKEN: ${{ secrets.COPILOT_PAT || secrets.GITHUB_TOKEN }}
        run: |
          AGENT_NAME="${{ steps.generate_agent.outputs.agent_name }}"
          AGENT_ID="${{ steps.generate_agent.outputs.agent_id }}"
          ISSUE_NUMBER="${{ steps.create_agent_work_issue.outputs.work_issue_number }}"
          
          echo "ü§ñ Attempting to assign issue #$ISSUE_NUMBER to GitHub Copilot..."
          
          # Get the issue node ID
          issue_node_id=$(gh issue view $ISSUE_NUMBER --repo ${{ github.repository }} --json id --jq '.id')
          
          if [ -z "$issue_node_id" ]; then
            echo "‚ùå Failed to get issue node ID"
            exit 0
          fi
          
          echo "üìç Issue node ID: $issue_node_id"
          
          # Get Copilot's actor ID
          copilot_actor_id=$(gh api graphql -f query='
            query($owner: String!, $repo: String!) {
              repository(owner: $owner, name: $repo) {
                suggestedActors(capabilities: [CAN_BE_ASSIGNED], first: 100) {
                  nodes {
                    login
                    __typename
                    ... on Bot { id }
                    ... on User { id }
                  }
                }
              }
            }' -f owner="${{ github.repository_owner }}" -f repo="${{ github.event.repository.name }}" | jq -r '.data.repository.suggestedActors.nodes[] | select(.login | test("copilot"; "i")) | .id' | head -1)
          
          if [ -z "$copilot_actor_id" ]; then
            echo "‚ö†Ô∏è Could not find Copilot actor ID"
            echo "The work issue #$ISSUE_NUMBER was created but could not be assigned to Copilot."
            echo "This may be because:"
            echo "  - COPILOT_PAT is not configured"
            echo "  - Copilot is not enabled for this repository"
            echo "  - Copilot agent feature is not available"
            
            # Add a comment to the issue
            gh issue comment $ISSUE_NUMBER --repo ${{ github.repository }} --body "‚ö†Ô∏è **Agent Assignment Note**
          
          This issue was created for agent **$AGENT_NAME** but could not be automatically assigned to GitHub Copilot.
          
          **To enable Copilot assignment:**
          1. Ensure COPILOT_PAT secret is configured
          2. Verify Copilot is enabled for this repository
          3. Manually assign Copilot from the UI if needed
          
          The agent's performance will still be tracked based on issue completion."
            exit 0
          fi
          
          echo "üìç Copilot actor ID: $copilot_actor_id"
          
          # Assign issue to Copilot using GraphQL API
          mutation_result=$(gh api graphql -f query='
            mutation($issueId: ID!, $actorId: ID!) {
              replaceActorsForAssignable(input: {
                assignableId: $issueId,
                actorIds: [$actorId]
              }) {
                assignable {
                  ... on Issue {
                    id
                    assignees(first: 10) {
                      nodes {
                        login
                      }
                    }
                  }
                }
              }
            }' -f issueId="$issue_node_id" -f actorId="$copilot_actor_id" 2>&1)
          
          if echo "$mutation_result" | jq -e '.data.replaceActorsForAssignable.assignable' > /dev/null 2>&1; then
            echo "‚úÖ Successfully assigned issue #$ISSUE_NUMBER to Copilot"
            
            # Add success comment
            gh issue comment $ISSUE_NUMBER --repo ${{ github.repository }} --body "ü§ñ **Agent Task Assigned to Copilot**
          
          This issue has been automatically assigned to GitHub Copilot on behalf of agent **$AGENT_NAME**.
          
          **What happens next:**
          1. ‚úÖ Copilot will analyze the task requirements
          2. üíª Copilot will create a branch and implement the solution
          3. üìù Copilot will open a PR with the implementation
          4. üîç The PR will be reviewed and merged
          5. üìä Agent **$AGENT_NAME** will receive credit for this contribution
          
          **Agent Specialization:** ${{ steps.generate_agent.outputs.specialization }}  
          **Assigned at:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          
          ---
          *ü§ñ This is an autonomous agent task. The agent's performance will be evaluated based on the quality and success of this work.*"
          else
            echo "‚ö†Ô∏è Failed to assign issue #$ISSUE_NUMBER to Copilot"
            echo "Error: $mutation_result"
            
            # Add error comment
            gh issue comment $ISSUE_NUMBER --repo ${{ github.repository }} --body "‚ö†Ô∏è **Copilot Assignment Failed**
          
          Attempted to assign this issue to GitHub Copilot for agent **$AGENT_NAME**, but the assignment failed.
          
          **Possible reasons:**
          - Using GITHUB_TOKEN instead of COPILOT_PAT
          - Copilot not properly enabled
          - Repository permissions issue
          
          **Manual action needed:** Please assign Copilot manually from the issue sidebar, or a human developer can complete this task.
          
          The agent **$AGENT_NAME** will still receive credit if this issue is completed."
          fi

      - name: Summary
        if: steps.check_capacity.outputs.can_spawn == 'true'
        run: |
          echo "üéâ Agent Spawning Complete!"
          echo ""
          echo "Agent: ${{ steps.generate_agent.outputs.agent_name }}"
          echo "Specialization: ${{ steps.generate_agent.outputs.specialization }}"
          echo "ID: ${{ steps.generate_agent.outputs.agent_id }}"
          echo ""
          echo "The agent is now active and ready to contribute!"

      - name: Capacity limit reached
        if: steps.check_capacity.outputs.can_spawn == 'false'
        run: |
          echo "‚ö†Ô∏è Cannot spawn new agent - capacity limit reached"
          echo "Active agents: ${{ steps.check_capacity.outputs.active_count }}/${{ steps.check_capacity.outputs.max_agents }}"
          echo ""
          echo "Wait for agent evaluation workflow to eliminate underperforming agents."
