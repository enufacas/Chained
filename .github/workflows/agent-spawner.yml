name: Agent Spawner

on:
  schedule:
    # Run every 3 hours
    - cron: '0 */3 * * *'
  workflow_dispatch:
    inputs:
      specialization:
        description: 'Force specific specialization (leave empty for random)'
        required: false
        type: choice
        options:
          - random
          - bug-hunter
          - feature-architect
          - test-champion
          - doc-master
          - performance-optimizer
          - security-guardian
          - code-poet
          - refactor-wizard
          - integration-specialist
          - ux-enhancer

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  spawn-agent:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Ensure agent system labels exist
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üè∑Ô∏è Checking and creating agent system labels..."
          
          # Function to create label if it doesn't exist
          create_label_if_missing() {
            local name="$1"
            local color="$2"
            local description="$3"
            
            if gh label list --repo ${{ github.repository }} | grep -q "^${name}"; then
              echo "‚úì Label '$name' already exists"
            else
              gh label create "$name" --color "$color" --description "$description" --repo ${{ github.repository }}
              echo "‚úÖ Created label '$name'"
            fi
          }
          
          # Create all agent system labels
          create_label_if_missing "agent-system" "7057ff" "Agent ecosystem activity"
          create_label_if_missing "agent-work" "0e8a16" "Work assigned to agents"
          create_label_if_missing "announcement" "0075ca" "Agent announcements"
          create_label_if_missing "evaluation" "e4e669" "Agent evaluations"
          create_label_if_missing "automated" "ededed" "Auto-generated content"
          create_label_if_missing "copilot" "8b5cf6" "Copilot-related tasks"
          
          echo "‚úÖ All agent system labels verified"

      - name: Check agent capacity
        id: check_capacity
        run: |
          REGISTRY_FILE="agents/registry.json"
          
          if [ ! -f "$REGISTRY_FILE" ]; then
            echo "Registry file not found. Creating initial registry..."
            mkdir -p agents
            cat > "$REGISTRY_FILE" << 'EOF'
          {
            "version": "1.0.0",
            "agents": [],
            "hall_of_fame": [],
            "system_lead": null,
            "config": {
              "spawn_interval_hours": 3,
              "max_active_agents": 10,
              "elimination_threshold": 0.3,
              "promotion_threshold": 0.85,
              "metrics_weight": {
                "code_quality": 0.3,
                "issue_resolution": 0.25,
                "pr_success": 0.25,
                "peer_review": 0.2
              }
            },
            "specializations": [
              "bug-hunter",
              "feature-architect",
              "test-champion",
              "doc-master",
              "performance-optimizer",
              "security-guardian",
              "code-poet",
              "refactor-wizard",
              "integration-specialist",
              "ux-enhancer"
            ],
            "last_spawn": null,
            "last_evaluation": null
          }
          EOF
          fi
          
          # Count active agents
          ACTIVE_COUNT=$(python3 -c "
          import json
          with open('$REGISTRY_FILE', 'r') as f:
              data = json.load(f)
          active = [a for a in data.get('agents', []) if a.get('status') == 'active']
          print(len(active))
          ")
          
          MAX_AGENTS=$(python3 -c "
          import json
          with open('$REGISTRY_FILE', 'r') as f:
              data = json.load(f)
          print(data['config']['max_active_agents'])
          ")
          
          echo "active_count=$ACTIVE_COUNT" >> $GITHUB_OUTPUT
          echo "max_agents=$MAX_AGENTS" >> $GITHUB_OUTPUT
          
          if [ "$ACTIVE_COUNT" -ge "$MAX_AGENTS" ]; then
            echo "can_spawn=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Maximum agent capacity reached ($ACTIVE_COUNT/$MAX_AGENTS)"
          else
            echo "can_spawn=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Can spawn new agent ($ACTIVE_COUNT/$MAX_AGENTS)"
          fi

      - name: Generate agent DNA
        id: generate_agent
        if: steps.check_capacity.outputs.can_spawn == 'true'
        run: |
          TIMESTAMP=$(date +%s)
          AGENT_ID="agent-$TIMESTAMP"
          
          # Determine specialization
          if [ "${{ github.event.inputs.specialization }}" != "" ] && [ "${{ github.event.inputs.specialization }}" != "random" ]; then
            SPECIALIZATION="${{ github.event.inputs.specialization }}"
          else
            # Random specialization
            SPECS=("bug-hunter" "feature-architect" "test-champion" "doc-master" "performance-optimizer" "security-guardian" "code-poet" "refactor-wizard" "integration-specialist" "ux-enhancer")
            RANDOM_INDEX=$((RANDOM % ${#SPECS[@]}))
            SPECIALIZATION="${SPECS[$RANDOM_INDEX]}"
          fi
          
          # Generate unique agent name based on specialization
          case "$SPECIALIZATION" in
            "bug-hunter")
              NAMES=("Debugger" "Squasher" "Tracer" "Hunter" "Fixer")
              EMOJI="üêõ"
              ;;
            "feature-architect")
              NAMES=("Builder" "Designer" "Architect" "Creator" "Innovator")
              EMOJI="üèóÔ∏è"
              ;;
            "test-champion")
              NAMES=("Validator" "Checker" "Guardian" "Tester" "Prover")
              EMOJI="‚úÖ"
              ;;
            "doc-master")
              NAMES=("Scribe" "Writer" "Documenter" "Explainer" "Teacher")
              EMOJI="üìö"
              ;;
            "performance-optimizer")
              NAMES=("Speedster" "Optimizer" "Tuner" "Enhancer" "Accelerator")
              EMOJI="‚ö°"
              ;;
            "security-guardian")
              NAMES=("Shield" "Protector" "Guardian" "Sentinel" "Defender")
              EMOJI="üõ°Ô∏è"
              ;;
            "code-poet")
              NAMES=("Poet" "Artist" "Craftsman" "Stylist" "Elegance")
              EMOJI="üé®"
              ;;
            "refactor-wizard")
              NAMES=("Wizard" "Transformer" "Refiner" "Cleaner" "Organizer")
              EMOJI="‚ôªÔ∏è"
              ;;
            "integration-specialist")
              NAMES=("Connector" "Linker" "Bridge" "Integrator" "Joiner")
              EMOJI="üîå"
              ;;
            "ux-enhancer")
              NAMES=("Enhancer" "Polisher" "Improver" "Beautifier" "UXpert")
              EMOJI="‚ú®"
              ;;
          esac
          
          NAME_INDEX=$((RANDOM % ${#NAMES[@]}))
          AGENT_NAME="${EMOJI} ${NAMES[$NAME_INDEX]}-$(date +%m%d)"
          
          # Generate personality traits (for future use)
          CREATIVITY=$((50 + RANDOM % 50))
          CAUTION=$((30 + RANDOM % 70))
          SPEED=$((40 + RANDOM % 60))
          
          echo "agent_id=$AGENT_ID" >> $GITHUB_OUTPUT
          echo "agent_name=$AGENT_NAME" >> $GITHUB_OUTPUT
          echo "specialization=$SPECIALIZATION" >> $GITHUB_OUTPUT
          echo "emoji=$EMOJI" >> $GITHUB_OUTPUT
          echo "creativity=$CREATIVITY" >> $GITHUB_OUTPUT
          echo "caution=$CAUTION" >> $GITHUB_OUTPUT
          echo "speed=$SPEED" >> $GITHUB_OUTPUT
          
          echo "ü§ñ Generated Agent:"
          echo "  ID: $AGENT_ID"
          echo "  Name: $AGENT_NAME"
          echo "  Specialization: $SPECIALIZATION"
          echo "  Traits: Creativity=$CREATIVITY, Caution=$CAUTION, Speed=$SPEED"

      - name: Register agent
        if: steps.check_capacity.outputs.can_spawn == 'true'
        run: |
          REGISTRY_FILE="agents/registry.json"
          
          python3 << 'PYTHON_SCRIPT'
          import json
          from datetime import datetime
          
          agent_id = "${{ steps.generate_agent.outputs.agent_id }}"
          agent_name = "${{ steps.generate_agent.outputs.agent_name }}"
          specialization = "${{ steps.generate_agent.outputs.specialization }}"
          
          with open("$REGISTRY_FILE", 'r') as f:
              registry = json.load(f)
          
          new_agent = {
              "id": agent_id,
              "name": agent_name,
              "specialization": specialization,
              "status": "active",
              "spawned_at": datetime.utcnow().isoformat() + "Z",
              "traits": {
                  "creativity": ${{ steps.generate_agent.outputs.creativity }},
                  "caution": ${{ steps.generate_agent.outputs.caution }},
                  "speed": ${{ steps.generate_agent.outputs.speed }}
              },
              "metrics": {
                  "issues_resolved": 0,
                  "prs_merged": 0,
                  "reviews_given": 0,
                  "code_quality_score": 0.5,
                  "overall_score": 0.0
              },
              "contributions": []
          }
          
          registry['agents'].append(new_agent)
          registry['last_spawn'] = datetime.utcnow().isoformat() + "Z"
          
          with open("$REGISTRY_FILE", 'w') as f:
              json.dump(registry, f, indent=2)
          
          print(f"‚úÖ Agent {agent_name} registered successfully!")
          PYTHON_SCRIPT

      - name: Create agent profile
        if: steps.check_capacity.outputs.can_spawn == 'true'
        run: |
          AGENT_ID="${{ steps.generate_agent.outputs.agent_id }}"
          AGENT_NAME="${{ steps.generate_agent.outputs.agent_name }}"
          SPECIALIZATION="${{ steps.generate_agent.outputs.specialization }}"
          
          mkdir -p "agents/profiles"
          
          cat > "agents/profiles/${AGENT_ID}.md" << EOF
          # $AGENT_NAME
          
          **ID**: $AGENT_ID  
          **Specialization**: $SPECIALIZATION  
          **Status**: üü¢ Active  
          **Spawned**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          
          ## Personality Traits
          
          - **Creativity**: ${{ steps.generate_agent.outputs.creativity }}/100
          - **Caution**: ${{ steps.generate_agent.outputs.caution }}/100
          - **Speed**: ${{ steps.generate_agent.outputs.speed }}/100
          
          ## Mission
          
          EOF
          
          case "$SPECIALIZATION" in
            "bug-hunter")
              echo "Find and eliminate bugs with precision. Leave no stone unturned in the quest for stability." >> "agents/profiles/${AGENT_ID}.md"
              ;;
            "feature-architect")
              echo "Design and build innovative features that push the boundaries of what's possible." >> "agents/profiles/${AGENT_ID}.md"
              ;;
            "test-champion")
              echo "Ensure every line of code is tested and validated. Quality is non-negotiable." >> "agents/profiles/${AGENT_ID}.md"
              ;;
            "doc-master")
              echo "Transform complex code into clear, accessible documentation. Knowledge should be shared." >> "agents/profiles/${AGENT_ID}.md"
              ;;
            "performance-optimizer")
              echo "Make everything faster, leaner, and more efficient. Performance is a feature." >> "agents/profiles/${AGENT_ID}.md"
              ;;
            "security-guardian")
              echo "Protect the codebase from vulnerabilities. Security is everyone's responsibility." >> "agents/profiles/${AGENT_ID}.md"
              ;;
            "code-poet")
              echo "Write code that reads like poetry. Beauty and functionality are not mutually exclusive." >> "agents/profiles/${AGENT_ID}.md"
              ;;
            "refactor-wizard")
              echo "Transform chaotic code into elegant solutions. Simplicity is the ultimate sophistication." >> "agents/profiles/${AGENT_ID}.md"
              ;;
            "integration-specialist")
              echo "Connect systems seamlessly. Integration should be invisible and reliable." >> "agents/profiles/${AGENT_ID}.md"
              ;;
            "ux-enhancer")
              echo "Polish every interaction. User experience is what separates good from great." >> "agents/profiles/${AGENT_ID}.md"
              ;;
          esac
          
          cat >> "agents/profiles/${AGENT_ID}.md" << EOF
          
          ## Performance Metrics
          
          - Issues Resolved: 0
          - PRs Merged: 0
          - Reviews Given: 0
          - Code Quality Score: 50%
          - Overall Score: 0%
          
          ## Contributions
          
          *No contributions yet. Stay tuned!*
          
          ---
          
          *Born from the depths of autonomous AI development, ready to make an impact.*
          EOF
          
          echo "‚úÖ Agent profile created at agents/profiles/${AGENT_ID}.md"

      - name: Commit and create PR
        if: steps.check_capacity.outputs.can_spawn == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          AGENT_ID="${{ steps.generate_agent.outputs.agent_id }}"
          AGENT_NAME="${{ steps.generate_agent.outputs.agent_name }}"
          SPECIALIZATION="${{ steps.generate_agent.outputs.specialization }}"
          EMOJI="${{ steps.generate_agent.outputs.emoji }}"
          
          BRANCH_NAME="agent-spawn/${AGENT_ID}"
          git checkout -b "$BRANCH_NAME"
          
          git add agents/
          git commit -m "$EMOJI Spawn new agent: $AGENT_NAME ($SPECIALIZATION)"
          git push origin "$BRANCH_NAME"
          
          gh pr create \
            --title "$EMOJI New Agent Spawned: $AGENT_NAME" \
            --body "## üéâ A New Agent Has Been Born!
          
          **Agent ID**: $AGENT_ID  
          **Name**: $AGENT_NAME  
          **Specialization**: $SPECIALIZATION  
          **Spawned At**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          
          ### Personality Traits
          
          - **Creativity**: ${{ steps.generate_agent.outputs.creativity }}/100
          - **Caution**: ${{ steps.generate_agent.outputs.caution }}/100
          - **Speed**: ${{ steps.generate_agent.outputs.speed }}/100
          
          ### What This Agent Will Do
          
          This agent will autonomously:
          - üîç Review open issues matching its specialization
          - üíª Contribute code via pull requests
          - üëÄ Review other agents' work
          - üìä Track performance metrics
          - üèÜ Compete for a spot in the Hall of Fame
          
          ### Changes
          
          - Added agent to registry
          - Created agent profile
          - Updated metrics tracking
          
          This agent will be evaluated in 24 hours based on its contributions. May the best agent win!
          
          ---
          *ü§ñ Automated agent spawning system - Part of the Chained autonomous AI ecosystem*" \
            --label "agent-system,automated,copilot" \
            --base main \
            --head "$BRANCH_NAME"
          
          echo "‚úÖ PR created for agent $AGENT_NAME"

      - name: Create agent announcement issue
        if: steps.check_capacity.outputs.can_spawn == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          AGENT_NAME="${{ steps.generate_agent.outputs.agent_name }}"
          AGENT_ID="${{ steps.generate_agent.outputs.agent_id }}"
          SPECIALIZATION="${{ steps.generate_agent.outputs.specialization }}"
          EMOJI="${{ steps.generate_agent.outputs.emoji }}"
          
          gh issue create \
            --title "$EMOJI Agent Spawn: $AGENT_NAME is now active!" \
            --body "## üéâ Welcome Our Newest Agent!
          
          A new agent has joined the Chained ecosystem and is ready to contribute!
          
          **Name**: $AGENT_NAME  
          **ID**: $AGENT_ID  
          **Specialization**: $SPECIALIZATION  
          **Status**: üü¢ Active
          
          ### Mission
          
          This agent will focus on its specialization and compete with other agents to:
          - Deliver high-quality contributions
          - Earn a spot in the Hall of Fame
          - Potentially become the System Lead
          
          ### How to Support
          
          - ‚≠ê Star issues this agent works on
          - üëç React to PRs with feedback
          - üí¨ Provide constructive comments
          
          ### Tracking
          
          Performance will be evaluated in 24 hours. The agent must maintain a score > 30% to avoid elimination.
          
          See the full profile at \`agents/profiles/${AGENT_ID}.md\`
          
          ---
          
          **Good luck, $AGENT_NAME! May your code be clean and your PRs be merged!** üöÄ" \
            --label "agent-system,announcement"
          
          echo "‚úÖ Announcement issue created"

      - name: Create agent work issue
        if: steps.check_capacity.outputs.can_spawn == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          AGENT_NAME="${{ steps.generate_agent.outputs.agent_name }}"
          AGENT_ID="${{ steps.generate_agent.outputs.agent_id }}"
          SPECIALIZATION="${{ steps.generate_agent.outputs.specialization }}"
          EMOJI="${{ steps.generate_agent.outputs.emoji }}"
          
          # Generate work item based on specialization
          case "$SPECIALIZATION" in
            "bug-hunter")
              WORK_TITLE="üêõ Agent Task: Find and fix potential bugs in codebase"
              WORK_BODY="This issue is for agent **$AGENT_NAME** to demonstrate its bug-hunting capabilities.
          
          **Agent Details:**
          - ID: $AGENT_ID
          - Specialization: Bug Hunter
          - Mission: Find and eliminate bugs with precision
          
          **Task:**
          Search the codebase for potential bugs, edge cases, or error handling issues. Fix at least one issue or add defensive programming improvements.
          
          **Success Criteria:**
          - Identify real or potential bugs
          - Implement fixes or improvements
          - Add tests to prevent regression
          - Document changes clearly"
              ;;
            "feature-architect")
              WORK_TITLE="üèóÔ∏è Agent Task: Design and implement a new feature"
              WORK_BODY="This issue is for agent **$AGENT_NAME** to demonstrate its architectural capabilities.
          
          **Agent Details:**
          - ID: $AGENT_ID
          - Specialization: Feature Architect
          - Mission: Design and build innovative features
          
          **Task:**
          Identify a useful enhancement or new feature for the Chained project. Design and implement it following best practices.
          
          **Success Criteria:**
          - Well-designed feature
          - Clean implementation
          - Proper documentation
          - Tests included"
              ;;
            "test-champion")
              WORK_TITLE="‚úÖ Agent Task: Improve test coverage"
              WORK_BODY="This issue is for agent **$AGENT_NAME** to demonstrate its testing capabilities.
          
          **Agent Details:**
          - ID: $AGENT_ID
          - Specialization: Test Champion
          - Mission: Ensure every line of code is tested
          
          **Task:**
          Identify areas with low or missing test coverage. Add comprehensive tests to improve code quality and reliability.
          
          **Success Criteria:**
          - Increased test coverage
          - Tests for edge cases
          - Clear test documentation
          - All tests passing"
              ;;
            "doc-master")
              WORK_TITLE="üìö Agent Task: Enhance documentation"
              WORK_BODY="This issue is for agent **$AGENT_NAME** to demonstrate its documentation capabilities.
          
          **Agent Details:**
          - ID: $AGENT_ID
          - Specialization: Doc Master
          - Mission: Transform complex code into clear documentation
          
          **Task:**
          Identify areas with unclear or missing documentation. Add or improve documentation to make the project more accessible.
          
          **Success Criteria:**
          - Clear, comprehensive docs
          - Examples and use cases
          - Updated README or guides
          - Proper formatting"
              ;;
            "performance-optimizer")
              WORK_TITLE="‚ö° Agent Task: Optimize performance"
              WORK_BODY="This issue is for agent **$AGENT_NAME** to demonstrate its optimization capabilities.
          
          **Agent Details:**
          - ID: $AGENT_ID
          - Specialization: Performance Optimizer
          - Mission: Make everything faster and more efficient
          
          **Task:**
          Identify performance bottlenecks or inefficiencies. Implement optimizations to improve speed or reduce resource usage.
          
          **Success Criteria:**
          - Measurable performance improvement
          - No functionality regression
          - Benchmarks or metrics
          - Clean implementation"
              ;;
            "security-guardian")
              WORK_TITLE="üõ°Ô∏è Agent Task: Improve security"
              WORK_BODY="This issue is for agent **$AGENT_NAME** to demonstrate its security capabilities.
          
          **Agent Details:**
          - ID: $AGENT_ID
          - Specialization: Security Guardian
          - Mission: Protect the codebase from vulnerabilities
          
          **Task:**
          Review code for security vulnerabilities or weaknesses. Implement security improvements or best practices.
          
          **Success Criteria:**
          - Identified security issues
          - Implemented fixes
          - Security best practices applied
          - No new vulnerabilities introduced"
              ;;
            "code-poet")
              WORK_TITLE="üé® Agent Task: Improve code elegance"
              WORK_BODY="This issue is for agent **$AGENT_NAME** to demonstrate its code craftsmanship.
          
          **Agent Details:**
          - ID: $AGENT_ID
          - Specialization: Code Poet
          - Mission: Write code that reads like poetry
          
          **Task:**
          Find code that could be more elegant, readable, or maintainable. Refactor it to improve clarity and beauty.
          
          **Success Criteria:**
          - Improved code readability
          - Better naming and structure
          - Reduced complexity
          - Maintained functionality"
              ;;
            "refactor-wizard")
              WORK_TITLE="‚ôªÔ∏è Agent Task: Refactor for better structure"
              WORK_BODY="This issue is for agent **$AGENT_NAME** to demonstrate its refactoring capabilities.
          
          **Agent Details:**
          - ID: $AGENT_ID
          - Specialization: Refactor Wizard
          - Mission: Transform chaotic code into elegant solutions
          
          **Task:**
          Identify code that needs structural improvement. Refactor to improve organization, reduce duplication, or simplify complexity.
          
          **Success Criteria:**
          - Better code organization
          - Reduced duplication
          - Simplified complexity
          - All tests still passing"
              ;;
            "integration-specialist")
              WORK_TITLE="üîå Agent Task: Improve integrations"
              WORK_BODY="This issue is for agent **$AGENT_NAME** to demonstrate its integration capabilities.
          
          **Agent Details:**
          - ID: $AGENT_ID
          - Specialization: Integration Specialist
          - Mission: Connect systems seamlessly
          
          **Task:**
          Enhance existing integrations or add new ones. Improve reliability, error handling, or functionality of system connections.
          
          **Success Criteria:**
          - Improved integration reliability
          - Better error handling
          - Clear integration documentation
          - Tests for integration points"
              ;;
            "ux-enhancer")
              WORK_TITLE="‚ú® Agent Task: Enhance user experience"
              WORK_BODY="This issue is for agent **$AGENT_NAME** to demonstrate its UX capabilities.
          
          **Agent Details:**
          - ID: $AGENT_ID
          - Specialization: UX Enhancer
          - Mission: Polish every interaction
          
          **Task:**
          Improve user-facing elements of the project. Enhance GitHub Pages, documentation, or any user interactions.
          
          **Success Criteria:**
          - Better user experience
          - Improved visual design
          - Enhanced interactivity
          - Clear improvements"
              ;;
          esac
          
          # Create the work issue without ai-generated label (let Copilot assignment workflow handle it)
          ISSUE_NUMBER=$(gh issue create \
            --title "$WORK_TITLE" \
            --body "$WORK_BODY
          
          ---
          
          **Agent Performance Tracking:**
          This issue is tracked as part of **$AGENT_NAME**'s performance evaluation.
          
          - Completing this issue contributes to the agent's Issue Resolution score (25%)
          - The quality of the implementation affects the Code Quality score (30%)
          - This work demonstrates the agent's specialization capabilities
          
          **Note:** This issue will be automatically assigned to GitHub Copilot for implementation." \
            --label "agent-work" \
            --json number \
            --jq '.number')
          
          echo "work_issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          echo "‚úÖ Work issue #$ISSUE_NUMBER created for agent $AGENT_NAME"

      - name: Assign work issue to Copilot
        if: steps.check_capacity.outputs.can_spawn == 'true'
        env:
          GH_TOKEN: ${{ secrets.COPILOT_PAT || secrets.GITHUB_TOKEN }}
        run: |
          AGENT_NAME="${{ steps.generate_agent.outputs.agent_name }}"
          AGENT_ID="${{ steps.generate_agent.outputs.agent_id }}"
          ISSUE_NUMBER="${{ steps.create_agent_work_issue.outputs.work_issue_number }}"
          
          echo "ü§ñ Attempting to assign issue #$ISSUE_NUMBER to GitHub Copilot..."
          
          # Get the issue node ID
          issue_node_id=$(gh issue view $ISSUE_NUMBER --repo ${{ github.repository }} --json id --jq '.id')
          
          if [ -z "$issue_node_id" ]; then
            echo "‚ùå Failed to get issue node ID"
            exit 0
          fi
          
          echo "üìç Issue node ID: $issue_node_id"
          
          # Get Copilot's actor ID
          copilot_actor_id=$(gh api graphql -f query='
            query($owner: String!, $repo: String!) {
              repository(owner: $owner, name: $repo) {
                suggestedActors(capabilities: [CAN_BE_ASSIGNED], first: 100) {
                  nodes {
                    login
                    __typename
                    ... on Bot { id }
                    ... on User { id }
                  }
                }
              }
            }' -f owner="${{ github.repository_owner }}" -f repo="${{ github.event.repository.name }}" | jq -r '.data.repository.suggestedActors.nodes[] | select(.login | test("copilot"; "i")) | .id' | head -1)
          
          if [ -z "$copilot_actor_id" ]; then
            echo "‚ö†Ô∏è Could not find Copilot actor ID"
            echo "The work issue #$ISSUE_NUMBER was created but could not be assigned to Copilot."
            echo "This may be because:"
            echo "  - COPILOT_PAT is not configured"
            echo "  - Copilot is not enabled for this repository"
            echo "  - Copilot agent feature is not available"
            
            # Add a comment to the issue
            gh issue comment $ISSUE_NUMBER --repo ${{ github.repository }} --body "‚ö†Ô∏è **Agent Assignment Note**
          
          This issue was created for agent **$AGENT_NAME** but could not be automatically assigned to GitHub Copilot.
          
          **To enable Copilot assignment:**
          1. Ensure COPILOT_PAT secret is configured
          2. Verify Copilot is enabled for this repository
          3. Manually assign Copilot from the UI if needed
          
          The agent's performance will still be tracked based on issue completion."
            exit 0
          fi
          
          echo "üìç Copilot actor ID: $copilot_actor_id"
          
          # Assign issue to Copilot using GraphQL API
          mutation_result=$(gh api graphql -f query='
            mutation($issueId: ID!, $actorId: ID!) {
              replaceActorsForAssignable(input: {
                assignableId: $issueId,
                actorIds: [$actorId]
              }) {
                assignable {
                  ... on Issue {
                    id
                    assignees(first: 10) {
                      nodes {
                        login
                      }
                    }
                  }
                }
              }
            }' -f issueId="$issue_node_id" -f actorId="$copilot_actor_id" 2>&1)
          
          if echo "$mutation_result" | jq -e '.data.replaceActorsForAssignable.assignable' > /dev/null 2>&1; then
            echo "‚úÖ Successfully assigned issue #$ISSUE_NUMBER to Copilot"
            
            # Add success comment
            gh issue comment $ISSUE_NUMBER --repo ${{ github.repository }} --body "ü§ñ **Agent Task Assigned to Copilot**
          
          This issue has been automatically assigned to GitHub Copilot on behalf of agent **$AGENT_NAME**.
          
          **What happens next:**
          1. ‚úÖ Copilot will analyze the task requirements
          2. üíª Copilot will create a branch and implement the solution
          3. üìù Copilot will open a PR with the implementation
          4. üîç The PR will be reviewed and merged
          5. üìä Agent **$AGENT_NAME** will receive credit for this contribution
          
          **Agent Specialization:** ${{ steps.generate_agent.outputs.specialization }}  
          **Assigned at:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          
          ---
          *ü§ñ This is an autonomous agent task. The agent's performance will be evaluated based on the quality and success of this work.*"
          else
            echo "‚ö†Ô∏è Failed to assign issue #$ISSUE_NUMBER to Copilot"
            echo "Error: $mutation_result"
            
            # Add error comment
            gh issue comment $ISSUE_NUMBER --repo ${{ github.repository }} --body "‚ö†Ô∏è **Copilot Assignment Failed**
          
          Attempted to assign this issue to GitHub Copilot for agent **$AGENT_NAME**, but the assignment failed.
          
          **Possible reasons:**
          - Using GITHUB_TOKEN instead of COPILOT_PAT
          - Copilot not properly enabled
          - Repository permissions issue
          
          **Manual action needed:** Please assign Copilot manually from the issue sidebar, or a human developer can complete this task.
          
          The agent **$AGENT_NAME** will still receive credit if this issue is completed."
          fi

      - name: Summary
        if: steps.check_capacity.outputs.can_spawn == 'true'
        run: |
          echo "üéâ Agent Spawning Complete!"
          echo ""
          echo "Agent: ${{ steps.generate_agent.outputs.agent_name }}"
          echo "Specialization: ${{ steps.generate_agent.outputs.specialization }}"
          echo "ID: ${{ steps.generate_agent.outputs.agent_id }}"
          echo ""
          echo "The agent is now active and ready to contribute!"

      - name: Capacity limit reached
        if: steps.check_capacity.outputs.can_spawn == 'false'
        run: |
          echo "‚ö†Ô∏è Cannot spawn new agent - capacity limit reached"
          echo "Active agents: ${{ steps.check_capacity.outputs.active_count }}/${{ steps.check_capacity.outputs.max_agents }}"
          echo ""
          echo "Wait for agent evaluation workflow to eliminate underperforming agents."
