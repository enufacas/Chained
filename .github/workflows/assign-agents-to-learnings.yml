name: "Agent Assignment: Match Agents to Learnings"

on:
  schedule:
    # Run daily at 09:00 UTC
    - cron: '0 9 * * *'
  workflow_dispatch:
    inputs:
      agent_filter:
        description: 'Filter agents (all, unassigned, or specific agent ID)'
        required: false
        default: 'unassigned'
        type: string
      max_assignments:
        description: 'Maximum number of assignments to create'
        required: false
        default: '5'
        type: string

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  assign-agents:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          # No additional dependencies needed for our modules
      
      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Find agents and match to learnings
        id: match
        continue-on-error: true
        env:
          AGENT_FILTER: ${{ inputs.agent_filter || 'unassigned' }}
          MAX_ASSIGNMENTS: ${{ inputs.max_assignments || '5' }}
        run: |
          python3 << 'PYEOF'
          import json
          import os
          import sys
          from datetime import datetime
          
          # Add tools directory to path
          sys.path.insert(0, 'tools')
          sys.path.insert(0, 'world')
          
          try:
              from registry_manager import RegistryManager
              from agent_learning_matcher import AgentLearningMatcher
              from agent_investment_tracker import AgentInvestmentTracker
              
              print("=" * 70)
              print("ü§ñ Agent-to-Learning Assignment System")
              print("=" * 70)
              print()
              
              # Initialize systems
              print("üì¶ Initializing systems...")
              registry = RegistryManager()
              matcher = AgentLearningMatcher()
              tracker = AgentInvestmentTracker()
              print("‚úÖ Systems initialized")
              print()
              
              # Get configuration
              agent_filter = os.getenv('AGENT_FILTER', 'unassigned')
              max_assignments = int(os.getenv('MAX_ASSIGNMENTS', '5'))
              
              print(f"‚öôÔ∏è  Configuration:")
              print(f"   - Agent filter: {agent_filter}")
              print(f"   - Max assignments: {max_assignments}")
              print()
              
              # Get all agents
              all_agents = registry.list_agents()
              print(f"üìä Found {len(all_agents)} total agents")
              
              # Filter agents based on criteria
              target_agents = []
              if agent_filter == 'all':
                  target_agents = all_agents
              elif agent_filter == 'unassigned':
                  # Get agents with no issues resolved
                  for agent in all_agents:
                      issues_resolved = agent.get('metrics', {}).get('issues_resolved', 0)
                      if issues_resolved == 0:
                          target_agents.append(agent)
                  print(f"üéØ Found {len(target_agents)} agents with no work assigned")
              else:
                  # Specific agent ID
                  for agent in all_agents:
                      if agent.get('id') == agent_filter:
                          target_agents = [agent]
                          break
                  print(f"üéØ Targeting specific agent: {agent_filter}")
              
              if not target_agents:
                  print("‚ö†Ô∏è  No agents match the filter criteria")
                  sys.exit(0)
              
              print()
              
              # Load recent learnings with randomization for variety
              from pathlib import Path
              import glob
              import random
              
              learnings = []
              learnings_dir = Path('learnings')
              
              # Load from JSON learning files
              if learnings_dir.exists():
                  learning_files = list(learnings_dir.glob('*.json'))
                  if not learning_files:
                      print("‚ö†Ô∏è  No JSON learning files found in learnings/ directory")
                  
                  # Sort by modification time (newest first) but add some randomness
                  learning_files_with_time = [(f, f.stat().st_mtime) for f in learning_files]
                  learning_files_with_time.sort(key=lambda x: x[1], reverse=True)
                  
                  # Take top 30 recent files (increased from 20 for more variety)
                  recent_files = [f for f, _ in learning_files_with_time[:30]]
                  
                  # Shuffle the recent files to add randomness
                  # This ensures we don't always process the same files in the same order
                  random.shuffle(recent_files)
                  
                  # Process files
                  for learning_file in recent_files[:20]:  # Still limit to 20 for performance
                      try:
                          with open(learning_file) as f:
                              data = json.load(f)
                              # Handle different learning file formats
                              if isinstance(data, list):
                                  # Instead of always taking first 5, randomly sample
                                  sample_size = min(5, len(data))
                                  if len(data) > sample_size:
                                      learnings.extend(random.sample(data, sample_size))
                                  else:
                                      learnings.extend(data)
                              elif isinstance(data, dict) and 'items' in data:
                                  items = data['items']
                                  sample_size = min(5, len(items))
                                  if len(items) > sample_size:
                                      learnings.extend(random.sample(items, sample_size))
                                  else:
                                      learnings.extend(items)
                              elif isinstance(data, dict):
                                  learnings.append(data)
                      except Exception as e:
                          print(f"‚ö†Ô∏è  Error loading {learning_file.name}: {e}")
              else:
                  print("‚ö†Ô∏è  Learnings directory does not exist, skipping learning files")
              
              # Shuffle the final learning list for maximum randomness
              # This ensures variety across different workflow runs
              random.shuffle(learnings)
              
              print(f"üìö Loaded {len(learnings)} learnings (with randomization)")
              print()
              
              # Use the new diverse assignment method
              print("üéØ Assigning learnings to agents with diversity constraints...")
              print()
              
              # Get list of agent IDs from target_agents
              agent_ids = [agent.get('id') for agent in target_agents]
              agent_names_map = {agent.get('id'): agent.get('name', agent.get('id')) for agent in target_agents}
              
              # Use the improved diverse assignment algorithm
              # This ensures different agents get assigned, not all to one agent
              assignments = matcher.assign_learnings_to_agents_diverse(
                  learnings=learnings,
                  agent_names=agent_ids,
                  max_assignments=max_assignments,
                  min_score=0.1,  # Lower threshold to be more liberal
                  diversity_weight=0.7  # Strong diversity preference
              )
              
              print(f"‚úÖ Created {len(assignments)} diverse assignments")
              
              # Print summary of assignments
              if assignments:
                  print()
                  print("üìä Assignment Summary:")
                  agent_counts = {}
                  for assignment in assignments:
                      agent_id = assignment['agent_id']
                      agent_name = agent_names_map.get(agent_id, agent_id)
                      learning_title = assignment['learning'].get('title', 'Untitled')[:50]
                      score = assignment['score']
                      categories = ', '.join(assignment['categories'][:2])
                      rank = assignment.get('assignment_rank', '?')
                      
                      agent_counts[agent_id] = agent_counts.get(agent_id, 0) + 1
                      
                      print(f"   üìå @{agent_id} (#{rank}) - {learning_title}...")
                      print(f"      Score: {score:.3f}, Categories: {categories}")
                  
                  print()
                  print("üìà Agent Distribution:")
                  for agent_id, count in sorted(agent_counts.items(), key=lambda x: x[1], reverse=True):
                      print(f"   ‚Ä¢ @{agent_id}: {count} assignment(s)")
              
              print()
              
              # Save assignments to file for next step
              output_file = '/tmp/agent_assignments.json'
              with open(output_file, 'w') as f:
                  json.dump(assignments, f, indent=2)
              
              # Set output
              print(f"assignments_count={len(assignments)}", file=sys.stderr)
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write(f"assignments_count={len(assignments)}\n")
                  f.write(f"has_assignments={'true' if assignments else 'false'}\n")
              
          except Exception as e:
              print(f"‚ùå Error: {e}")
              import traceback
              traceback.print_exc()
              sys.exit(1)
          PYEOF
      
      - name: Create GitHub issues for assignments
        if: steps.match.outputs.has_assignments == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 << 'PYEOF'
          import json
          import os
          import sys
          import subprocess
          
          # Add world directory to path
          sys.path.insert(0, 'world')
          
          try:
              from agent_investment_tracker import AgentInvestmentTracker
              
              # Load assignments
              with open('/tmp/agent_assignments.json') as f:
                  assignments = json.load(f)
              
              print("=" * 70)
              print("üìù Creating GitHub Issues for Assignments")
              print("=" * 70)
              print()
              
              # Initialize investment tracker
              tracker = AgentInvestmentTracker()
              
              created_issues = []
              
              for assignment in assignments:
                  agent_id = assignment['agent_id']
                  agent_name = assignment['agent_name']
                  learning = assignment['learning']
                  score = assignment['score']
                  categories = assignment['categories']
                  
                  # Build issue title
                  title = f"üéì Learning Task: {learning.get('title', 'Untitled')[:80]}"
                  
                  # Build issue body
                  primary_category = categories[0] if categories else "General"
                  learning_url = learning.get('url', learning.get('link', ''))
                  learning_source = learning.get('source', 'unknown')
                  
                  body = (
                      f"## üéì Learning Assignment for @{agent_id}\n\n"
                      f"**Agent:** {agent_name}\n"
                      f"**Match Score:** {score:.2f}\n"
                      f"**Primary Category:** {primary_category}\n"
                      f"**All Categories:** {', '.join(categories)}\n\n"
                      f"### üìö Learning Content\n\n"
                      f"**Title:** {learning.get('title', 'Untitled')}\n\n"
                      f"**Description:**\n"
                      f"{learning.get('description', learning.get('content', 'No description available')[:500])}\n\n"
                      f"**Source:** {learning_source}\n"
                      f"{f'**URL:** {learning_url}' if learning_url else ''}\n\n"
                      f"### üéØ Your Mission\n\n"
                      f"As **@{agent_id}**, you've been matched with this learning opportunity based on your specialization in **{primary_category}**.\n\n"
                      f"**What to do:**\n"
                      f"1. üìñ Review the learning content carefully\n"
                      f"2. üîç Identify how this relates to your specialization\n"
                      f"3. üí° Propose an implementation, experiment, or analysis based on this learning\n"
                      f"4. üìù Create a detailed plan in the comments\n"
                      f"5. üöÄ Implement your proposal (if approved)\n\n"
                      f"### üìä Investment Tracking\n\n"
                      f"This assignment will be tracked in the **Agent Investment Tracker** system:\n"
                      f"- Category: `{primary_category}`\n"
                      f"- Initial investment level: `CURIOUS`\n"
                      f"- This is an opportunity to grow your expertise!\n\n"
                      f"### ü§ù Collaboration\n\n"
                      f"Feel free to request collaboration from other agents if this learning touches multiple specializations. Use the **Agent Collaboration Manager** to find helpers.\n\n"
                      f"---\n\n"
                      f"*ü§ñ Automated assignment via Agent-Learning Matcher*\n"
                      f"*Generated: {json.dumps(learning.get('date', 'unknown'))}*\n"
                  )
                  
                  print(f"Creating issue for {agent_name}...")
                  
                  # Create the issue using gh CLI
                  result = subprocess.run(
                      [
                          'gh', 'issue', 'create',
                          '--title', title,
                          '--body', body,
                          '--label', f'agent:{agent_id}',
                          '--label', 'learning-assignment',
                          '--label', 'automated',
                          '--label', f'category:{primary_category.lower()}'
                      ],
                      capture_output=True,
                      text=True
                  )
                  
                  if result.returncode == 0:
                      issue_url = result.stdout.strip()
                      print(f"   ‚úÖ Created: {issue_url}")
                      created_issues.append({
                          'agent_id': agent_id,
                          'issue_url': issue_url,
                          'category': primary_category
                      })
                      
                      # Record initial cultivation in investment tracker
                      tracker.record_cultivation(
                          agent_name=agent_id,
                          category=primary_category,
                          impact=0.3,  # Initial curiosity impact
                          learning_id=learning.get('id', learning.get('title', 'unknown')),
                          context=f"Assigned learning task via matcher (score: {score:.2f})"
                      )
                      print(f"   üìä Recorded cultivation event in tracker")
                  else:
                      print(f"   ‚ùå Failed to create issue: {result.stderr}")
              
              # Save tracker updates
              if created_issues:
                  tracker.save()
                  print()
                  print(f"‚úÖ Created {len(created_issues)} issues and updated investment tracker")
              
              # Save created issues for PR body
              with open('/tmp/created_issues.json', 'w') as f:
                  json.dump(created_issues, f, indent=2)
              
          except Exception as e:
              print(f"‚ùå Error creating issues: {e}")
              import traceback
              traceback.print_exc()
              sys.exit(1)
          PYEOF
      
      - name: Commit investment tracker updates
        if: steps.match.outputs.has_assignments == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git add world/agent_investments.json
          
          if git diff --staged --quiet; then
            echo "No investment tracker changes to commit"
          else
            # Create unique branch name
            TIMESTAMP=$(date +%Y%m%d-%H%M%S)
            BRANCH_NAME="agent-assignments/${TIMESTAMP}-${{ github.run_id }}"
            git checkout -b "$BRANCH_NAME"
            
            # Commit changes
            git commit -m "üìä Update agent investments from learning assignments

            - Recorded cultivation events for assigned agents
            - Updated investment tracker with learning categories
            - Automated via assign-agents-to-learnings workflow"
            
            # Push branch
            git push origin "$BRANCH_NAME"
            
            # Build PR body with created issues
            python3 << 'PYEOF'
          import json
          import os
          
          try:
              with open('/tmp/created_issues.json') as f:
                  issues = json.load(f)
              
              pr_body = (
                  "## üìä Agent Investment Tracker Update\n\n"
                  "This PR updates the agent investment tracker with cultivation events from learning assignments.\n\n"
                  "### üéì Learning Assignments Created\n\n"
              )
              
              for issue_info in issues:
                  pr_body += f"- **@{issue_info['agent_id']}**: [{issue_info['category']}]({issue_info['issue_url']})\n"
              
              pr_body += (
                  "\n### üìà Investment Updates\n\n"
                  "- Initial cultivation events recorded\n"
                  "- Investment levels initialized to `CURIOUS`\n"
                  "- Categories tracked for future growth\n\n"
                  "---\n\n"
                  "*ü§ñ Automated workflow: assign-agents-to-learnings*\n"
              )
              
              # Save for next step
              with open('/tmp/pr_body.txt', 'w') as f:
                  f.write(pr_body)
                  
          except Exception as e:
              print(f"Warning: Could not build PR body: {e}")
              # Create default body
              with open('/tmp/pr_body.txt', 'w') as f:
                  f.write("Agent investment tracker update from learning assignments")
          PYEOF
            
            # Create PR
            PR_DATE=$(date +%Y-%m-%d)
            gh pr create \
              --title "üìä Agent investments: Learning assignments - ${PR_DATE}" \
              --body-file /tmp/pr_body.txt \
              --label "agent-system,automated,investment-tracker,copilot" \
              --base main \
              --head "$BRANCH_NAME"
            
            echo "‚úÖ PR created for investment tracker updates"
          fi
      
      - name: Summary
        if: always()
        run: |
          echo "======================================================================"
          echo "üìä Assignment Summary"
          echo "======================================================================"
          
          if [ -f /tmp/agent_assignments.json ]; then
            python3 << 'PYEOF'
            import json
            assignments_count = len(json.load(open('/tmp/agent_assignments.json')))
            print(f"‚úÖ Matched {assignments_count} agents to learnings")
            PYEOF
          fi
          
          if [ -f /tmp/created_issues.json ]; then
            python3 << 'PYEOF'
            import json
            issues = json.load(open('/tmp/created_issues.json'))
            print(f"‚úÖ Created {len(issues)} GitHub issues")
            for issue in issues:
                print(f"   - @{issue['agent_id']}: {issue['issue_url']}")
            PYEOF
          fi
