name: "Agent System: Evaluator"

on:
  schedule:
    # Run daily at midnight UTC
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      force_evaluation:
        description: 'Force evaluation even if already run today'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  evaluate-agents:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Ensure agent system labels exist
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üè∑Ô∏è Checking agent system labels..."
          
          # Function to create label if it doesn't exist
          create_label_if_missing() {
            local name="$1"
            local color="$2"
            local description="$3"
            
            if gh label list --repo ${{ github.repository }} | grep -q "^${name}"; then
              echo "‚úì Label '$name' already exists"
            else
              gh label create "$name" --color "$color" --description "$description" --repo ${{ github.repository }} 2>/dev/null || echo "‚ö†Ô∏è Could not create label '$name'"
            fi
          }
          
          # Create evaluation-specific labels
          create_label_if_missing "agent-system" "7057ff" "Agent ecosystem activity"
          create_label_if_missing "evaluation" "e4e669" "Agent evaluations"
          create_label_if_missing "automated" "ededed" "Auto-generated content"
          create_label_if_missing "copilot" "8b5cf6" "Copilot-related tasks"

      - name: Evaluate all agents
        id: evaluate
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Run the elegant evaluation engine
          python3 tools/agent_evaluator.py
          
          # Check if there are results to process
          if [ -f "/tmp/evaluation_results.json" ]; then
            echo "has_results=true" >> $GITHUB_OUTPUT
          else
            echo "has_results=false" >> $GITHUB_OUTPUT
          fi

      - name: Update agent profiles
        if: steps.evaluate.outputs.has_results == 'true'
        run: |
          # Use the elegant profile manager
          python3 tools/profile_manager.py

      - name: Archive eliminated agents
        if: steps.evaluate.outputs.has_results == 'true'
        run: |
          # The profile manager handles archival too
          # Already called in previous step
          echo "‚úÖ Archival handled by profile manager"

      - name: Commit changes
        if: steps.evaluate.outputs.has_results == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH_NAME="agent-evaluation/$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH_NAME"
          
          git add .github/agent-system/
          git commit -m "üîÑ Daily agent evaluation and governance"
          git push origin "$BRANCH_NAME"
          
          # Generate elegant PR body
          PR_BODY=$(python3 tools/pr_body_generator.py)
          
          # Create PR
          gh pr create \
            --title "üèõÔ∏è Daily Agent Evaluation - $(date +%Y-%m-%d)" \
            --body "$PR_BODY" \
            --label "agent-system,evaluation,automated,copilot" \
            --base main \
            --head "$BRANCH_NAME"
          
          echo "‚úÖ Evaluation PR created"

      - name: Create evaluation report issue
        if: steps.evaluate.outputs.has_results == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Use the elegant report generator
          python3 tools/report_generator.py

      - name: Summary
        run: |
          echo "üèõÔ∏è Agent Evaluation Complete!"
          echo ""
          if [ -f "/tmp/evaluation_results.json" ]; then
            python3 << 'EOF'
          import json
          from pathlib import Path
          
          results_path = Path('/tmp/evaluation_results.json')
          with open(results_path, 'r') as f:
              results = json.load(f)
          
          print(f"Promoted: {len(results.get('promoted', []))}")
          print(f"Eliminated: {len(results.get('eliminated', []))}")
          print(f"Maintained: {len(results.get('maintained', []))}")
          EOF
          else
            echo "No agents to evaluate"
          fi
