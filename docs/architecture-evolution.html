<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Architecture Evolution - Chained</title>
    <link rel="stylesheet" href="style.css">
    <!-- Load D3.js with fallback -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js" 
            integrity="sha512-M7nHCiNUOwFt6Us3r8alutZLm9qMt4s9951uo8jqO4UwJ1hziseL6O3ndFyigx6+LREfZqnhHxYjKRJ8ZQ69DQ==" 
            crossorigin="anonymous" 
            referrerpolicy="no-referrer"
            onerror="this.onerror=null; this.src='https://unpkg.com/d3@7.8.5/dist/d3.min.js';"></script>
    <!-- Load Mermaid with fallback -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.6.1/mermaid.min.js" 
            integrity="sha512-TvbUcy5r/y8QnEknWKP5w7RlEPBZGr7zFLusH3QqfKJwK3R+DXcced3AJ8s6PcQ+WVMr7HWXwKKPGKbR0sLxIw==" 
            crossorigin="anonymous" 
            referrerpolicy="no-referrer"
            onerror="this.onerror=null; this.src='https://unpkg.com/mermaid@10.6.1/dist/mermaid.min.js';"></script>
    <style>
        .evolution-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--primary, #00d4ff), var(--secondary, #ff00ff));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .metric-card {
            background: var(--bg-secondary, #1a1a2e);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--primary, #00d4ff);
            transition: transform 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-5px);
        }

        .metric-card h3 {
            margin: 0 0 10px 0;
            color: var(--primary, #00d4ff);
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: var(--text-primary, #e0e0e0);
        }

        .metric-change {
            font-size: 0.9em;
            margin-top: 5px;
        }

        .metric-change.positive {
            color: #4caf50;
        }

        .metric-change.negative {
            color: #f44336;
        }

        .chart-container {
            background: var(--bg-secondary, #1a1a2e);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 40px;
            border: 1px solid var(--primary, #00d4ff);
        }

        .chart-title {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: var(--primary, #00d4ff);
        }

        #timeline-chart {
            width: 100%;
            height: 400px;
        }

        #component-chart {
            width: 100%;
            height: 500px;
        }

        .timeline-tooltip {
            position: absolute;
            background: var(--bg-primary, #0f0f1e);
            border: 1px solid var(--primary, #00d4ff);
            border-radius: 8px;
            padding: 15px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
            max-width: 400px;
        }

        .timeline-tooltip h4 {
            margin: 0 0 10px 0;
            color: var(--primary, #00d4ff);
        }

        .timeline-tooltip p {
            margin: 5px 0;
            font-size: 0.9em;
            color: var(--text-secondary, #b0b0b0);
        }

        .axis {
            color: var(--text-secondary, #b0b0b0);
        }

        .axis line,
        .axis path {
            stroke: var(--text-muted, #666);
        }

        .axis text {
            fill: var(--text-secondary, #b0b0b0);
        }

        .line {
            fill: none;
            stroke-width: 2.5px;
            opacity: 0.8;
        }

        .dot {
            cursor: pointer;
            transition: r 0.2s ease;
        }

        .dot:hover {
            r: 6;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .legend-color {
            width: 30px;
            height: 3px;
            border-radius: 2px;
        }

        .mermaid-container {
            background: var(--bg-secondary, #1a1a2e);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 40px;
            border: 1px solid var(--primary, #00d4ff);
            overflow-x: auto;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: var(--text-secondary, #b0b0b0);
        }

        .error {
            text-align: center;
            padding: 60px;
            color: #f44336;
        }

        .tab-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--primary, #00d4ff);
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background: transparent;
            border: none;
            color: var(--text-secondary, #b0b0b0);
            font-size: 1em;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }

        .tab:hover {
            color: var(--primary, #00d4ff);
        }

        .tab.active {
            color: var(--primary, #00d4ff);
            border-bottom-color: var(--primary, #00d4ff);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="evolution-container">
        <div class="header">
            <h1>üèóÔ∏è Architecture Evolution</h1>
            <p>Tracking the self-evolving structure of the Chained ecosystem</p>
        </div>

        <div id="loading" class="loading">
            <p>Loading architecture data...</p>
        </div>

        <div id="error" class="error" style="display: none;">
            <p>Failed to load architecture data. Please run the architecture tracker first.</p>
            <p style="font-size: 0.9em; margin-top: 20px;">
                <strong>Troubleshooting:</strong><br>
                ‚Ä¢ Check your browser console for specific errors<br>
                ‚Ä¢ Try disabling your ad blocker<br>
                ‚Ä¢ Make sure JavaScript is enabled<br>
                ‚Ä¢ <a href="architecture-evolution-debug.html" style="color: #00d4ff;">Run Diagnostic Page</a>
            </p>
        </div>

        <div id="content" style="display: none;">
            <!-- Current Metrics -->
            <div class="metrics-grid" id="metrics-grid"></div>

            <!-- Tab Navigation -->
            <div class="tab-container">
                <button class="tab active" onclick="switchTab('timeline')">üìà Evolution Timeline</button>
                <button class="tab" onclick="switchTab('components')">üß© Components</button>
                <button class="tab" onclick="switchTab('diagram')">üé® Architecture Diagram</button>
            </div>

            <!-- Timeline Tab -->
            <div id="timeline-tab" class="tab-content active">
                <div class="chart-container">
                    <h2 class="chart-title">Metrics Over Time</h2>
                    <div id="timeline-chart"></div>
                    <div class="legend" id="timeline-legend"></div>
                </div>
            </div>

            <!-- Components Tab -->
            <div id="components-tab" class="tab-content">
                <div class="chart-container">
                    <h2 class="chart-title">Component Distribution</h2>
                    <div id="component-chart"></div>
                </div>
            </div>

            <!-- Diagram Tab -->
            <div id="diagram-tab" class="tab-content">
                <div class="mermaid-container">
                    <h2 class="chart-title">Current Architecture</h2>
                    <div class="mermaid" id="architecture-diagram">
                        graph TD
                            loading[Loading...]
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="timeline-tooltip" id="tooltip"></div>
    
    <!-- Debug info -->
    <div style="text-align: center; padding: 20px; color: var(--text-muted, #666); font-size: 0.8em;">
        <p>Architecture Evolution Visualization v1.1 | 
        <a href="architecture-evolution-debug.html" style="color: var(--primary, #00d4ff);">Debug Mode</a> | 
        Page loaded: <span id="load-time"></span></p>
    </div>

    <script>
        // Set load time
        document.getElementById('load-time').textContent = new Date().toLocaleString();
    </script>

    <script>
        // Check if required libraries are loaded
        function checkLibraries() {
            const errors = [];
            
            if (typeof d3 === 'undefined') {
                console.error('D3.js failed to load');
                errors.push('D3.js library');
            } else {
                console.log('D3.js loaded successfully, version:', d3.version);
            }
            
            if (typeof mermaid === 'undefined') {
                console.error('Mermaid failed to load');
                errors.push('Mermaid library');
            } else {
                console.log('Mermaid loaded successfully');
            }
            
            if (errors.length > 0) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').innerHTML = `
                    <p><strong>Failed to load required libraries:</strong> ${errors.join(', ')}</p>
                    <p style="font-size: 0.9em; margin-top: 20px;">
                        <strong>Possible causes:</strong><br>
                        ‚Ä¢ Ad blocker blocking CDN resources<br>
                        ‚Ä¢ Corporate firewall blocking external scripts<br>
                        ‚Ä¢ Network connectivity issues<br>
                        ‚Ä¢ Browser security settings<br><br>
                        <strong>Solutions:</strong><br>
                        ‚Ä¢ Try disabling your ad blocker for this site<br>
                        ‚Ä¢ Check browser console (F12) for specific errors<br>
                        ‚Ä¢ <a href="architecture-evolution-debug.html" style="color: #00d4ff; text-decoration: underline;">Run Diagnostic Page</a>
                    </p>
                `;
                return false;
            }
            
            return true;
        }

        // Initialize Mermaid when loaded
        function initializeMermaid() {
            if (typeof mermaid !== 'undefined') {
                mermaid.initialize({ 
                    startOnLoad: true,
                    theme: 'dark',
                    themeVariables: {
                        primaryColor: '#00d4ff',
                        primaryTextColor: '#e0e0e0',
                        primaryBorderColor: '#00d4ff',
                        lineColor: '#666',
                        secondaryColor: '#1a1a2e',
                        tertiaryColor: '#0f0f1e'
                    }
                });
            }
        }

        let evolutionData = null;
        let latestData = null;

        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(`${tabName}-tab`).classList.add('active');
            event.target.classList.add('active');
        }

        // Load data
        async function loadData() {
            console.log('=== Architecture Evolution Page Loading ===');
            console.log('1. Checking libraries...');
            
            // Check if libraries are loaded
            if (!checkLibraries()) {
                console.error('Library check failed, aborting');
                return;
            }

            console.log('2. Libraries OK, initializing Mermaid...');
            // Initialize Mermaid after confirming it's loaded
            initializeMermaid();

            try {
                console.log('3. Fetching evolution.json...');
                // Load evolution history
                const evolutionResponse = await fetch('data/architecture/evolution.json');
                if (!evolutionResponse.ok) {
                    throw new Error(`Evolution data not found (HTTP ${evolutionResponse.status})`);
                }
                evolutionData = await evolutionResponse.json();
                console.log(`   ‚úì Loaded ${evolutionData.snapshots?.length || 0} snapshots`);

                console.log('4. Fetching latest.json...');
                // Load latest snapshot
                const latestResponse = await fetch('data/architecture/latest.json');
                if (!latestResponse.ok) {
                    throw new Error(`Latest snapshot not found (HTTP ${latestResponse.status})`);
                }
                latestData = await latestResponse.json();
                console.log(`   ‚úì Loaded latest data with ${Object.keys(latestData.components || {}).length} components`);

                console.log('5. Hiding loading, showing content...');
                // Hide loading, show content
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';

                console.log('6. Rendering visualizations...');
                // Render visualizations
                renderMetrics();
                console.log('   ‚úì Metrics rendered');
                
                renderTimeline();
                console.log('   ‚úì Timeline rendered');
                
                renderComponents();
                console.log('   ‚úì Components rendered');
                
                renderDiagram();
                console.log('   ‚úì Diagram rendered');
                
                console.log('=== Page loaded successfully ===');

            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                
                let errorMsg = '<p><strong>Failed to load architecture data.</strong></p>';
                errorMsg += `<p style="font-size: 0.9em;">Error: ${error.message}</p>`;
                errorMsg += '<p style="font-size: 0.9em; margin-top: 20px;">';
                errorMsg += '<strong>Possible causes:</strong><br>';
                errorMsg += '‚Ä¢ Data files not found (run tools/architecture-tracker.py)<br>';
                errorMsg += '‚Ä¢ Network error fetching data files<br>';
                errorMsg += '‚Ä¢ Invalid JSON in data files<br>';
                errorMsg += '‚Ä¢ GitHub Pages not deployed correctly<br><br>';
                errorMsg += '<strong>Next steps:</strong><br>';
                errorMsg += '‚Ä¢ Check browser console (F12) for details<br>';
                errorMsg += '‚Ä¢ Verify data files exist in docs/data/architecture/<br>';
                errorMsg += '‚Ä¢ <a href="architecture-evolution-debug.html" style="color: #00d4ff; text-decoration: underline;">Run Diagnostic Page</a>';
                errorMsg += '</p>';
                
                document.getElementById('error').innerHTML = errorMsg;
            }
        }

        // Render current metrics
        function renderMetrics() {
            const metrics = latestData.metrics;
            const snapshots = evolutionData.snapshots || [];
            const previousMetrics = snapshots.length > 1 ? snapshots[snapshots.length - 2].metrics : null;

            const metricsToShow = [
                { key: 'total_files', label: 'Total Files', icon: 'üìÑ' },
                { key: 'total_lines', label: 'Total Lines', icon: 'üìù', format: (v) => v.toLocaleString() },
                { key: 'total_components', label: 'Components', icon: 'üß©' },
                { key: 'total_dependencies', label: 'Dependencies', icon: 'üîó' },
                { key: 'coupling_score', label: 'Coupling', icon: '‚ö°', format: (v) => v.toFixed(2) },
                { key: 'complexity_score', label: 'Complexity', icon: 'üìä', format: (v) => v.toFixed(2) }
            ];

            const grid = document.getElementById('metrics-grid');
            grid.innerHTML = '';

            metricsToShow.forEach(metric => {
                const value = metrics[metric.key] || 0;
                const prevValue = previousMetrics ? (previousMetrics[metric.key] || 0) : null;
                const change = prevValue !== null ? value - prevValue : null;

                const card = document.createElement('div');
                card.className = 'metric-card';
                
                let changeHtml = '';
                if (change !== null && change !== 0) {
                    const changeClass = change > 0 ? 'positive' : 'negative';
                    const changeSign = change > 0 ? '+' : '';
                    changeHtml = `<div class="metric-change ${changeClass}">${changeSign}${change}</div>`;
                }

                const displayValue = metric.format ? metric.format(value) : value;

                card.innerHTML = `
                    <h3>${metric.icon} ${metric.label}</h3>
                    <div class="metric-value">${displayValue}</div>
                    ${changeHtml}
                `;
                
                grid.appendChild(card);
            });
        }

        // Render timeline chart
        function renderTimeline() {
            const snapshots = evolutionData.snapshots || [];
            if (snapshots.length === 0) return;

            const container = document.getElementById('timeline-chart');
            const margin = { top: 20, right: 80, bottom: 60, left: 60 };
            const width = container.clientWidth - margin.left - margin.right;
            const height = 400 - margin.top - margin.bottom;

            // Clear previous chart
            d3.select(container).selectAll('*').remove();

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            // Parse timestamps
            const data = snapshots.map(d => ({
                ...d,
                date: new Date(d.timestamp)
            }));

            // Scales
            const x = d3.scaleTime()
                .domain(d3.extent(data, d => d.date))
                .range([0, width]);

            const metrics = [
                { key: 'total_files', color: '#00d4ff', label: 'Files' },
                { key: 'total_lines', color: '#ff00ff', label: 'Lines (√∑100)' },
                { key: 'total_components', color: '#00ff00', label: 'Components (√ó10)' }
            ];

            // Normalize different scales
            const normalizedData = data.map(d => ({
                ...d,
                metrics: {
                    total_files: d.metrics.total_files || 0,
                    total_lines: (d.metrics.total_lines || 0) / 100,
                    total_components: (d.metrics.total_components || 0) * 10
                }
            }));

            const allValues = normalizedData.flatMap(d => 
                metrics.map(m => d.metrics[m.key])
            );

            const y = d3.scaleLinear()
                .domain([0, d3.max(allValues) * 1.1])
                .range([height, 0]);

            // Add axes
            svg.append('g')
                .attr('class', 'axis')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x).ticks(6));

            svg.append('g')
                .attr('class', 'axis')
                .call(d3.axisLeft(y));

            // Line generator
            const line = d3.line()
                .x(d => x(d.date))
                .y(d => y(d.value))
                .curve(d3.curveMonotoneX);

            // Tooltip
            const tooltip = d3.select('#tooltip');

            // Draw lines for each metric
            metrics.forEach(metric => {
                const lineData = normalizedData.map(d => ({
                    date: d.date,
                    value: d.metrics[metric.key]
                }));

                // Draw line
                svg.append('path')
                    .datum(lineData)
                    .attr('class', 'line')
                    .attr('d', line)
                    .attr('stroke', metric.color);

                // Add dots
                svg.selectAll(`.dot-${metric.key}`)
                    .data(normalizedData)
                    .enter()
                    .append('circle')
                    .attr('class', 'dot')
                    .attr('cx', d => x(d.date))
                    .attr('cy', d => y(d.metrics[metric.key]))
                    .attr('r', 4)
                    .attr('fill', metric.color)
                    .on('mouseover', function(event, d) {
                        tooltip
                            .style('opacity', 1)
                            .style('left', (event.pageX + 10) + 'px')
                            .style('top', (event.pageY - 10) + 'px')
                            .html(`
                                <h4>${metric.label}</h4>
                                <p><strong>Date:</strong> ${d.date.toLocaleDateString()}</p>
                                <p><strong>Value:</strong> ${Math.round(d.metrics[metric.key])}</p>
                                <p><strong>Commit:</strong> ${d.commit.substring(0, 7)}</p>
                            `);
                    })
                    .on('mouseout', function() {
                        tooltip.style('opacity', 0);
                    });
            });

            // Render legend
            const legend = document.getElementById('timeline-legend');
            legend.innerHTML = '';
            metrics.forEach(metric => {
                const item = document.createElement('div');
                item.className = 'legend-item';
                item.innerHTML = `
                    <div class="legend-color" style="background: ${metric.color}"></div>
                    <span>${metric.label}</span>
                `;
                legend.appendChild(item);
            });
        }

        // Render components chart
        function renderComponents() {
            const components = latestData.components;
            if (!components) return;

            const container = document.getElementById('component-chart');
            const margin = { top: 20, right: 20, bottom: 100, left: 60 };
            const width = container.clientWidth - margin.left - margin.right;
            const height = 500 - margin.top - margin.bottom;

            // Clear previous chart
            d3.select(container).selectAll('*').remove();

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            // Prepare data
            const data = Object.entries(components).map(([name, data]) => ({
                name: name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                files: data.file_count || 0,
                lines: data.line_count || 0
            }));

            // Scales
            const x = d3.scaleBand()
                .domain(data.map(d => d.name))
                .range([0, width])
                .padding(0.2);

            const y = d3.scaleLinear()
                .domain([0, d3.max(data, d => d.lines) * 1.1])
                .range([height, 0]);

            // Add axes
            svg.append('g')
                .attr('class', 'axis')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .selectAll('text')
                .attr('transform', 'rotate(-45)')
                .style('text-anchor', 'end');

            svg.append('g')
                .attr('class', 'axis')
                .call(d3.axisLeft(y));

            // Add bars
            const tooltip = d3.select('#tooltip');

            svg.selectAll('.bar')
                .data(data)
                .enter()
                .append('rect')
                .attr('class', 'bar')
                .attr('x', d => x(d.name))
                .attr('y', d => y(d.lines))
                .attr('width', x.bandwidth())
                .attr('height', d => height - y(d.lines))
                .attr('fill', '#00d4ff')
                .attr('opacity', 0.8)
                .on('mouseover', function(event, d) {
                    d3.select(this).attr('opacity', 1);
                    tooltip
                        .style('opacity', 1)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 10) + 'px')
                        .html(`
                            <h4>${d.name}</h4>
                            <p><strong>Files:</strong> ${d.files}</p>
                            <p><strong>Lines:</strong> ${d.lines.toLocaleString()}</p>
                        `);
                })
                .on('mouseout', function() {
                    d3.select(this).attr('opacity', 0.8);
                    tooltip.style('opacity', 0);
                });
        }

        // Render architecture diagram
        function renderDiagram() {
            const components = latestData.components;
            if (!components) return;

            // Generate Mermaid diagram
            let diagram = ['graph TD'];
            
            // Add nodes
            Object.entries(components).forEach(([name, data]) => {
                const displayName = name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                const fileCount = data.file_count || 0;
                diagram.push(`    ${name}["${displayName}<br/>${fileCount} files"]`);
            });

            // Add some logical relationships
            const relationships = [
                ['learning_system', 'agent_system', 'feeds'],
                ['agent_system', 'workflows', 'triggers'],
                ['analysis_tools', 'documentation', 'generates'],
                ['workflows', 'testing', 'validates'],
                ['testing', 'workflows', 'validates']
            ];

            relationships.forEach(([source, target, label]) => {
                if (components[source] && components[target]) {
                    diagram.push(`    ${source} -->|${label}| ${target}`);
                }
            });

            // Render
            const diagramElement = document.getElementById('architecture-diagram');
            diagramElement.textContent = diagram.join('\n');
            diagramElement.removeAttribute('data-processed');
            mermaid.init(undefined, diagramElement);
        }

        // Load data when page and scripts are ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                // Give scripts a moment to fully initialize
                setTimeout(loadData, 100);
            });
        } else {
            // DOM already loaded
            setTimeout(loadData, 100);
        }
    </script>
</body>
</html>
